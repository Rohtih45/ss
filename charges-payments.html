<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <meta name="description" content="" />
    <meta name="author" content="" />
    <title>Dashboard - Studio Sync</title>
    <!-- Favicon -->
    <link rel="icon" href="assets/ssdancer.svg" type="image/svg+xml">

    <!-- Core theme CSS (includes Bootstrap)-->
    <link href="css/styles.css" rel="stylesheet" />
    <!-- Font Awesome CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-...+..." crossorigin="anonymous" referrerpolicy="no-referrer" />
    <!-- Custom CSS for Modern Styling -->
    <link href="css/charges-payment.css" rel="stylesheet" />
    <style>
    </style>
    <!-- Stripe JS -->
    <script src="https://js.stripe.com/v3/"></script>
    <!-- Payarc JS -->
    <script>
        function loadPayarcScript(src) {
            var script = document.createElement('script');
            script.src = src;
            script.onerror = function() {
                if (src === 'https://js.payarc.com/v1/payarc.js') {
                    console.warn('CDN failed, falling back to local copy');
                    loadPayarcScript('/path/to/local/payarc.js');
                } else {
                    console.error('Failed to load Payarc library');
                }
            };
            document.head.appendChild(script);
        }
        loadPayarcScript('https://js.payarc.com/v1/payarc.js');
    </script>
</head>
<body>
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <div class="loading-text">
                <h2>Loading</h2>
                <p id="loadingStatus">Loading studio branding...</p>
            </div>
        </div>
    </div>

    <div class="d-flex" id="wrapper">
          <!-- Sidebar-->
          <div class="border-end" id="sidebar-wrapper">
            <div class="sidebar-heading">
                <img src="assets/StudioSyncTransparent.svg" alt="Studio Sync Logo" style="width: 150px; height: auto;">
            </div>
            <div class="list-group list-group-flush">
                <a class="list-group-item list-group-item-action p-3" href="dashboard.html">
                    <i class="fas fa-tachometer-alt me-2"></i>Dashboard
                </a>
                <a class="list-group-item list-group-item-action p-3" href="class-calendar.html">
                    <i class="fas fa-calendar-alt me-2"></i>Class Calendar
                </a>
                <a class="list-group-item list-group-item-action p-3" href="allclasses.html">
                    <i class="fas fa-chalkboard-teacher me-2"></i>Classes
                </a>
                <a class="list-group-item list-group-item-action p-3" href="families.html">
                    <i class="fas fa-home me-2"></i>Families
                </a>
                <a class="list-group-item list-group-item-action p-3" href="students.html">
                    <i class="fas fa-user-graduate me-2"></i>Students
                </a>
                <a class="list-group-item list-group-item-action p-3" href="instructors.html">
                    <i class="fas fa-chalkboard-teacher me-2"></i>Instructors
                </a>
                <a class="list-group-item list-group-item-action p-3" href="costumes.html">
                    <i class="fas fa-tshirt me-2"></i>Costumes
                </a>
                <a class="list-group-item list-group-item-action p-3" href="recital.html">
                    <i class="fas fa-theater-masks me-2"></i>Recital
                </a>
                <a class="list-group-item list-group-item-action p-3" href="communication.html">
                    <i class="fas fa-comments me-2"></i>Communication
                </a>
                <a class="list-group-item list-group-item-action p-3" href="studiostore.html">
                    <i class="fas fa-store me-2"></i>Studio Store
                </a>
                <a class="list-group-item list-group-item-action p-3" href="charges-payments.html">
                    <i class="fas fa-dollar-sign me-2"></i>Charges/Payments
                </a>
                <a class="list-group-item list-group-item-action p-3" href="reports.html">
                    <i class="fas fa-chart-bar me-2"></i>Reports
                </a>
                <a class="list-group-item list-group-item-action p-3" href="settings.html">
                    <i class="fas fa-cog me-2"></i>Settings
                </a>
            </div>
            
            <!-- Bottom Margin -->
            <div style="margin-bottom: 4rem;"></div>
        </div>

        <!-- Page content wrapper-->
        <div id="page-content-wrapper">
            <!-- Top navigation-->
            <nav class="navbar navbar-expand-lg navbar-light border-bottom">
                <div class="container-fluid">
                    <button class="btn btn-primary" id="sidebarToggle" style="width: 100px;" data-bs-toggle="tooltip" data-bs-placement="right" title="Toggle Menu" data-bs-trigger="hover focus">
                        <i class="fas fa-bars"></i>
                    </button>

                    <!-- Centered Logo -->
                    <div class="navbar-brand-center">
                        <img id="studio-logo" src="" alt="Studio Logo" style="max-height: 120px; max-width: 240px; display: none;">
                        <span id="studio-name" style="font-size: 1.5rem; font-weight: bold; color: #3DCED7;"></span>
                    </div>

                    <!-- Notifications and Profile Icons -->
                    <div class="navbar-nav ms-auto d-flex align-items-center">
                        <!-- Profile Icon Dropdown -->
                        <div class="nav-item dropdown">
                            <a class="nav-link" href="#" id="profileDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                <div class="user-avatar">
                                    <span class="initials"></span>
                                </div>
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="profileDropdown">
                                <li><h6 class="dropdown-header" id="userName" style="font-size: 1.2rem; font-weight: 700; color: #333333;">User Name</h6></li>
                                <li><p class="dropdown-item-text" id="userEmail" style="font-size: 0.95rem; font-weight: 400; color: #333333;">user@example.com</p></li>
                                <li><p class="dropdown-item-text" id="studioNameDisplay" style="font-size: 1.1rem; font-weight: 600; color: #333333;">Studio Name</p></li>
                                <li><p class="dropdown-item-text" id="userRole" style="font-size: 0.85rem; font-weight: 400; color: #333333;">Role</p></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="settings.html"><i class="fas fa-cog me-2"></i>Settings</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="#" id="logoutButton"><i class="fas fa-sign-out-alt me-2"></i>Logout</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </nav>

            <!-- Page content-->
            <div class="container-fluid">
                <h2 class="mb-4">Charges & Payments</h2>
                
                <!-- Tabbed Navigation -->
                <ul class="nav nav-tabs mb-4" id="chargesTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="revenue-tab" data-bs-toggle="tab" data-bs-target="#revenue" type="button" role="tab" aria-controls="revenue" aria-selected="true">Revenue</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="charges-tab" data-bs-toggle="tab" data-bs-target="#charges" type="button" role="tab" aria-controls="charges" aria-selected="false">Charges/Payments</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="tuition-rates-tab" data-bs-toggle="tab" data-bs-target="#tuition-rates" type="button" role="tab" aria-controls="tuition-rates" aria-selected="false">Tuition Rates</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="fees-tab" data-bs-toggle="tab" data-bs-target="#fees" type="button" role="tab" aria-controls="fees" aria-selected="false">Fees</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="discounts-tab" data-bs-toggle="tab" data-bs-target="#discounts" type="button" role="tab" aria-controls="discounts" aria-selected="false">Discounts</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="credit-tab" data-bs-toggle="tab" data-bs-target="#credit" type="button" role="tab" aria-controls="credit" aria-selected="false">Credit</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="student-family-max-tab" data-bs-toggle="tab" data-bs-target="#student-family-max" type="button" role="tab" aria-controls="student-family-max" aria-selected="false">Student/FamilyMax</button>
                    </li>
                </ul>
                
                <!-- Tab Content -->
                <div class="tab-content" id="chargesTabContent">
                    <!-- Revenue Tab -->
                    <div class="tab-pane fade show active" id="revenue" role="tabpanel" aria-labelledby="revenue-tab">
                        <div class="card shadow-sm">
                            <div class="card-header bg-light">
                                <h4 class="mb-0">Revenue Overview</h4>
                            </div>
                            <div class="card-body p-4">
                                <!-- Larger, modern revenue cards in a responsive grid -->
                                <div class="row g-4">
                                    <!-- Revenue This Month Card -->
                                    <div class="col-md-6">
                                        <div class="card h-100 border-0 shadow-sm rounded-3 overflow-hidden">
                                            <div class="card-body p-4">
                                                <div class="d-flex justify-content-between align-items-center mb-3">
                                                    <h5 class="card-title mb-0 text-dark">Revenue This Month</h5>
                                                    <span class="fs-1" style="color: #3DCED7;"><i class="fas fa-chart-line"></i></span>
                                                </div>
                                                <h2 class="display-4 fw-bold mb-2" style="color: #3DCED7;" id="revenueThisMonth">$0.00</h2>
                                                <p class="card-text fs-5 text-success" id="revenueMonthChange">
                                                    <i class="fas fa-arrow-up me-1"></i>0% from last month
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Revenue last 30 days Card -->
                                    <div class="col-md-6">
                                        <div class="card h-100 border-0 shadow-sm rounded-3 overflow-hidden">
                                            <div class="card-body p-4">
                                                <div class="d-flex justify-content-between align-items-center mb-3">
                                                    <h5 class="card-title mb-0 text-dark">Last 30 Days</h5>
                                                    <span class="fs-1" style="color: #3DCED7;"><i class="fas fa-calendar-alt"></i></span>
                                                </div>
                                                <h2 class="display-4 fw-bold mb-2" style="color: #3DCED7;" id="revenueLast30Days">$0.00</h2>
                                                <p class="card-text fs-5 text-success" id="revenue30DayChange">
                                                    <i class="fas fa-arrow-up me-1"></i>0% from previous period
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Outstanding balances -->
                                    <div class="col-md-6">
                                        <div class="card h-100 border-0 shadow-sm rounded-3 overflow-hidden">
                                            <div class="card-body p-4">
                                                <div class="d-flex justify-content-between align-items-center mb-3">
                                                    <h5 class="card-title mb-0 text-dark">Outstanding Balances</h5>
                                                    <span class="fs-1 text-danger"><i class="fas fa-exclamation-circle"></i></span>
                                                </div>
                                                <h2 class="display-4 fw-bold text-danger mb-2" id="outstandingBalances">$0.00</h2>
                                                <p class="card-text fs-5 text-dark" id="outstandingBalanceCount">0 unpaid invoices</p>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Accounts with outstanding balance -->
                                    <div class="col-md-6">
                                        <div class="card h-100 border-0 shadow-sm rounded-3 overflow-hidden">
                                            <div class="card-body p-4">
                                                <div class="d-flex justify-content-between align-items-center mb-3">
                                                    <h5 class="card-title mb-0 text-dark">Accounts with Outstanding Balances</h5>
                                                    <span class="fs-1 text-danger"><i class="fas fa-user-clock"></i></span>
                                                </div>
                                                <h2 class="display-4 fw-bold text-danger mb-2" id="accountsWithBalance">0</h2>
                                                <p class="card-text fs-5 text-dark" id="accountsWithBalancePercent">0% of total accounts</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Charges Tab -->
                    <div class="tab-pane fade" id="charges" role="tabpanel" aria-labelledby="charges-tab">
                        <div class="card shadow-sm">
                            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                                <h4 class="mb-0">Charges & Payments History</h4>
                                <div>
                                    <button id="postChargesButton" class="btn btn-primary me-2">
                                        <i class="fas fa-file-invoice-dollar me-1"></i> Post Charges
                                    </button>
                                    <button id="processPaymentsButton" class="btn btn-success">
                                        <i class="fas fa-credit-card me-1"></i> Process Payments
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <!-- Add a search bar above the charges table -->
                                <div class="mb-3">
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                                        <input type="text" class="form-control" id="chargeSearchInput" placeholder="Search charges and payments..." aria-label="Search charges and payments">
                                        <button class="btn btn-outline-secondary" type="button" id="clearChargeSearch">Clear</button>
                                    </div>
                                    <small id="chargeSearchResultCount" class="form-text text-muted mt-1"></small>
                                </div>
                                <div class="table-responsive">
                                    <table class="table table-hover" id="chargesTable">
                                        <thead>
                                            <tr>
                                                <th>Family</th>
                                                <th>Description</th>
                                                <th>Amount</th>
                                                <th>Date</th>
                                                <th>Status</th>
                                                <th>Type</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <!-- Charges and Payments will be loaded here -->
                                            <tr class="text-center text-muted">
                                                <td colspan="6">Loading charges and payments...</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tuition Rates Tab -->
                    <div class="tab-pane fade" id="tuition-rates" role="tabpanel" aria-labelledby="tuition-rates-tab">
                        <div class="card shadow-sm">
                            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                                <h4 class="mb-0">Tuition Rate Plans</h4>
                                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createTuitionRateModal">
                                    <i class="fas fa-plus me-2"></i>Create Rate Plan
                                </button>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover" id="tuitionRatesTable">
                                        <thead>
                                            <tr>
                                                <th>Rate Name</th>
                                                <th>Hours/Rates</th>
                                                <th>Family Discount</th>
                                                <th>Active</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <!-- Tuition rates will be loaded dynamically -->
                                            <tr class="text-center text-muted">
                                                <td colspan="5">No tuition rates found. Create your first rate plan to get started.</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Fees Tab -->
                    <div class="tab-pane fade" id="fees" role="tabpanel" aria-labelledby="fees-tab">
                        <div class="card shadow-sm">
                            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                                <h4 class="mb-0">Fee Management</h4>
                                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newFeeModal">
                                    <i class="fas fa-plus me-2"></i>Create New Fee
                                </button>
                            </div>
                            <div class="card-body">
                                <!-- Add a search bar above the fees table -->
                                <div class="mb-3">
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                                        <input type="text" class="form-control" id="feeSearchInput" placeholder="Search fees..." aria-label="Search fees">
                                        <button class="btn btn-outline-secondary" type="button" id="clearFeeSearch">Clear</button>
                                    </div>
                                    <small id="searchResultCount" class="form-text text-muted mt-1"></small>
                                </div>
                                <div class="table-responsive">
                                    <table class="table table-hover" id="feesTable">
                                        <thead>
                                            <tr>
                                                <th>Fee Name</th>
                                                <th>Amount</th>
                                                <th>Type</th>
                                                <th>Associated With</th>
                                                <th>Active</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <!-- Fees will be loaded here -->
                                            <tr class="text-center text-muted">
                                                <td colspan="5">No fees found. Create your first fee to get started.</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Update the Discounts Tab content -->
                    <div class="tab-pane fade" id="discounts" role="tabpanel" aria-labelledby="discounts-tab">
                        <div class="card shadow-sm">
                            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                                <h4 class="mb-0">Discount Management</h4>
                                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newDiscountModal">
                                    <i class="fas fa-plus me-2"></i>Create New Discount
                                </button>
                            </div>
                            <div class="card-body">
                                <!-- Add a search bar above the discounts table -->
                                <div class="mb-3">
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                                        <input type="text" class="form-control" id="discountSearchInput" placeholder="Search discounts..." aria-label="Search discounts">
                                        <button class="btn btn-outline-secondary" type="button" id="clearDiscountSearch">Clear</button>
                                    </div>
                                    <small id="discountSearchResultCount" class="form-text text-muted mt-1"></small>
                                </div>
                                <div class="table-responsive">
                                    <table class="table table-hover" id="discountsTable">
                                        <thead>
                                            <tr>
                                                <th>Discount Name</th>
                                                <th>Amount</th>
                                                <th>Type</th>
                                                <th>Associated With</th>
                                                <th>Active</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <!-- Discounts will be loaded here -->
                                            <tr class="text-center text-muted">
                                                <td colspan="7">No discounts found. Create your first discount to get started.</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Update the Credit Tab content -->
                    <div class="tab-pane fade" id="credit" role="tabpanel" aria-labelledby="credit-tab">
                        <div class="card shadow-sm">
                            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                                <h4 class="mb-0">Credit Management</h4>
                                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newCreditModal">
                                    <i class="fas fa-plus me-2"></i>Create New Credit
                                </button>
                            </div>
                            <div class="card-body">
                                <!-- Add a search bar above the credits table -->
                                <div class="mb-3">
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                                        <input type="text" class="form-control" id="creditSearchInput" placeholder="Search credits..." aria-label="Search credits">
                                        <button class="btn btn-outline-secondary" type="button" id="clearCreditSearch">Clear</button>
                                    </div>
                                    <small id="creditSearchResultCount" class="form-text text-muted mt-1"></small>
                                </div>
                                <div class="table-responsive">
                                    <table class="table table-hover" id="creditsTable">
                                        <thead>
                                            <tr>
                                                <th>Credit Name</th>
                                                <th>Amount</th>
                                                <th>Family</th>
                                                <th>Notes</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <!-- Credits will be loaded here -->
                                            <tr class="text-center text-muted">
                                                <td colspan="5">No credits found. Create your first credit to get started.</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Student/FamilyMax Tab -->
                    <div class="tab-pane fade" id="student-family-max" role="tabpanel" aria-labelledby="student-family-max-tab">
                        <div class="card shadow-sm">
                            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                                <h4 class="mb-0">Student/Family Maximum Tuition</h4>
                            </div>
                            <div class="card-body">
                                <form id="studentFamilyMaxForm">
                                    <div class="row mb-3">
                                        <div class="col-12">
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" id="enableStudentFamilyMax">
                                                <label class="form-check-label" for="enableStudentFamilyMax">
                                                    Enable Student & Family Maximum Tuition Limits
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div id="maxSettingsContainer" style="display: none;">
                                        <div class="alert alert-info">
                                            <i class="fas fa-info-circle"></i> Setting these limits will cap the total tuition amount charged to students and families. Each student will be charged up to the Student Max amount, and each family will be charged up to the Family Max amount.
                                        </div>
                                        
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label for="studentMaxAmount" class="form-label">Student Maximum Amount ($)</label>
                                                <div class="input-group">
                                                    <span class="input-group-text">$</span>
                                                    <input type="number" class="form-control" id="studentMaxAmount" placeholder="0.00" min="0" step="0.01">
                                                </div>
                                                <div class="form-text">Maximum tuition amount per student</div>
                                            </div>
                                            
                                            <div class="col-md-6">
                                                <label for="familyMaxAmount" class="form-label">Family Maximum Amount ($)</label>
                                                <div class="input-group">
                                                    <span class="input-group-text">$</span>
                                                    <input type="number" class="form-control" id="familyMaxAmount" placeholder="0.00" min="0" step="0.01">
                                                </div>
                                                <div class="form-text">Maximum tuition amount per family</div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="mt-4">
                                        <button type="button" id="saveStudentFamilyMaxBtn" class="btn btn-primary">Save</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap core JS-->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Core theme JS-->
    <script src="js/scripts.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const wrapper = document.getElementById('wrapper');
            const sidebarToggle = document.getElementById('sidebarToggle');
            const overlay = document.querySelector('.sidebar-overlay');

            function toggleSidebar(e) {
                if (e) {
                    e.preventDefault();
                    e.stopPropagation();
                }
                
                wrapper.classList.toggle('toggled');
                
                if (window.innerWidth <= 768) {
                    if (wrapper.classList.contains('toggled')) {
                        overlay.classList.add('show');
                    } else {
                        overlay.classList.remove('show');
                    }
                }
            }

            // Toggle button click handler
            sidebarToggle.addEventListener('click', toggleSidebar);

            // Overlay click handler
            overlay.addEventListener('click', toggleSidebar);

            // Handle window resize
            window.addEventListener('resize', function() {
                if (window.innerWidth > 768) {
                    overlay.classList.remove('show');
                }
            });

            // Add event listener to the "Create New Fee" button to reset the form
            const createFeeButtons = document.querySelectorAll('[data-bs-target="#newFeeModal"]:not(.edit-fee-btn)');
            
            createFeeButtons.forEach(button => {
                button.addEventListener('click', function(e) {
                    console.log('Create New Fee button clicked - resetting form');
                    resetFeeForm();
                });
            });
            
            // Also reset the form when the modal is hidden
            const feeModal = document.getElementById('newFeeModal');
            if (feeModal) {
                feeModal.addEventListener('hidden.bs.modal', function() {
                    console.log('Fee modal hidden - resetting form for next use');
                    resetFeeForm();
                });
            }

            // Handle end date checkbox
            const hasEndDateCheckbox = document.getElementById('hasEndDate');
            if (hasEndDateCheckbox) {
                hasEndDateCheckbox.addEventListener('change', function() {
                    const endDateSection = document.getElementById('endDateSection');
                    if (this.checked) {
                        endDateSection.style.display = 'block';
                    } else {
                        endDateSection.style.display = 'none';
                        document.getElementById('feeEndDate').value = ''; // Clear the date when unchecked
                    }
                });
            }

            // Add event listener for the save fee button
            const saveFeeButton = document.getElementById('saveFeeBtn');
            if (saveFeeButton) {
                saveFeeButton.addEventListener('click', function() {
                    console.log('Save Fee button clicked');
                    saveFee();
                });
            }
        });

        function resetFeeForm() {
            console.log('Resetting fee form to clean state');
            
            // Get the form element
            const feeForm = document.getElementById('newFeeForm');
            if (!feeForm) {
                console.log('Form not found');
                return;
            }
            
            // Reset the actual form inputs
            feeForm.reset();
            
            // Reset data attributes
            feeForm.dataset.mode = 'create';
            feeForm.dataset.feeId = '';
            
            // Safely update modal elements
            const modalLabel = document.getElementById('newFeeModalLabel');
            const saveBtn = document.getElementById('saveFeeBtn');
            if (modalLabel) modalLabel.textContent = 'Create New Fee';
            if (saveBtn) saveBtn.textContent = 'Save Fee';
            
            // Safely hide all conditional sections
            ['associationItemContainer', 'recurringOptions', 'installmentsOptions', 'endDateSection'].forEach(id => {
                const element = document.getElementById(id);
                if (element) element.style.display = 'none';
            });
            
            // Safely reset end date fields
            const hasEndDateCheckbox = document.getElementById('hasEndDate');
            const feeEndDateInput = document.getElementById('feeEndDate');
            if (hasEndDateCheckbox) hasEndDateCheckbox.checked = false;
            if (feeEndDateInput) feeEndDateInput.value = '';
            
            // Safely reset association search
            const searchInput = document.getElementById('associationSearchInput');
            const noItemsFound = document.getElementById('noAssociationItemsFound');
            if (searchInput) searchInput.value = '';
            if (noItemsFound) noItemsFound.style.display = 'none';
            
            // Enable all form fields
            const formFields = feeForm.querySelectorAll('input, select');
            formFields.forEach(field => {
                field.disabled = false;
            });
        }

        function saveFee() {
            console.log('Save Fee function called');
            
            // Get form values safely
            const feeNameElement = document.getElementById('feeName');
            const feeAmountElement = document.getElementById('feeAmount');
            const feeTypeElement = document.getElementById('feeType');
            
            if (!feeNameElement || !feeAmountElement || !feeTypeElement) {
                console.error('Required form elements not found:', {
                    feeName: !!feeNameElement,
                    feeAmount: !!feeAmountElement,
                    feeType: !!feeTypeElement
                });
                alert('Error: Form elements not found');
                return;
            }
            
            const feeName = feeNameElement.value.trim();
            const feeAmount = parseFloat(feeAmountElement.value);
            const feeType = feeTypeElement.value;
            
            // Get the correct association type and ID based on fee type
            let associationType = '', associationItemId = '';
            
            // Convert feeType to the correct prefix for IDs
            const typePrefix = feeType.toLowerCase().replace(/\s+/g, '');
            console.log('Type prefix:', typePrefix);
            
            // Get the association type and ID elements
            const typeElement = document.getElementById(`${typePrefix}AssociationType`);
            const idElement = document.getElementById(`${typePrefix}Association`);
            
            console.log('Association elements found:', {
                typeElement: !!typeElement,
                idElement: !!idElement,
                typePrefix: typePrefix,
                typeElementId: `${typePrefix}AssociationType`,
                idElementId: `${typePrefix}Association`
            });
            
            if (typeElement && idElement) {
                associationType = typeElement.value;
                associationItemId = idElement.value;
            } else {
                console.error('Association elements not found');
                alert('Error: Association elements not found');
                return;
            }
            
            console.log('Form values:', { feeName, feeAmount, feeType, associationType, associationItemId });
            
            // Basic validation
            if (!feeName || isNaN(feeAmount) || !feeType || !associationType || !associationItemId) {
                console.log('Validation failed:', { feeName, feeAmount, feeType, associationType, associationItemId });
                alert('Please fill out all required fields');
                return;
            }
            
            // Get the studio ID
            const studioId = currentStudioId;
            
            if (!studioId) {
                console.log('No studio ID found');
                alert('Error: Studio ID not found');
                return;
            }
            
            // Create the base fee object
            const feeData = {
                Name: feeName,
                Amount: feeAmount,
                FeeType: feeType,
                AssociationType: associationType,
                AssociationItemId: associationItemId,
                UpdatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            console.log('Fee data to save:', feeData);
            
            // Reference to the Fees subcollection
            const feesCollectionRef = firebase.firestore().collection('Studios').doc(studioId).collection('Fees');
            
            // Save to Firestore
            feesCollectionRef.add(feeData)
                .then(docRef => {
                    console.log('Fee saved successfully with ID:', docRef.id);
                    
                    // Close the modal and reset form safely
                    const modal = bootstrap.Modal.getInstance(document.getElementById('newFeeModal'));
                    if (modal) {
                        modal.hide();
                        // Wait for modal to finish hiding before resetting form
                        setTimeout(() => {
                            const form = document.getElementById('newFeeForm');
                            if (form) form.reset();
                            
                            // Safely hide containers
                            ['associationItemContainer', 'recurringOptions', 'installmentsOptions'].forEach(id => {
                                const container = document.getElementById(id);
                                if (container) container.style.display = 'none';
                            });
                            
                            // Reload fees data
                            loadFeesData(studioId);
                        }, 300);
                    }
                    
                    // Show success message
                    alert('Fee created successfully!');
                })
                .catch(error => {
                    console.error('Error saving fee:', error);
                    alert('Error creating fee. Please try again.');
                });
        }
    </script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Enrollment chart
        const ctx = document.getElementById('enrollmentChart').getContext('2d');
        let enrollmentChart;

        function getColor(percentage) {
            // Ensure the percentage is between 0 and 100
            percentage = Math.max(0, Math.min(100, percentage));
            
            if (percentage <= 50) {
                // Vibrant Red (220,55,55) to Muted Yellow (220,200,110)
                const g = Math.round(55 + (145 * (percentage / 50)));
                const b = Math.round(55 + (55 * (percentage / 50)));
                return `rgb(220, ${g}, ${b})`;
            } else {
                // Muted Yellow (220,200,110) to Muted Green (110,200,110)
                const r = Math.round(220 - (110 * ((percentage - 50) / 50)));
                return `rgb(${r}, 200, 110)`;
            }
        }

        function updateChart(enrolled, capacity) {
            if (enrollmentChart) {
                enrollmentChart.destroy();
            }

            // Ensure we have valid numbers, defaulting to 0 if not
            enrolled = enrolled || 0;
            capacity = capacity || 0;
            
            // Calculate percentage, defaulting to 0 if capacity is 0
            const percentageFilled = capacity > 0 ? Math.round((enrolled / capacity) * 100) : 0;
            const filledColor = getColor(percentageFilled);

            enrollmentChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Enrolled', 'Available'],
                    datasets: [{
                        data: capacity > 0 ? [enrolled, Math.max(0, capacity - enrolled)] : [0, 1],
                        backgroundColor: [filledColor, '#E0E0E0']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    cutout: '75%',
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            position: 'nearest',
                            yAlign: 'bottom',
                            callbacks: {
                                label: function(context) {
                                    if (capacity === 0) return 'No capacity set';
                                    const label = context.label;
                                    const value = context.raw;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = Math.round((value / total) * 100);
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            },
                            external: function(context) {
                                // Offset the tooltip above the cursor
                                const tooltipModel = context.tooltip;
                                if (tooltipModel.opacity === 0) {
                                    return;
                                }
                                
                                // Move the tooltip 20 pixels up from the cursor
                                tooltipModel.y = tooltipModel.y - 20;
                            }
                        }
                    }
                },
                plugins: [{
                    id: 'centerText',
                    afterDraw: (chart) => {
                        const width = chart.width;
                        const height = chart.height;
                        const ctx = chart.ctx;

                        ctx.restore();
                        
                        // Make text size responsive
                        const fontSize = Math.min(width, height) * 0.15;
                        const smallFontSize = fontSize * 0.5;

                        ctx.font = `bold ${fontSize}px Arial`;
                        ctx.textBaseline = 'middle';
                        ctx.textAlign = 'center';
                        ctx.fillStyle = filledColor;

                        // Always show percentage as a valid number (0% if no data)
                        const text = `${percentageFilled}%`;
                        const textX = width / 2;
                        const textY = height / 2;

                        ctx.fillText(text, textX, textY);

                        ctx.font = `${smallFontSize}px Arial`;
                        ctx.fillStyle = '#525f7f';
                        ctx.fillText('Capacity', textX, textY + fontSize * 0.6);

                        ctx.save();
                    }
                }]
            });
        }

        // Update the function that sets KPI values to include timeout
        function updateKPIValue(selector, value) {
            const element = document.querySelector(selector);
            if (element) {
                // Clear any existing timeouts for this element
                if (element.timeoutId) {
                    clearTimeout(element.timeoutId);
                }

                // If we have a value, set it immediately
                if (value !== undefined && value !== null) {
                    element.textContent = value;
                    element.classList.remove('loading-value');
                }
            }
        }

        // Add function to initialize timeouts for all KPIs
        function initializeKPITimeouts() {
            const kpiSelectors = [
                '.insight-box:nth-child(1) p',  // Students Enrolled
                '.insight-box:nth-child(2) p',  // New Students This Week
                '.insight-box:nth-child(3) p',  // Classes with Waitlists
                '.insight-box:nth-child(4) p',  // Instructors Teaching
                '.insight-box:nth-child(5) p',  // Families Enrolled
                '.insight-box:nth-child(6) p'   // Unpaid Shopping Carts
            ];

            kpiSelectors.forEach(selector => {
                const element = document.querySelector(selector);
                if (element) {
                    // Clear any existing timeout
                    if (element.timeoutId) {
                        clearTimeout(element.timeoutId);
                    }
                    
                    // Set new timeout
                    element.timeoutId = setTimeout(() => {
                        if (element.classList.contains('loading-value')) {
                            element.textContent = '0';
                            element.classList.remove('loading-value');
                        }
                    }, 3000);
                }
            });
        }

        // Update the calculateEnrollmentAndCapacity function
        async function calculateEnrollmentAndCapacity(studioId) {
            try {
                const classesSnapshot = await firebase.firestore()
                    .collection('Studios')
                    .doc(studioId)
                    .collection('Classes')
                    .where('IsActive', '==', true)
                    .get();

                let totalCapacity = 0;
                let totalEnrolled = 0;

                classesSnapshot.forEach(doc => {
                    const classData = doc.data();
                    totalCapacity += classData.MaxSize || 0;
                    totalEnrolled += (classData.Students?.length || 0);
                });

                console.log('Studio Enrollment Stats:', {
                    totalCapacity,
                    totalEnrolled,
                    percentageFilled: ((totalEnrolled / totalCapacity) * 100).toFixed(1) + '%'
                });

                // Update the Students Enrolled KPI card
                updateKPIValue('.insight-box:first-child p', totalEnrolled);

                return { totalCapacity, totalEnrolled };
            } catch (error) {
                console.error('Error calculating enrollment and capacity:', error);
                return { totalCapacity: 0, totalEnrolled: 0 };
            }
        }

        // Update the updateFamiliesCount function
        async function updateFamiliesCount(studioId) {
            try {
                // Get all families
                const familiesSnapshot = await firebase.firestore()
                    .collection('Studios')
                    .doc(studioId)
                    .collection('Families')
                    .get();

                let familiesWithEnrolledStudents = 0;

                // For each family
                for (const familyDoc of familiesSnapshot.docs) {
                    const familyData = familyDoc.data();
                    const studentIds = familyData.Students || [];

                    // Skip if family has no students
                    if (studentIds.length === 0) continue;

                    // Check if any of the family's students are enrolled in active classes
                    const classesWithStudent = await firebase.firestore()
                        .collection('Studios')
                        .doc(studioId)
                        .collection('Classes')
                        .where('IsActive', '==', true)
                        .where('Students', 'array-contains-any', studentIds)
                        .get();

                    if (!classesWithStudent.empty) {
                        familiesWithEnrolledStudents++;
                    }
                }

                console.log('Families with enrolled students:', familiesWithEnrolledStudents);

                // Update the Families Enrolled KPI card
                updateKPIValue('.insight-box:nth-child(5) p', familiesWithEnrolledStudents);

                return familiesWithEnrolledStudents;
            } catch (error) {
                console.error('Error calculating families count:', error);
                return 0;
            }
        }

        // Update the updateNewStudentsThisWeek function
        async function updateNewStudentsThisWeek(studioId) {
            try {
                const now = new Date();
                const sevenDaysAgo = new Date(now);
                sevenDaysAgo.setDate(now.getDate() - 7);

                // Query students directly from the Students collection
                const studentsSnapshot = await firebase.firestore()
                    .collection('Studios')
                    .doc(studioId)
                    .collection('Students')
                    .where('CreatedAt', '>=', sevenDaysAgo)
                    .get();

                const newStudentsCount = studentsSnapshot.size;
                console.log('New students this week:', newStudentsCount);

                // Update the New Students This Week KPI card
                updateKPIValue('.insight-box:nth-child(2) p', newStudentsCount);

                return newStudentsCount;
            } catch (error) {
                console.error('Error calculating new students this week:', error);
                return 0;
            }
        }

        // Update the updateInstructorsCount function
        async function updateInstructorsCount(studioId) {
            try {
                const instructorsSnapshot = await firebase.firestore()
                    .collection('Studios')
                    .doc(studioId)
                    .collection('Instructors')
                    .get();

                const instructorsCount = instructorsSnapshot.size;
                console.log('Total instructors:', instructorsCount);

                // Update the Instructors Teaching KPI card
                updateKPIValue('.insight-box:nth-child(4) p', instructorsCount);

                return instructorsCount;
            } catch (error) {
                console.error('Error calculating instructors count:', error);
                return 0;
            }
        }

        // Update the updateTodaySchedule function
        async function updateTodaySchedule(studioId) {
            try {
                const now = new Date();
                const dayNames = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'];
                const today = dayNames[now.getDay()];

                // Get all active classes for today
                const classesSnapshot = await firebase.firestore()
                    .collection('Studios')
                    .doc(studioId)
                    .collection('Classes')
                    .where('IsActive', '==', true)
                    .where('Days', 'array-contains', today)
                    .get();

                const scheduleTableBody = document.querySelector('.schedule-table tbody');
                
                // Clear existing rows
                scheduleTableBody.innerHTML = '';

                if (classesSnapshot.empty) {
                    // If no classes, show "No classes scheduled" message
                    const noClassesRow = document.createElement('tr');
                    noClassesRow.innerHTML = `
                        <td colspan="9" style="text-align: center;">No classes scheduled for today</td>
                    `;
                    scheduleTableBody.appendChild(noClassesRow);
                    return;
                }

                // Get all studio rooms first
                const roomsSnapshot = await firebase.firestore()
                    .collection('Studios')
                    .doc(studioId)
                    .collection('StudioRooms')
                    .where('IsActive', '==', true)
                    .get();

                // Create a map of room IDs to room names
                const roomNames = {};
                roomsSnapshot.forEach(doc => {
                    roomNames[doc.id] = doc.data().Name;
                });

                // Get all class styles and create a map
                const classStylesSnapshot = await firebase.firestore()
                    .collection('Studios')
                    .doc(studioId)
                    .collection('ClassStyles')
                    .get();

                const classStyles = {};
                classStylesSnapshot.forEach(doc => {
                    classStyles[doc.id] = doc.data().StyleName;
                });

                // Sort classes by start time
                const classes = [];
                classesSnapshot.forEach(doc => {
                    classes.push({ id: doc.id, ...doc.data() });
                });
                classes.sort((a, b) => a.StartTime.localeCompare(b.StartTime));

                // Add each class to the table
                for (const classData of classes) {
                    const row = document.createElement('tr');
                    
                    // Add cursor pointer and hover effect
                    row.style.cursor = 'pointer';
                    row.classList.add('class-row');

                    // Format start time from 24hr to 12hr
                    const [hours, minutes] = classData.StartTime.split(':');
                    const startTime = new Date();
                    startTime.setHours(parseInt(hours), parseInt(minutes));
                    const formattedTime = startTime.toLocaleTimeString('en-US', {
                        hour: 'numeric',
                        minute: '2-digit',
                        hour12: true
                    });

                    // Get instructor name
                    let instructorName = 'TBD';
                    if (classData.InstructorId) {
                        const instructorDoc = await firebase.firestore()
                            .collection('Studios')
                            .doc(studioId)
                            .collection('Instructors')
                            .doc(classData.InstructorId)
                            .get();
                        
                        if (instructorDoc.exists) {
                            const instructor = instructorDoc.data();
                            instructorName = `${instructor.FirstName} ${instructor.LastName}`;
                        }
                    }

                    // Get room name from the map, or show 'TBD' if not found
                    const roomName = classData.RoomId ? (roomNames[classData.RoomId] || 'TBD') : 'TBD';

                    // Get class style from the map, or show 'Not Specified' if not found
                    const classStyle = classData.ClassStyleId ? (classStyles[classData.ClassStyleId] || 'Not Specified') : 'Not Specified';

                    row.innerHTML = `
                        <td>${formattedTime}</td>
                        <td>${classData.Duration} min</td>
                        <td>${classData.ClassName}</td>
                        <td>${classData.ClassType}</td>
                        <td>${classStyle}</td>
                        <td>${roomName}</td>
                        <td>${instructorName}</td>
                        <td>${classData.MaxSize}</td>
                        <td>${(classData.Students || []).length}</td>
                    `;

                    // Add click event listener
                    row.addEventListener('click', () => {
                        // Get studio name parameter for the URL
                        const studioName = getStudioNameForUrl(document.getElementById('studioNameDisplay').textContent);
                        
                        // Navigate to allclasses.html with just the studio parameter
                        window.location.href = `allclasses.html?studio=${studioName}`;
                    });

                    scheduleTableBody.appendChild(row);
                }
            } catch (error) {
                console.error('Error updating schedule:', error);
            }
        }

        // Add this CSS for the hover effect
        const style = document.createElement('style');
        style.textContent = `
            .class-row:hover {
                background-color: rgba(61, 206, 215, 0.1) !important;
                transition: background-color 0.3s ease;
            }
        `;
        document.head.appendChild(style);

        // Update the DOMContentLoaded event listener
        document.addEventListener('DOMContentLoaded', async function() {
            const studioId = localStorage.getItem('currentStudioId');
            
            try {
                // Initialize timeouts for all KPIs
                initializeKPITimeouts();

                // First, calculate and display enrollment chart
                const { totalCapacity, totalEnrolled } = await calculateEnrollmentAndCapacity(studioId);
                
                // Initialize chart immediately
                updateChart(totalEnrolled, totalCapacity);
                
                // Add capacity text
                const pieChartContainer = document.querySelector('.pie-chart-container');
                const capacityText = document.createElement('div');
                capacityText.style.cssText = `
                    text-align: right;
                    font-size: 0.9rem;
                    color: #525f7f;
                    margin-top: 0.5rem;
                `;
                capacityText.textContent = `Studio Capacity: ${totalCapacity}`;
                pieChartContainer.appendChild(capacityText);

                // Then load other metrics with a slight delay
                setTimeout(async () => {
                    await Promise.all([
                        updateFamiliesCount(studioId),
                        updateNewStudentsThisWeek(studioId),
                        updateInstructorsCount(studioId),
                        updateTodaySchedule(studioId)
                    ]);
                }, 100);

            } catch (error) {
                console.error('Error loading dashboard data:', error);
            }
        });
    </script>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

    <script>
        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDRSW3u6gJSs98Z2Mkp5DYSC__ibDXXHAE",
            authDomain: "studiosync-af73d.firebaseapp.com",
            projectId: "studiosync-af73d",
            storageBucket: "studiosync-af73d.appspot.com",
            messagingSenderId: "172555302276",
            appId: "1:172555302276:web:55b661f9849441e2de59d1",
            measurementId: "G-EK7EFQGMSG"
        };
        firebase.initializeApp(firebaseConfig);

        // Function to apply studio branding colors
        function applyStudioBranding(studioData) {
            console.log(' Applying studio branding colors:', {
                PrimaryColor: studioData.PrimaryColor,
                SecondaryColor: studioData.SecondaryColor
            });

            const primaryColor = studioData.PrimaryColor || '#3DCED7';
            const secondaryColor = studioData.SecondaryColor || '#3A506B';

            // Update CSS variables for the sidebar and related elements
            document.documentElement.style.setProperty('--primary-color', primaryColor);
            document.documentElement.style.setProperty('--primary-hover', adjustColor(primaryColor, -10));
            document.documentElement.style.setProperty('--secondary-color', secondaryColor);

            // Update loading overlay elements with branded colors
            const loadingTitle = document.querySelector('.loading-text h2');
            const loadingText = document.querySelector('.loading-text p');
            const spinner = document.querySelector('.spinner');

            if (loadingTitle) loadingTitle.style.color = primaryColor;
            if (loadingText) loadingText.style.color = secondaryColor;
            if (spinner) spinner.style.borderTopColor = primaryColor;

            // Add RGB values for hover effects
            document.documentElement.style.setProperty('--primary-color-rgb', hexToRgb(primaryColor));
        }

        // Helper function to adjust color brightness
        function adjustColor(color, percent) {
            const num = parseInt(color.replace('#', ''), 16);
            const amt = Math.round(2.55 * percent);
            const R = (num >> 16) + amt;
            const G = (num >> 8 & 0x00FF) + amt;
            const B = (num & 0x0000FF) + amt;
            return '#' + (
                0x1000000 +
                (R < 255 ? (R < 1 ? 0 : R) : 255) * 0x10000 +
                (G < 255 ? (G < 1 ? 0 : G) : 255) * 0x100 +
                (B < 255 ? (B < 1 ? 0 : B) : 255)
            ).toString(16).slice(1);
        }

        // Function to get current user data
        async function getCurrentUserData() {
            const loadingStatus = document.getElementById('loadingStatus');
            const loadingOverlay = document.getElementById('loadingOverlay');

            try {
                const user = await new Promise((resolve) => {
                    firebase.auth().onAuthStateChanged((user) => {
                        if (user) {
                            loadingStatus.textContent = "Authenticating user...";
                            resolve(user);
                        } else {
                            console.log('No user signed in');
                            window.location.href = '/studiologin.html';
                        }
                    });
                });

                const studioId = localStorage.getItem('currentStudioId');
                const studioData = JSON.parse(localStorage.getItem('currentStudioData'));
                const userDocId = localStorage.getItem('userDocId');

                loadingStatus.textContent = "Loading studio branding...";
                
                if (studioData) {
                    applyStudioBranding(studioData);
                }

                loadingStatus.textContent = "Fetching user data...";

                try {
                    const userDoc = await firebase.firestore()
                        .collection('Studios')
                        .doc(studioId)
                        .collection('Users')
                        .doc(userDocId)
                        .get();

                    const instructorDoc = !userDoc.exists ? await firebase.firestore()
                        .collection('Studios')
                        .doc(studioId)
                        .collection('Instructors')
                        .doc(user.uid)
                        .get() : null;

                    let userData;
                    let collectionType;

                    if (userDoc.exists) {
                        userData = userDoc.data();
                        collectionType = 'Users';
                    } else if (instructorDoc?.exists) {
                        userData = instructorDoc.data();
                        collectionType = 'Instructors';
                    }

                    if (userData) {
                        loadingStatus.textContent = "Loading...";
                        
                        const fullName = `${userData.FirstName} ${userData.LastName}`;
                        document.getElementById('userName').textContent = fullName;
                        document.getElementById('userEmail').textContent = userData.Email;
                        
                        // Set studio name in profile dropdown
                        const studioNameElement = document.getElementById('studioNameDisplay');
                        if (studioNameElement && studioData) {
                            studioNameElement.textContent = studioData.StudioName || 'Studio Name';
                        }
                        
                        // Set user initials in avatar
                        const initials = `${userData.FirstName[0]}${userData.LastName[0]}`;
                        const initialsElement = document.querySelector('.initials');
                        if (initialsElement) {
                            initialsElement.textContent = initials;
                        }

                        const roleElement = document.getElementById('userRole');
                        if (userData.Role) {
                            roleElement.textContent = userData.Role;
                            roleElement.style.color = '#333333';
                            roleElement.style.fontWeight = '700';
                        } else {
                            roleElement.textContent = 'No Role Assigned';
                            roleElement.style.color = '#666';
                        }

                        if (studioData?.LogoUrl) {
                            await loadStudioLogo(studioData.LogoUrl, studioData.StudioName);
                        } else {
                            await loadStudioLogo(null, studioData?.StudioName);
                        }

                        // Hide loading overlay with fade effect
                        loadingOverlay.classList.add('fade-out');
                        setTimeout(() => {
                            loadingOverlay.style.display = 'none';
                        }, 500);
                    }
                } catch (error) {
                    console.error('Error getting user document:', error);
                    loadingStatus.textContent = "Error loading dashboard. Please refresh...";
                }
                
                if (studioData) {
                    applyStudioBranding(studioData);
                    updateSidebarLinks(studioData);
                    updatePageUrl(studioData.StudioName);
                }
            } catch (error) {
                console.error('Error:', error);
                loadingStatus.textContent = "Error loading dashboard. Please refresh...";
            }
        }

        // Function to load and display the studio logo
        function loadStudioLogo(logoUrl, studioName) {
            return new Promise((resolve) => {
                const logoElement = document.getElementById('studio-logo');
                const nameElement = document.getElementById('studio-name');
                
                if (logoUrl) {
                    logoElement.onload = () => resolve();
                    logoElement.src = logoUrl;
                    logoElement.alt = studioName || 'Studio Logo';
                    logoElement.style.display = 'block';
                    nameElement.style.display = 'none';
                } else {
                    logoElement.style.display = 'none';
                    nameElement.textContent = studioName || 'Studio Sync';
                    nameElement.style.display = 'block';
                    resolve();
                }
            });
        }

        // Call the function when the page loads
        getCurrentUserData();

        // Logout functionality
        document.getElementById('logoutButton').addEventListener('click', function() {
            firebase.auth().signOut().then(() => {
                // Clear studio context from localStorage
                localStorage.removeItem('currentStudioId');
                localStorage.removeItem('currentStudioData');
                // Redirect to studio login
                window.location.href = '/studiologin.html';
            }).catch((error) => {
                console.error('Logout Error:', error);
            });
        });

        // Add this function after the firebase initialization
        function getStudioNameForUrl(studioName) {
            // Remove spaces and special characters, keep alphanumeric only
            return studioName.replace(/[^a-zA-Z0-9]/g, '');
        }

        function updateSidebarLinks(studioData) {
            if (studioData?.StudioName) {
                const studioNameParam = getStudioNameForUrl(studioData.StudioName);
                
                const sidebarLinks = document.querySelectorAll('#sidebar-wrapper .list-group-item');
                sidebarLinks.forEach(link => {
                    const currentHref = link.getAttribute('href');
                    if (currentHref && currentHref.endsWith('.html')) {
                        const newHref = currentHref.replace('.html', `?studio=${studioNameParam}`);
                        link.setAttribute('href', newHref);
                    }
                });
            }
        }

        function updatePageUrl(studioName) {
            if (studioName) {
                const studioNameParam = getStudioNameForUrl(studioName);
                const currentUrl = new URL(window.location.href);
                
                // Only update if we're on a .html page and don't already have the studio parameter
                if (currentUrl.pathname.endsWith('.html') && !currentUrl.searchParams.has('studio')) {
                    const newUrl = `${currentUrl.pathname.replace('.html', '')}?studio=${studioNameParam}`;
                    window.history.replaceState({}, '', newUrl);
                }
            }
        }

        // Add this after the applyStudioBranding function
        function hexToRgb(hex) {
            // Remove the # if present
            hex = hex.replace('#', '');
            
            // Parse the hex values
            const r = parseInt(hex.substring(0, 2), 16);
            const g = parseInt(hex.substring(2, 4), 16);
            const b = parseInt(hex.substring(4, 6), 16);
            
            return `${r}, ${g}, ${b}`;
        }
    </script>
    
    <!-- Charges & Payments specific JavaScript -->
    <script>
        // Global variable to store the studio ID
        let currentStudioId;
        
        document.addEventListener('DOMContentLoaded', function() {
            // Get the studio ID as soon as possible
            currentStudioId = localStorage.getItem('currentStudioId');
            console.log('Studio ID loaded:', currentStudioId);
            
            if (!currentStudioId) {
                console.error('Studio ID not found in localStorage!');
                // Show an error message to the user
                const errorMessage = document.createElement('div');
                errorMessage.className = 'alert alert-danger';
                errorMessage.textContent = 'Studio ID not found. Please return to the dashboard and try again.';
                document.querySelector('.container-fluid').prepend(errorMessage);
            }
            
            // Get the current tab from URL hash, or default to first tab
            const currentHash = window.location.hash;
            let activeTabId = 'revenue';
            
            if (currentHash) {
                const tabId = currentHash.substring(1); // Remove the # character
                const tab = document.getElementById(`${tabId}-tab`);
                if (tab) {
                    activeTabId = tabId;
                }
            }
            
            // Activate the appropriate tab
            const activeTab = document.getElementById(`${activeTabId}-tab`);
            if (activeTab) {
                const tabInstance = new bootstrap.Tab(activeTab);
                tabInstance.show();
            }
            
            // Update URL hash when tab changes
            const tabEls = document.querySelectorAll('button[data-bs-toggle="tab"]');
            tabEls.forEach(tabEl => {
                tabEl.addEventListener('shown.bs.tab', function(event) {
                    // Get the ID of the newly active tab
                    const tabId = event.target.id.replace('-tab', '');
                    // Update the URL hash without causing a page reload
                    history.pushState(null, null, `#${tabId}`);
                    
                    // Call the appropriate load function based on the tab
                    loadTabData(tabId);
                });
            });
            
            // Initialize all tabs
            initializeTabs();
        });
        
        // Function to load data for the current tab
        function loadTabData(tabId) {
            console.log(`Loading data for ${tabId} tab using studio ID: ${currentStudioId}`);
            
            switch(tabId) {
                case 'revenue':
                    loadRevenueData(currentStudioId);
                    break;
                case 'charges':
                    loadCharges(currentStudioId);
                    break;
                case 'tuition-rates':
                    loadTuitionRatesData(currentStudioId);
                    break;
                case 'fees':
                    loadFeesData(currentStudioId);
                    break;
                case 'discounts':
                    loadDiscountsData(currentStudioId);
                    break;
                case 'credit':
                    loadCreditsData(currentStudioId);
                    break;
                case 'student-family-max':
                    loadStudentFamilyMaxData(currentStudioId);
                    break;
                default:
                    console.log('Unknown tab ID');
            }
        }
        
        function initializeTabs() {
            // Get currently active tab
            const activeTabId = document.querySelector('#chargesTab .nav-link.active').id.replace('-tab', '');
            
            // Initialize all tabs
            initializeRevenueTab();
            initializeChargesTab();
            initializeTuitionRatesTab();
            initializeFeesTab();
            initializeDiscountsTab();
            initializeCreditTab();
            initializeStudentFamilyMaxTab();
            
            // Load data for the active tab
            loadTabData(activeTabId);
        }
        
        function initializeRevenueTab() {
            console.log('Revenue tab initialized');
            // Add revenue tab specific initialization here
        }
        
        function initializeChargesTab() {
            console.log('Charges tab initialized');
            
            // Set up search functionality
            const searchInput = document.getElementById('chargeSearchInput');
            const clearButton = document.getElementById('clearChargeSearch');
            
            if (searchInput) {
                // Add debounce for better performance on large tables
                let searchTimeout;
                searchInput.addEventListener('input', function() {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => {
                        searchCharges(this.value);
                    }, 200); // wait 200ms after typing stops
                });
            }
            
            if (clearButton) {
                clearButton.addEventListener('click', function() {
                    if (searchInput) {
                        searchInput.value = '';
                        searchCharges('');
                        searchInput.focus(); // Return focus to search box
                    }
                });
            }
        }
        
        function initializeTuitionRatesTab() {
            console.log('Tuition Rates tab initialized');
            
            // Make sure the modal is registered with Bootstrap properly
            document.getElementById('createTuitionRateModal')?.addEventListener('hidden.bs.modal', function() {
                // Reset form when modal is closed
                document.getElementById('ratePlanName').value = '';
                document.querySelectorAll('.hour-rate-pair').forEach((pair, index) => {
                    if (index === 0) {
                        pair.querySelector('.hours-input').value = '';
                        pair.querySelector('.rate-input').value = '';
                    } else {
                        pair.remove();
                    }
                });
                
                const familyDiscountToggle = document.getElementById('familyDiscountToggle');
                const familyDiscountSection = document.getElementById('familyDiscountSection');
                if (familyDiscountToggle && familyDiscountSection) {
                    familyDiscountToggle.checked = false;
                    familyDiscountSection.style.display = 'none';
                }
                
                // Reset modal title and button text
                document.getElementById('createTuitionRateModalLabel').textContent = 'Create Tuition Rate Plan';
                document.getElementById('saveTuitionRatePlan').textContent = 'Save Rate Plan';
            });
            
            // Add event listeners for tuition rate form
            const addHourRatePairBtn = document.getElementById('addHourRatePair');
            const hourRatePairs = document.getElementById('hourRatePairs');
            const familyDiscountToggle = document.getElementById('familyDiscountToggle');
            const familyDiscountSection = document.getElementById('familyDiscountSection');
            const discountTypeSelect = document.getElementById('discountType');
            const percentageSymbol = document.querySelector('.percentage-symbol');
            const fixedSymbol = document.querySelector('.fixed-symbol');
            const discountPrefix = document.getElementById('discountPrefix');
            
            // Show/hide family discount section based on checkbox
            familyDiscountToggle?.addEventListener('change', function() {
                familyDiscountSection.style.display = this.checked ? 'block' : 'none';
            });
            
            // Update discount input based on type
            discountTypeSelect?.addEventListener('change', function() {
                if (this.value === 'percentage') {
                    percentageSymbol.style.display = 'inline';
                    fixedSymbol.style.display = 'none';
                    discountPrefix.textContent = '';
                } else {
                    percentageSymbol.style.display = 'none';
                    fixedSymbol.style.display = 'inline';
                    discountPrefix.textContent = '$';
                }
            });
            
            // Set default percentage display on initial load
            if (discountTypeSelect && discountTypeSelect.value === 'percentage') {
                percentageSymbol.style.display = 'inline';
                fixedSymbol.style.display = 'none';
                discountPrefix.textContent = '';
            }
            
            // Add new hour/rate pair
            addHourRatePairBtn?.addEventListener('click', function() {
                const newPair = hourRatePairs.children[0].cloneNode(true);
                newPair.querySelector('.hours-input').value = '';
                newPair.querySelector('.rate-input').value = '';
                newPair.querySelector('.remove-pair').style.display = 'block';
                
                // Add remove button functionality
                newPair.querySelector('.remove-pair').addEventListener('click', function() {
                    this.closest('.hour-rate-pair').remove();
                });
                
                hourRatePairs.appendChild(newPair);
            });

            // Initialize mode toggle
            const advancedModeToggle = document.getElementById('advancedModeToggle');
            const basicModeForm = document.getElementById('basicModeForm');
            const advancedModeForm = document.getElementById('advancedModeForm');
            const modeToggleLabel = document.getElementById('modeToggleLabel');

            advancedModeToggle.addEventListener('change', function() {
                if (this.checked) {
                    basicModeForm.style.display = 'none';
                    advancedModeForm.style.display = 'block';
                    modeToggleLabel.textContent = 'Advanced Mode';
                } else {
                    basicModeForm.style.display = 'block';
                    advancedModeForm.style.display = 'none';
                    modeToggleLabel.textContent = 'Basic Mode';
                }
            });

            // Handle rate generation in basic mode
            document.getElementById('generateRates').addEventListener('click', function() {
                const startHour = parseFloat(document.getElementById('startHour').value) || 0;
                const startAmount = parseFloat(document.getElementById('startAmount').value) || 0;
                const incrementInterval = parseFloat(document.getElementById('incrementInterval').value) || 0.25;
                const incrementAmount = parseFloat(document.getElementById('incrementAmount').value) || 0;
                const maxHours = parseFloat(document.getElementById('maxHours').value) || 10;

                // Clear existing rate pairs
                const hourRatePairs = document.getElementById('hourRatePairs');
                hourRatePairs.innerHTML = '';

                // Generate rate pairs
                let currentHour = startHour;
                let currentAmount = startAmount;

                while (currentHour <= maxHours) {
                    // Create new rate pair
                    const pairDiv = document.createElement('div');
                    pairDiv.className = 'hour-rate-pair mb-3';
                    pairDiv.innerHTML = `
                        <div class="row">
                            <div class="col">
                                <label class="form-label">Hours</label>
                                <input type="number" class="form-control hours-input" min="0" step="0.25" value="${currentHour.toFixed(2)}">
                            </div>
                            <div class="col">
                                <label class="form-label">Rate ($)</label>
                                <input type="number" class="form-control rate-input" min="0" step="0.01" value="${currentAmount.toFixed(2)}">
                            </div>
                            <div class="col-auto d-flex align-items-end">
                                <button type="button" class="btn btn-danger remove-pair">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    `;

                    // Add remove button functionality
                    const removeBtn = pairDiv.querySelector('.remove-pair');
                    removeBtn.addEventListener('click', function() {
                        this.closest('.hour-rate-pair').remove();
                    });

                    hourRatePairs.appendChild(pairDiv);

                    // Increment for next iteration
                    currentHour += incrementInterval;
                    currentAmount += incrementAmount;
                }

                // Show the generated rates in advanced mode
                advancedModeToggle.checked = true;
                basicModeForm.style.display = 'none';
                advancedModeForm.style.display = 'block';
                modeToggleLabel.textContent = 'Advanced Mode';
            });
        }
        
        function initializeFeesTab() {
            console.log('Fees tab initialized');
            
            // Set up modal close reset
            document.getElementById('newFeeModal').addEventListener('hidden.bs.modal', resetFeeForm);
            
            // Set up search functionality
            const searchInput = document.getElementById('feeSearchInput');
            const clearButton = document.getElementById('clearFeeSearch');
            
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    searchFees(this.value);
                });
                
                // Add debounce for better performance on large tables
                let searchTimeout;
                searchInput.addEventListener('input', function() {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => {
                        searchFees(this.value);
                    }, 200); // wait 200ms after typing stops
                });
            }
            
            if (clearButton) {
                clearButton.addEventListener('click', function() {
                    if (searchInput) {
                        searchInput.value = '';
                        searchFees('');
                        searchInput.focus(); // Return focus to search box
                    }
                });
            }
            
            // Set up fee type dropdown change handler
            document.getElementById('feeType').addEventListener('change', function() {
                const selectedType = this.value;
                
                // Hide all conditional sections first
                document.getElementById('recurringOptions').style.display = 'none';
                document.getElementById('installmentsOptions').style.display = 'none';
                
                // Show the appropriate section based on the selected fee type
                if (selectedType === 'Recurring') {
                    document.getElementById('recurringOptions').style.display = 'block';
                } else if (selectedType === 'Installments') {
                    document.getElementById('installmentsOptions').style.display = 'block';
                }
            });
            
            // Set up association dropdown change handler
            document.getElementById('feeAssociation').addEventListener('change', function() {
                const associationType = this.value;
                const associationContainer = document.getElementById('associationItemContainer');
                const associationDropdown = document.getElementById('associationItem');
                
                // Clear previous options
                associationDropdown.innerHTML = '<option value="" selected disabled>Select an item</option>';
                
                if (associationType) {
                    // Show the dropdown container
                    associationContainer.style.display = 'block';
                    associationDropdown.disabled = false;
                    
                    // Load options based on association type
                    loadAssociationOptions(associationType);
                } else {
                    // Hide the dropdown container
                    associationContainer.style.display = 'none';
                    associationDropdown.disabled = true;
                }
            });
            
            // Set up save button handler
            document.getElementById('saveFeeBtn').addEventListener('click', saveFee);
        }
        
        function initializeDiscountsTab() {
            console.log('Discount tab initialized');
            
            // Set up modal close reset
            document.getElementById('newDiscountModal').addEventListener('hidden.bs.modal', resetDiscountForm);
            
            // Set up search functionality
            const searchInput = document.getElementById('discountSearchInput');
            const clearButton = document.getElementById('clearDiscountSearch');
            
            if (searchInput) {
                // Add debounce for better performance
                let searchTimeout;
                searchInput.addEventListener('input', function() {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => {
                        searchDiscounts(this.value);
                    }, 200); // wait 200ms after typing stops
                });
            }
            
            if (clearButton) {
                clearButton.addEventListener('click', function() {
                    if (searchInput) {
                        searchInput.value = '';
                        searchDiscounts('');
                        searchInput.focus(); // Return focus to search box
                    }
                });
            }
            
            // Set up discount type dropdown change handler
            document.getElementById('discountType').addEventListener('change', function() {
                const discountType = this.value;
                const percentageSymbol = document.querySelector('.percentage-symbol');
                const fixedSymbol = document.querySelector('.fixed-symbol');
                const discountPrefix = document.getElementById('discountPrefix');
                
                if (discountType === 'Percentage') {
                    percentageSymbol.style.display = 'inline';
                    fixedSymbol.style.display = 'none';
                    discountPrefix.textContent = '';
                } else {
                    percentageSymbol.style.display = 'none';
                    fixedSymbol.style.display = 'inline';
                    discountPrefix.textContent = '$';
                }
            });
            
            // Set up association dropdown change handler
            document.getElementById('discountAssociation').addEventListener('change', function() {
                const associationType = this.value;
                const associationContainer = document.getElementById('discountAssociationItemContainer');
                const associationDropdown = document.getElementById('discountAssociationItem');
                const codeContainer = document.getElementById('discountCodeContainer');
                
                // Hide both containers initially
                associationContainer.style.display = 'none';
                codeContainer.style.display = 'none';
                
                if (associationType === 'Code') {
                    // Show code input field for Code association type
                    codeContainer.style.display = 'block';
                    // Reset and disable the association dropdown
                    associationDropdown.innerHTML = '<option value="" selected disabled>Not applicable</option>';
                    associationDropdown.disabled = true;
                } else if (associationType) {
                    // Show the dropdown container for other association types
                    associationContainer.style.display = 'block';
                    associationDropdown.disabled = false;
                    
                    // Load options based on association type
                    loadAssociationOptionsForDiscount(associationType);
                }
            });
            
            // Set up save button handler
            document.getElementById('saveDiscountBtn').addEventListener('click', saveDiscount);
        }
        
        function initializeCreditTab() {
            console.log('Credit tab initialized');
            
            // Set up modal close reset
            document.getElementById('newCreditModal').addEventListener('hidden.bs.modal', resetCreditForm);
            
            // Set up search functionality
            const searchInput = document.getElementById('creditSearchInput');
            const clearButton = document.getElementById('clearCreditSearch');
            
            if (searchInput) {
                // Add debounce for better performance
                let searchTimeout;
                searchInput.addEventListener('input', function() {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => {
                        searchCredits(this.value);
                    }, 200); // wait 200ms after typing stops
                });
            }
            
            if (clearButton) {
                clearButton.addEventListener('click', function() {
                    if (searchInput) {
                        searchInput.value = '';
                        searchCredits('');
                        searchInput.focus(); // Return focus to search box
                    }
                });
            }
            
            // Set up family search
            const familySearchInput = document.getElementById('creditFamilySearchInput');
            if (familySearchInput) {
                familySearchInput.addEventListener('input', function() {
                    filterFamilyOptions(this.value);
                });
            }
            
            // Set up save button handler
            document.getElementById('saveCreditBtn').addEventListener('click', saveCredit);
        }
        
        function initializeStudentFamilyMaxTab() {
            console.log('Student/FamilyMax tab initialized');
            
            // Set up toggle event handler
            const enableToggle = document.getElementById('enableStudentFamilyMax');
            if (enableToggle) {
                enableToggle.addEventListener('change', function() {
                    const maxSettingsContainer = document.getElementById('maxSettingsContainer');
                    if (maxSettingsContainer) {
                        maxSettingsContainer.style.display = this.checked ? 'block' : 'none';
                    }
                });
            }
            
            // Set up save button handler
            const saveButton = document.getElementById('saveStudentFamilyMaxBtn');
            if (saveButton) {
                saveButton.addEventListener('click', saveStudentFamilyMax);
            }
        }
        
        function loadRevenueData(studioId) {
    console.log("Loading revenue data from Payments collection...");
    const db = firebase.firestore();
    
    // Show loading spinners
    showLoadingSpinners();
    
    // Get current date information
    const now = new Date();
    const currentMonth = now.getMonth();
    const currentYear = now.getFullYear();
    
    // Calculate date ranges
    const thirtyDaysAgo = new Date();
    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
    
    const sixtyDaysAgo = new Date();
    sixtyDaysAgo.setDate(sixtyDaysAgo.getDate() - 60);
    
    // Get last month's date
    const lastMonth = currentMonth === 0 ? 11 : currentMonth - 1;
    const lastMonthYear = currentMonth === 0 ? currentYear - 1 : currentYear;
    
    // Fetch all payments and families
    return Promise.all([
        db.collection(`Studios/${studioId}/Payments`).get(),
        db.collection(`Studios/${studioId}/Families`).get()
    ])
        .then(([paymentsSnapshot, familiesSnapshot]) => {
            let allPayments = [];
            let totalOutstandingBalance = 0;
            let accountsWithBalance = 0;
            let totalFamilies = 0;
            
            // Process all payments
            paymentsSnapshot.forEach(doc => {
                const paymentData = doc.data();
                allPayments.push({
                    ...paymentData,
                    PaymentDate: paymentData.PaymentDate.toDate ? 
                        paymentData.PaymentDate.toDate() : 
                        new Date(paymentData.PaymentDate)
                });
            });
            
            // Process all families to calculate outstanding balances
            familiesSnapshot.forEach(doc => {
                const familyData = doc.data();
                totalFamilies++;
                
                // Check if family has an outstanding balance
                if (familyData.Balance > 0) {
                    accountsWithBalance++;
                    totalOutstandingBalance += familyData.Balance;
                }
            });
            
            // Calculate current month revenue
            const currentMonthPayments = allPayments.filter(payment => {
                const paymentDate = payment.PaymentDate;
                return paymentDate.getMonth() === currentMonth && 
                       paymentDate.getFullYear() === currentYear;
            });
            const currentMonthRevenue = currentMonthPayments.reduce((sum, payment) => sum + payment.Amount, 0);
            
            // Calculate last month revenue
            const lastMonthPayments = allPayments.filter(payment => {
                const paymentDate = payment.PaymentDate;
                return paymentDate.getMonth() === lastMonth && 
                       paymentDate.getFullYear() === lastMonthYear;
            });
            const lastMonthRevenue = lastMonthPayments.reduce((sum, payment) => sum + payment.Amount, 0);
            
            // Calculate last 30 days revenue
            const last30DaysPayments = allPayments.filter(payment => 
                payment.PaymentDate >= thirtyDaysAgo
            );
            const last30DaysRevenue = last30DaysPayments.reduce((sum, payment) => sum + payment.Amount, 0);
            
            // Calculate previous 30 days revenue
            const previous30DaysPayments = allPayments.filter(payment => 
                payment.PaymentDate >= sixtyDaysAgo && 
                payment.PaymentDate < thirtyDaysAgo
            );
            const previous30DaysRevenue = previous30DaysPayments.reduce((sum, payment) => sum + payment.Amount, 0);
            
            // Calculate percentage changes
            const monthChangePercent = lastMonthRevenue === 0 ? 0 : 
                ((currentMonthRevenue - lastMonthRevenue) / lastMonthRevenue) * 100;
            
            const thirtyDaysChangePercent = previous30DaysRevenue === 0 ? 0 : 
                ((last30DaysRevenue - previous30DaysRevenue) / previous30DaysRevenue) * 100;
            
            // Calculate percentage of accounts with outstanding balance
            const accountsWithBalancePercent = totalFamilies === 0 ? 0 : 
                (accountsWithBalance / totalFamilies) * 100;
            
            // Update UI with results
            document.getElementById('revenueThisMonth').textContent = formatCurrency(currentMonthRevenue);
            
            // Update month change percentage
            const monthChangeElement = document.getElementById('revenueMonthChange');
            if (monthChangePercent > 0) {
                monthChangeElement.innerHTML = `<i class="fas fa-arrow-up me-1"></i>${monthChangePercent.toFixed(1)}% from last month`;
                monthChangeElement.className = 'card-text fs-5 text-success';
            } else if (monthChangePercent < 0) {
                monthChangeElement.innerHTML = `<i class="fas fa-arrow-down me-1"></i>${Math.abs(monthChangePercent).toFixed(1)}% from last month`;
                monthChangeElement.className = 'card-text fs-5 text-danger';
            } else {
                monthChangeElement.innerHTML = `0% change from last month`;
                monthChangeElement.className = 'card-text fs-5 text-muted';
            }
            
            // Update last 30 days
            document.getElementById('revenueLast30Days').textContent = formatCurrency(last30DaysRevenue);
            
            // Update 30 days change percentage
            const thirtyDaysChangeElement = document.getElementById('revenue30DayChange');
            if (thirtyDaysChangePercent > 0) {
                thirtyDaysChangeElement.innerHTML = `<i class="fas fa-arrow-up me-1"></i>${thirtyDaysChangePercent.toFixed(1)}% from previous period`;
                thirtyDaysChangeElement.className = 'card-text fs-5 text-success';
            } else if (thirtyDaysChangePercent < 0) {
                thirtyDaysChangeElement.innerHTML = `<i class="fas fa-arrow-down me-1"></i>${Math.abs(thirtyDaysChangePercent).toFixed(1)}% from previous period`;
                thirtyDaysChangeElement.className = 'card-text fs-5 text-danger';
            } else {
                thirtyDaysChangeElement.innerHTML = `0% change from previous period`;
                thirtyDaysChangeElement.className = 'card-text fs-5 text-muted';
            }
            
            // Update outstanding balances
            document.getElementById('outstandingBalances').textContent = formatCurrency(totalOutstandingBalance);
            document.getElementById('outstandingBalanceCount').textContent = `${accountsWithBalance} unpaid invoices`;
            
            // Update accounts with balances
            document.getElementById('accountsWithBalance').textContent = accountsWithBalance;
            document.getElementById('accountsWithBalancePercent').textContent = 
                `${accountsWithBalancePercent.toFixed(1)}% of total accounts`;
            
            // Hide loading spinners
            hideLoadingSpinners();
            
            console.log("Revenue data calculated and displayed");
            return true;
        })
        .catch(error => {
            console.error("Error loading revenue data:", error);
            hideLoadingSpinners();
            return false;
        });
}
        
        function loadCharges(studioId) {
            console.log('Loading charges data for studio:', studioId);
            
            // Reset search input
            const searchInput = document.getElementById('chargeSearchInput');
            if (searchInput) {
                searchInput.value = '';
            }
            
            const chargesTableBody = document.querySelector('#chargesTable tbody');
            chargesTableBody.innerHTML = '<tr><td colspan="6" class="text-center">Loading charges...</td></tr>';
            
            // First check if we have the Charges-Payments collection set up
            checkAndInitializeChargesPayments(studioId)
                .then(initialized => {
                    if (initialized) {
                        // Try to load charges from the dedicated collection first
                        return loadChargesPaymentsFromSubcollection(studioId)
                            .then(charges => {
                                if (charges && charges.length > 0) {
                                    return charges; // Successfully loaded from collection
                                } else {
                                    // Fall back to loading directly from families and then sync
                                    return loadChargesFromFamilies(studioId)
                                        .then(() => syncChargesAndRevenue(studioId));
                                }
                            });
                    } else {
                        throw new Error("Failed to initialize Charges-Payments collection");
                    }
                })
                .catch(error => {
                    console.error("Error in charges data loading process:", error);
                    chargesTableBody.innerHTML = '<tr class="text-center text-danger"><td colspan="6">Error loading charges. Please try again.</td></tr>';
                });
        }
        
        // Original function to load charges directly from families
        function loadChargesFromFamilies(studioId) {
            // Query all families in the studio
            return firebase.firestore().collection(`Studios/${studioId}/Families`)
                .get()
                .then(snapshot => {
                    if (snapshot.empty) {
                        const chargesTableBody = document.querySelector('#chargesTable tbody');
                        chargesTableBody.innerHTML = '<tr class="text-center text-muted"><td colspan="6">No charges found.</td></tr>';
                        return [];
                    }
                    
                    // Array to hold all charges
                    let allCharges = [];
                    
                    // Process each family
                    snapshot.forEach(doc => {
                        const familyData = doc.data();
                        const familyId = doc.id;
                        const familyName = familyData.LastName || 'Unnamed Family';
                        
                        // Extract charges from this family
                        if (familyData.Charges && Array.isArray(familyData.Charges)) {
                            familyData.Charges.forEach(charge => {
                                // Add family information to each charge
                                allCharges.push({
                                    ...charge,
                                    FamilyId: familyId,
                                    FamilyName: familyName
                                });
                            });
                        }
                    });
                    
                    // Sort charges by date (newest first)
                    allCharges.sort((a, b) => {
                        const dateA = new Date(a.ChargeDate);
                        const dateB = new Date(b.ChargeDate);
                        return dateB - dateA; // Descending order
                    });
                    
                    if (allCharges.length === 0) {
                        const chargesTableBody = document.querySelector('#chargesTable tbody');
                        chargesTableBody.innerHTML = '<tr class="text-center text-muted"><td colspan="6">No charges found.</td></tr>';
                        return [];
                    }
                    
                    // Store the charges in a global variable for searching
                    window.allStudioCharges = allCharges;
                    
                    // Display the charges
                    displayTransactions(allCharges);
                    
                    return allCharges;
                })
                .catch(error => {
                    console.error('Error loading charges from families:', error);
                    const chargesTableBody = document.querySelector('#chargesTable tbody');
                    chargesTableBody.innerHTML = '<tr class="text-center text-danger"><td colspan="6">Error loading charges. Please try again.</td></tr>';
                    return [];
                });
        }
        
      // Function to load charges and payments from the collections
function loadChargesPaymentsFromSubcollection(studioId) {
    const db = firebase.firestore();
    
    // Load both charges and payments
    return Promise.all([
        db.collection('Studios').doc(studioId).collection('Charges').get(),
        db.collection('Studios').doc(studioId).collection('Payments').get()
    ]).then(([chargesSnapshot, paymentsSnapshot]) => {
        if (chargesSnapshot.empty && paymentsSnapshot.empty) {
            const chargesTableBody = document.querySelector('#chargesTable tbody');
            chargesTableBody.innerHTML = '<tr class="text-center text-muted"><td colspan="6">No charges or payments found.</td></tr>';
            return [];
        }
        
        let allTransactions = [];
        const familyPromises = [];
        
        // Process charges
        chargesSnapshot.forEach(doc => {
            const chargeData = doc.data();
            if (chargeData.FamilyId) {
                const familyPromise = db.collection('Studios').doc(studioId)
                    .collection('Families').doc(chargeData.FamilyId)
                    .get()
                    .then(familyDoc => {
                        if (familyDoc.exists) {
                            const familyData = familyDoc.data();
                            return `${familyData.FirstName || ''} ${familyData.LastName || ''}`.trim() || 'Unknown Family';
                        }
                        return '';
                    })
                    .catch(() => '');
                
                familyPromises.push(familyPromise);
            } else {
                familyPromises.push(Promise.resolve(''));
            }
            
            allTransactions.push({
                ...chargeData,
                Id: doc.id,
                Type: 'Charge'
            });
        });

        // Process payments
        paymentsSnapshot.forEach(doc => {
            const paymentData = doc.data();
            if (paymentData.FamilyId) {
                const familyPromise = db.collection('Studios').doc(studioId)
                    .collection('Families').doc(paymentData.FamilyId)
                    .get()
                    .then(familyDoc => {
                        if (familyDoc.exists) {
                            const familyData = familyDoc.data();
                            return `${familyData.FirstName || ''} ${familyData.LastName || ''}`.trim() || 'Unknown Family';
                        }
                        return '';
                    })
                    .catch(() => '');
                
                familyPromises.push(familyPromise);
            } else {
                familyPromises.push(Promise.resolve(''));
            }
            
            allTransactions.push({
                ...paymentData,
                Id: doc.id,
                Type: 'Payment'
            });
        });
        
        // Wait for all family names to be fetched
        return Promise.all(familyPromises)
            .then(familyNames => {
                // Add family names to transactions
                allTransactions.forEach((transaction, index) => {
                    transaction.FamilyName = familyNames[index];
                });
                
                // Sort transactions by date (newest first)
                allTransactions.sort((a, b) => {
                    let dateA, dateB;
                    
                    // Handle dateA
                    if (a.ChargeDate) {
                        if (a.ChargeDate.toDate) {
                            dateA = a.ChargeDate.toDate();
                        } else if (a.ChargeDate.seconds) {
                            dateA = new Date(a.ChargeDate.seconds * 1000);
                        } else {
                            dateA = new Date(a.ChargeDate);
                        }
                    } else if (a.PaymentDate) {
                        if (a.PaymentDate.toDate) {
                            dateA = a.PaymentDate.toDate();
                        } else if (a.PaymentDate.seconds) {
                            dateA = new Date(a.PaymentDate.seconds * 1000);
                        } else {
                            dateA = new Date(a.PaymentDate);
                        }
                    } else {
                        dateA = new Date(0);
                    }
                    
                    // Handle dateB
                    if (b.ChargeDate) {
                        if (b.ChargeDate.toDate) {
                            dateB = b.ChargeDate.toDate();
                        } else if (b.ChargeDate.seconds) {
                            dateB = new Date(b.ChargeDate.seconds * 1000);
                        } else {
                            dateB = new Date(b.ChargeDate);
                        }
                    } else if (b.PaymentDate) {
                        if (b.PaymentDate.toDate) {
                            dateB = b.PaymentDate.toDate();
                        } else if (b.PaymentDate.seconds) {
                            dateB = new Date(b.PaymentDate.seconds * 1000);
                        } else {
                            dateB = new Date(b.PaymentDate);
                        }
                    } else {
                        dateB = new Date(0);
                    }
                    
                    return dateB - dateA; // Sort newest first
                });
                
                // Store transactions globally for search functionality
                window.allStudioCharges = allTransactions;
                
                // Display the transactions
                displayTransactions(allTransactions);
                
                console.log(`Loaded ${allTransactions.length} transactions from Charges and Payments collections`);
                return allTransactions;
            });
    })
    .catch(error => {
        console.error('Error loading transactions from collections:', error);
        const chargesTableBody = document.querySelector('#chargesTable tbody');
        chargesTableBody.innerHTML = '<tr class="text-center text-danger"><td colspan="6">Error loading transactions. Please try again.</td></tr>';
        return [];
    });
}

        
      // Function to load payments from the Payments collection
function loadPaymentsFromSubcollection(studioId) {
            const db = firebase.firestore();
            
    return db.collection('Studios').doc(studioId).collection('Payments')
        .get()
        .then(snapshot => {
            if (snapshot.empty) {
                const paymentsTableBody = document.querySelector('#paymentsTable tbody');
                paymentsTableBody.innerHTML = '<tr class="text-center text-muted"><td colspan="6">No payments found.</td></tr>';
                return [];
            }
            
            let allPayments = [];
            const familyPromises = [];
            
            snapshot.forEach(doc => {
                const paymentData = doc.data();
                // If there's a FamilyId, fetch the family name
                if (paymentData.FamilyId) {
                    const familyPromise = db.collection('Studios').doc(studioId)
                        .collection('Families').doc(paymentData.FamilyId)
                        .get()
                        .then(familyDoc => {
                            if (familyDoc.exists) {
                                const familyData = familyDoc.data();
                                return `${familyData.FirstName || ''} ${familyData.LastName || ''}`.trim() || 'Unknown Family';
                            }
                            return '';
                        })
                        .catch(() => '');
                    
                    familyPromises.push(familyPromise);
                    } else {
                    familyPromises.push(Promise.resolve(''));
                }
                
                allPayments.push({
                    ...paymentData,
                    Id: doc.id
                });
            });
            
            // Wait for all family names to be fetched
            return Promise.all(familyPromises)
                .then(familyNames => {
                    // Add family names to payments
                    allPayments.forEach((payment, index) => {
                        payment.FamilyName = familyNames[index];
                    });
                    
                    // Sort payments by date (newest first)
                    allPayments.sort((a, b) => {
                        const dateA = new Date(a.PaymentDate || 0);
                        const dateB = new Date(b.PaymentDate || 0);
                        return dateB - dateA;
                    });
                    
                    // Store payments globally for search functionality
                    window.allStudioPayments = allPayments;
                    
                    // Display the payments
                    displayPayments(allPayments);
                    
                    console.log(`Loaded ${allPayments.length} payments from the Payments collection`);
                    return allPayments;
                });
        })
        .catch(error => {
            console.error('Error loading payments from collection:', error);
            const paymentsTableBody = document.querySelector('#paymentsTable tbody');
            paymentsTableBody.innerHTML = '<tr class="text-center text-danger"><td colspan="6">Error loading payments. Please try again.</td></tr>';
            return [];
        });
}
        
        // Initialize the Charges-Payments subcollection with required documents
        function initializeChargesPaymentsCollection(studioId) {
            const db = firebase.firestore();
            const chargesPaymentsRef = db.collection(`Studios/${studioId}/Charges-Payments`);
            
            // Create the revenue documents with proper Pascal case naming
            const revenueDocuments = [
                {
                    id: "RevenueOverview",
                    data: {
                        Title: "Revenue Overview",
                        RevenueThisMonth: 0,
                        RevenueMonthChange: 0,
                        RevenueLast30Days: 0,
                        Revenue30DayChange: 0,
                        OutstandingBalances: 0,
                        OutstandingBalanceCount: 0,
                        AccountsWithBalance: 0,
                        AccountsWithBalancePercent: 0,
                        LastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                    }
                },
                {
                    id: "RevenueThisMonth",
                    data: {
                        Title: "Revenue This Month",
                        Amount: 0,
                        PercentChange: 0, // from last month
                        LastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                    }
                },
                {
                    id: "Last30Days",
                    data: {
                        Title: "Last 30 Days",
                        Amount: 0,
                        PercentChange: 0, // from previous period
                        LastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                    }
                },
                {
                    id: "OutstandingBalances",
                    data: {
                        Title: "Outstanding Balances",
                        Amount: 0,
                        UnpaidInvoices: 0,
                        LastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                    }
                },
                {
                    id: "AccountsWithBalance",
                    data: {
                        Title: "Accounts with Outstanding Balances",
                        Count: 0,
                        PercentOfTotal: 0,
                        LastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                    }
                },
                {
                    id: "FamilyBalances",
                    data: {
                        Families: [],
                        LastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                    }
                }
            ];
            
            // Create a document for the charges array
            const chargesDocument = {
                id: "AllCharges",
                data: {
                    Charges: [],
                    LastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                }
            };
            
            // Create a batch write to create all documents at once
            const batch = db.batch();
            
            // Add revenue documents
            revenueDocuments.forEach(doc => {
                const docRef = chargesPaymentsRef.doc(doc.id);
                batch.set(docRef, doc.data);
            });
            
            // Add charges document
            const chargesDocRef = chargesPaymentsRef.doc(chargesDocument.id);
            batch.set(chargesDocRef, chargesDocument.data);
            
            // Commit the batch
            return batch.commit()
                .then(() => {
                    console.log("Charges-Payments collection initialized successfully with Pascal case document names");
                    return true;
                })
                .catch(error => {
                    console.error("Error initializing Charges-Payments collection:", error);
                    return false;
                });
        }
        
        // Update the AllCharges document with aggregated charges from families
        function updateAllChargesDocument(studioId) {
            const db = firebase.firestore();
            
            // Get all family documents to extract charges
            return db.collection(`Studios/${studioId}/Families`).get()
                .then(snapshot => {
                    let allCharges = [];
                    
                    // Process each family
                    snapshot.forEach(doc => {
                        const familyData = doc.data();
                        const familyId = doc.id;
                        const familyName = familyData.LastName || 'Unnamed Family';
                        
                        // Extract charges from this family
                        if (familyData.Charges && Array.isArray(familyData.Charges)) {
                            familyData.Charges.forEach(charge => {
                                // Add family information to each charge
                                allCharges.push({
                                    ...charge,
                                    FamilyId: familyId,
                                    FamilyName: familyName
                                });
                            });
                        }
                    });
                    
                    // Update the AllCharges document
                    const chargesDocRef = db.collection(`Studios/${studioId}/Charges-Payments`).doc('AllCharges');
                    return chargesDocRef.update({
                        Charges: allCharges,
                        LastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                    });
                })
                .then(() => {
                    console.log("All charges document updated successfully");
                    return updateRevenueDocuments(studioId);
                })
                .catch(error => {
                    console.error("Error updating all charges document:", error);
                    throw error;
                });
        }
        
        // Update revenue documents based on charges data
        function updateRevenueDocuments(studioId) {
            console.log("Updating revenue documents...");
            const db = firebase.firestore();
            
            // Get the family balances document
            return db.collection(`Studios/${studioId}/Charges-Payments`).doc('FamilyBalances').get()
                .then(doc => {
                    if (!doc.exists) {
                        throw new Error("FamilyBalances document not found");
                    }
                    
                    const familyBalancesData = doc.data();
                    const families = familyBalancesData.Families || [];
                    
                    // Calculate outstanding balances and accounts with balance
                    let outstandingBalances = 0;
                    let accountsWithBalance = 0;
                    let totalAccounts = families.length;
                    
                    families.forEach(family => {
                        const balance = parseFloat(family.Balance || 0);
                        if (balance > 0) {
                            outstandingBalances += balance;
                            accountsWithBalance++;
                            console.log(`Family ${family.FamilyName} has outstanding balance: $${balance}`);
                        }
                    });
                    
                    // Calculate percentage of accounts with balances
                    const percentWithBalance = totalAccounts > 0 ? 
                        Math.round((accountsWithBalance / totalAccounts) * 100 * 10) / 10 : 0;
                    
                    console.log(`Outstanding balances: $${outstandingBalances.toFixed(2)}`);
                    console.log(`Accounts with balances: ${accountsWithBalance} (${percentWithBalance}% of total)`);
                    
                    // Update the OutstandingBalances document
                    const outstandingBalancesRef = db.collection(`Studios/${studioId}/Charges-Payments`).doc('OutstandingBalances');
                    const outstandingBalancesPromise = outstandingBalancesRef.update({
                        Amount: outstandingBalances,
                        UnpaidInvoices: accountsWithBalance, // Using accounts with balance as unpaid invoices count
                        LastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    // Update the AccountsWithBalance document
                    const accountsWithBalanceRef = db.collection(`Studios/${studioId}/Charges-Payments`).doc('AccountsWithBalance');
                    const accountsWithBalancePromise = accountsWithBalanceRef.update({
                        Count: accountsWithBalance,
                        PercentOfTotal: percentWithBalance,
                        LastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    return Promise.all([outstandingBalancesPromise, accountsWithBalancePromise]);
                })
                .then(() => {
                    console.log("Revenue documents updated successfully");
                    return true;
                })
                .catch(error => {
                    console.error("Error updating revenue documents:", error);
                    return false;
                });
        }
        
        // Helper function to check if a document exists and create it if it doesn't
        function checkAndCreateDocument(collectionRef, docId) {
            return collectionRef.doc(docId).get()
                .then(docSnapshot => {
                    if (!docSnapshot.exists) {
                        console.log(`Creating missing document: ${docId}`);
                        
                        // Create default data based on document ID
                        let defaultData = {
                            LastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                        };
                        
                        if (docId === 'RevenueOverview') {
                            defaultData = {
                                Title: "Revenue Overview",
                                RevenueThisMonth: 0,
                                RevenueMonthChange: 0,
                                RevenueLast30Days: 0,
                                Revenue30DayChange: 0,
                                OutstandingBalances: 0,
                                OutstandingBalanceCount: 0,
                                AccountsWithBalance: 0,
                                AccountsWithBalancePercent: 0,
                                LastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                            };
                        } else if (docId === 'RevenueThisMonth') {
                            defaultData = {
                                Title: "Revenue This Month",
                                Amount: 0,
                                PercentChange: 0,
                                LastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                            };
                        } else if (docId === 'Last30Days') {
                            defaultData = {
                                Title: "Last 30 Days",
                                Amount: 0,
                                PercentChange: 0,
                                LastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                            };
                        } else if (docId === 'OutstandingBalances') {
                            defaultData = {
                                Title: "Outstanding Balances",
                                Amount: 0,
                                UnpaidInvoices: 0,
                                LastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                            };
                        } else if (docId === 'AccountsWithBalance') {
                            defaultData = {
                                Title: "Accounts with Outstanding Balances",
                                Count: 0,
                                PercentOfTotal: 0,
                                LastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                            };
                        }
                        
                        return collectionRef.doc(docId).set(defaultData);
                    }
                    return Promise.resolve();
                });
        }
        
        // Function to check if Charges-Payments collection exists and initialize if needed
        function checkAndInitializeChargesPayments(studioId) {
            const db = firebase.firestore();
            
            return db.collection(`Studios/${studioId}/Charges-Payments`).doc('RevenueOverview').get()
                .then(doc => {
                    if (!doc.exists) {
                        console.log("Charges-Payments collection not found. Initializing...");
                        return initializeChargesPaymentsCollection(studioId);
                    } else {
                        console.log("Charges-Payments collection already exists");
                        return true;
                    }
                })
                .catch(error => {
                    console.error("Error checking Charges-Payments collection:", error);
                    return false;
                });
        }
        
        // Function to sync the charges data with the revenue documents
        function syncChargesAndRevenue(studioId) {
            console.log("Starting comprehensive sync process for charges and revenue...");
            
            return checkAndInitializeChargesPayments(studioId)
                .then(() => {
                    // First sync family balances to ensure accurate calculations
                    console.log("Step 1: Synchronizing family balances");
                    return syncFamilyBalances(studioId);
                })
                .then(() => {
                    // Then update the AllCharges document
                    console.log("Step 2: Updating AllCharges document");
                    return updateAllChargesDocument(studioId);
                })
                .then(() => {
                    // Finally update revenue documents based on the synced data
                    console.log("Step 3: Updating revenue metrics");
                    return updateRevenueDocuments(studioId);
                })
                .then(() => {
                    console.log("Comprehensive sync completed successfully");
                    return true;
                })
                .catch(error => {
                    console.error("Error in comprehensive sync process:", error);
                    return false;
                });
        }
        
        // Add this new function to ensure the FamilyBalances document exists
        function ensureFamilyBalancesDocumentExists(studioId) {
            const db = firebase.firestore();
            const familyBalancesRef = db.collection(`Studios/${studioId}/Charges-Payments`).doc('FamilyBalances');
            
            return familyBalancesRef.get()
                .then(doc => {
                    if (!doc.exists) {
                        console.log("Creating FamilyBalances document because it doesn't exist");
                        return familyBalancesRef.set({
                            Families: [],
                            LastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    } else {
                        // Make sure the Families array exists
                        const data = doc.data();
                        if (!data.Families) {
                            console.log("Fixing FamilyBalances document - adding missing Families array");
                            return familyBalancesRef.update({
                                Families: [],
                                LastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                            });
                        }
                    }
                    return Promise.resolve();
                })
                .catch(error => {
                    console.error("Error checking/creating FamilyBalances document:", error);
                    return Promise.reject(error);
                });
        }
        
        function loadTuitionRatesData(studioId) {
            console.log('Loading tuition rates data for studio:', studioId);
            
            firebase.firestore().collection('Studios').doc(studioId).collection('RatePlans')
                .get()
                .then(snapshot => {
                    const tuitionRatesTable = document.getElementById('tuitionRatesTable');
                    const tbody = tuitionRatesTable.querySelector('tbody');
                    
                    // Clear existing content
                    tbody.innerHTML = '';
                    
                    if (snapshot.empty) {
                        tbody.innerHTML = '<tr><td colspan="5" class="text-center">No tuition rates found. Create your first rate plan to get started.</td></tr>';
                        return;
                    }
                    
                    snapshot.forEach(doc => {
                        const rateData = doc.data();
                        const rateId = doc.id;
                        
                        // Build hours/rates display string
                        let hoursRatesDisplay = '';
                        if (rateData.HourRates && rateData.HourRates.length > 0) {
                            hoursRatesDisplay = rateData.HourRates.map(hr => 
                                `${hr.Hours} hrs: $${hr.Rate.toFixed(2)}`
                            ).join('<br>');
                        }
                        
                        // Build family discount display
                        let familyDiscountDisplay = 'None';
                        if (rateData.FamilyDiscount) {
                            const discount = rateData.FamilyDiscount;
                            if (discount.Type === 'percentage') {
                                familyDiscountDisplay = `${discount.Amount}% after ${discount.StudentThreshold} student(s)`;
                            } else {
                                familyDiscountDisplay = `$${discount.Amount.toFixed(2)} after ${discount.StudentThreshold} student(s)`;
                            }
                        }
                        
                        // Create a row
                        const row = document.createElement('tr');
                        // Set opacity based on active status
                        row.style.opacity = (rateData.IsActive !== false) ? '1' : '0.6';
                        
                        row.innerHTML = `
                            <td>${rateData.Name || 'Unnamed Rate'}</td>
                            <td>${hoursRatesDisplay}</td>
                            <td>${familyDiscountDisplay}</td>
                            <td>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="activeSwitch-rate-${rateId}" 
                                    ${(rateData.IsActive !== false) ? 'checked' : ''} 
                                    onchange="toggleRateActive('${rateId}', this.checked)">
                                </div>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary me-2" onclick="editTuitionRate('${rateId}')">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteTuitionRate('${rateId}', '${rateData.Name?.replace(/'/g, "\\'")}')">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </td>
                        `;
                        
                        tbody.appendChild(row);
                    });
                })
                .catch(error => {
                    console.error('Error loading tuition rates:', error);
                    const tuitionRatesTable = document.getElementById('tuitionRatesTable');
                    if (tuitionRatesTable) {
                        const tbody = tuitionRatesTable.querySelector('tbody');
                        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Error loading tuition rates. Please try again.</td></tr>';
                    }
                });
        }
        
        function loadFeesData(studioId) {
            // Add validation check for studioId
            if (!studioId) {
                console.error('Studio ID is missing when loading fees');
                return;
            }
            
            console.log('Loading fees data for studio:', studioId);
            
            // Reset search input
            const searchInput = document.getElementById('feeSearchInput');
            if (searchInput) {
                searchInput.value = '';
            }
            
            const feesTableBody = document.querySelector('#feesTable tbody');
            feesTableBody.innerHTML = '<tr><td colspan="6" class="text-center">Loading fees...</td></tr>';
            
            firebase.firestore().collection('Studios').doc(studioId).collection('Fees')
                .orderBy('CreatedAt', 'desc')
                .get()
                .then(snapshot => {
                    if (snapshot.empty) {
                        feesTableBody.innerHTML = '<tr class="text-center text-muted"><td colspan="6">No fees found. Create your first fee to get started.</td></tr>';
                        return;
                    }
                    
                    // Clear the table
                    feesTableBody.innerHTML = '';
                    
                    // Process each fee
                    const promises = [];
                    
                    snapshot.forEach(doc => {
                        const fee = doc.data();
                        fee.id = doc.id;
                        
                        // Format amount and description based on fee type
                        let amountDisplay = `$${fee.Amount.toFixed(2)}`;
                        let typeDescription = fee.FeeType || 'One Time';
                        
                        if (fee.FeeType === 'Recurring') {
                            // Get appropriate time unit based on frequency
                            let timeUnit = 'periods';
                            if (fee.Frequency === 'Weekly') timeUnit = fee.Duration === 1 ? 'week' : 'weeks';
                            else if (fee.Frequency === 'Monthly') timeUnit = fee.Duration === 1 ? 'month' : 'months';
                            else if (fee.Frequency === 'Quarterly') timeUnit = fee.Duration === 1 ? 'quarter' : 'quarters';
                            else if (fee.Frequency === 'Yearly') timeUnit = fee.Duration === 1 ? 'year' : 'years';
                            
                            typeDescription = `${fee.Frequency} for ${fee.Duration} ${timeUnit}`;
                        } else if (fee.FeeType === 'BrokenUp') {
                            typeDescription = `Broken Up (${fee.BrokenUpCount} payments over ${fee.BrokenUpTimeFrame})`;
                            amountDisplay = `$${fee.Amount.toFixed(2)} ($${(fee.BrokenUpAmount || (fee.Amount / fee.BrokenUpCount)).toFixed(2)}  ${fee.BrokenUpCount})`;
                        } else if (fee.FeeType === 'OneTime') {
                            typeDescription = 'One Time';
                        }
                        
                        // Create a promise to resolve the associated item name
                        const promise = getAssociationName(studioId, fee.AssociationType, fee.AssociationItemId)
                            .then(itemName => {
                                // Add row to the table
                                const row = document.createElement('tr');
                                // Set opacity based on active status
                                if (fee.IsActive === false) {
                                    row.style.opacity = '0.6';
                                }
                                
                                row.innerHTML = `
                                    <td>${fee.Name}</td>
                                    <td>${amountDisplay}</td>
                                    <td>${typeDescription}</td>
                                    <td>${fee.AssociationType}: ${itemName}</td>
                                    <td>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" role="switch" 
                                                id="activeSwitch-${fee.id}" 
                                                ${fee.IsActive !== false ? 'checked' : ''}
                                                onchange="toggleFeeActive('${fee.id}', this.checked)">
                                        </div>
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary me-2" onclick="editFee('${fee.id}')">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger" onclick="deleteFee('${fee.id}')">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                `;
                                feesTableBody.appendChild(row);
                            });
                            
                        promises.push(promise);
                    });
                    
                    // Wait for all promises to resolve
                    return Promise.all(promises);
                })
                .catch(error => {
                    console.error('Error loading fees:', error);
                    feesTableBody.innerHTML = '<tr class="text-center text-danger"><td colspan="6">Error loading fees. Please try again.</td></tr>';
                });
        }
        
        function loadDiscountsData(studioId) {
            console.log('Loading discounts data for studio:', studioId);
            
            // Reset search input
            const searchInput = document.getElementById('discountSearchInput');
            if (searchInput) {
                searchInput.value = '';
            }
            
            const discountsTableBody = document.querySelector('#discountsTable tbody');
            discountsTableBody.innerHTML = '<tr><td colspan="6" class="text-center">Loading discounts...</td></tr>';
            
            firebase.firestore().collection('Studios').doc(studioId).collection('Discounts')
                .orderBy('CreatedAt', 'desc')
                .get()
                .then(snapshot => {
                    if (snapshot.empty) {
                        discountsTableBody.innerHTML = '<tr class="text-center text-muted"><td colspan="6">No discounts found. Create your first discount to get started.</td></tr>';
                        return;
                    }
                    
                    // Clear the table
                    discountsTableBody.innerHTML = '';
                    
                    // Process each discount
                    const promises = [];
                    
                    snapshot.forEach(doc => {
                        const discount = doc.data();
                        discount.id = doc.id;
                        
                        // Create a promise to resolve the association name
                        // Pass the full discount data to getAssociationName
                        const promise = getAssociationName(studioId, discount.AssociationType, discount.AssociationItemId, discount)
                            .then(associationName => {
                                // Add row to the table
                                const row = document.createElement('tr');
                                row.style.opacity = discount.IsActive ? '1' : '0.6';
                                
                                // Format the amount display based on discount type
                                const amountDisplay = discount.DiscountType === 'Percentage' 
                                    ? `${discount.Amount}%` 
                                    : `$${discount.Amount.toFixed(2)}`;
                                
                                row.innerHTML = `
                                    <td>${discount.Name}</td>
                                    <td>${amountDisplay}</td>
                                    <td>${discount.DiscountType === 'Percentage' ? 'Percentage' : 'Fixed Amount'}</td>
                                    <td>${discount.AssociationType}: ${associationName}</td>
                                    <td>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" role="switch" 
                                                id="activeSwitch-discount-${discount.id}" 
                                                ${discount.IsActive ? 'checked' : ''}
                                                onchange="toggleDiscountActive('${discount.id}', this.checked)">
                                        </div>
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary me-2" onclick="editDiscount('${discount.id}')">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger" onclick="deleteDiscount('${discount.id}')">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                `;
                                discountsTableBody.appendChild(row);
                            });
                        
                        promises.push(promise);
                    });
                    
                    // Wait for all promises to resolve
                    return Promise.all(promises);
                })
                .catch(error => {
                    console.error('Error loading discounts:', error);
                    discountsTableBody.innerHTML = '<tr class="text-center text-danger"><td colspan="6">Error loading discounts. Please try again.</td></tr>';
                });
        }
        
        // Helper function to get the name of the associated item
        function getAssociationName(studioId, associationType, associationItemId, discountData) {
            if (!associationItemId || !associationType) {
                return Promise.resolve('N/A');
            }
            
            // Special handling for Code type
            if (associationType === 'Code') {
                // Return the DiscountCode field value instead of the associationItemId
                return Promise.resolve(discountData?.DiscountCode || associationItemId);
            }
            
            let collectionPath;
            let nameField = 'Name';
            
            switch (associationType) {
                case 'Student':
                    collectionPath = `Studios/${studioId}/Students`;
                    nameField = 'FirstName'; // We'll use FirstName + LastName for students
                    break;
                case 'Family':
                    collectionPath = `Studios/${studioId}/Families`;
                    nameField = 'LastName'; // Families typically use LastName
                    break;
                case 'Season':
                    collectionPath = `Studios/${studioId}/Seasons`;
                    break;
                default:
                    return Promise.resolve('Unknown');
            }
            
            return firebase.firestore().collection(collectionPath).doc(associationItemId)
                .get()
                .then(doc => {
                    if (doc.exists) {
                        const data = doc.data();
                        // For students, show full name
                        if (associationType === 'Student' && data.FirstName && data.LastName) {
                            return `${data.FirstName} ${data.LastName}`;
                        }
                        return data[nameField] || 'Unnamed';
                    } else {
                        console.warn(`Could not find ${associationType} with ID: ${associationItemId}`);
                        return 'Not found';
                    }
                })
                .catch(error => {
                    console.error(`Error getting ${associationType} name:`, error);
                    return 'Error';
        });
}
        
        // Search discounts function
        function searchDiscounts(query) {
            query = query.toLowerCase().trim();
            
            // Get all rows from the discounts table (excluding any "no results" message row)
            const rows = Array.from(document.querySelectorAll('#discountsTable tbody tr'))
                .filter(row => row.querySelector('td:first-child')); // Only include rows with actual data
            
            let visibleCount = 0;
            
            // If query is empty, show all rows
            if (!query) {
                rows.forEach(row => {
                    row.style.display = '';
                    visibleCount++;
                });
            } else {
                // Otherwise, filter based on content
                rows.forEach(row => {
                    const text = row.textContent.toLowerCase();
                    if (text.includes(query)) {
                        row.style.display = '';
                        visibleCount++;
                    } else {
                        row.style.display = 'none';
                    }
                });
            }
            
            // Update the search result count
            const countDisplay = document.getElementById('discountSearchResultCount');
            if (countDisplay) {
                if (query) {
                    countDisplay.textContent = `Showing ${visibleCount} of ${rows.length} discounts`;
                } else {
                    countDisplay.textContent = '';
                }
            }
            
            // Show a message if no results
            const tableBody = document.querySelector('#discountsTable tbody');
            
            // Remove any existing "no results" message
            const existingNoResults = document.getElementById('noDiscountsResults');
            if (existingNoResults) {
                existingNoResults.remove();
            }
            
            // Add "no results" message if needed
            if (visibleCount === 0 && query) {
                const noResultsRow = document.createElement('tr');
                noResultsRow.id = 'noDiscountsResults';
                noResultsRow.innerHTML = `<td colspan="6" class="text-center text-muted">No discounts matching "${query}"</td>`;
                tableBody.appendChild(noResultsRow);
            }
        }
        
        function loadCreditsData(studioId) {
            console.log('Loading credits data for studio:', studioId);
            
            // Reset search input
            const searchInput = document.getElementById('creditSearchInput');
            if (searchInput) {
                searchInput.value = '';
            }
            
            const creditsTableBody = document.querySelector('#creditsTable tbody');
            creditsTableBody.innerHTML = '<tr><td colspan="5" class="text-center">Loading credits...</td></tr>';
            
            // Load families first to have the data available for the dropdown
            loadFamiliesForCredit(studioId);
            
            firebase.firestore().collection('Studios').doc(studioId).collection('Credits')
                .orderBy('CreatedAt', 'desc')
                .get()
                .then(snapshot => {
                    if (snapshot.empty) {
                        creditsTableBody.innerHTML = '<tr class="text-center text-muted"><td colspan="5">No credits found. Create your first credit to get started.</td></tr>';
                        return;
                    }
                    
                    // Clear the table
                    creditsTableBody.innerHTML = '';
                    
                    // Process each credit
                    const promises = [];
                    
                    snapshot.forEach(doc => {
                        const credit = doc.data();
                        credit.id = doc.id;
                        
                        // Create a promise to resolve the family name
                        const promise = getFamilyName(studioId, credit.FamilyId)
                            .then(familyName => {
                                // Add row to the table
                                const row = document.createElement('tr');
                                
                                row.innerHTML = `
                                    <td>${credit.Name}</td>
                                    <td>$${credit.Amount.toFixed(2)}</td>
                                    <td>${familyName}</td>
                                    <td>${credit.Notes || ''}</td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary me-2" onclick="editCredit('${credit.id}')">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger" onclick="deleteCredit('${credit.id}')">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                `;
                                creditsTableBody.appendChild(row);
                            });
                        
                        promises.push(promise);
                    });
                    
                    // Wait for all promises to resolve
                    return Promise.all(promises);
                })
                .catch(error => {
                    console.error('Error loading credits:', error);
                    creditsTableBody.innerHTML = '<tr class="text-center text-danger"><td colspan="5">Error loading credits. Please try again.</td></tr>';
                });
        }
        
        function loadStudentFamilyMaxData(studioId) {
            console.log('Loading student/family max data for studio:', studioId);
            
            // Get references to UI elements
            const enableToggle = document.getElementById('enableStudentFamilyMax');
            const studentMaxInput = document.getElementById('studentMaxAmount');
            const familyMaxInput = document.getElementById('familyMaxAmount');
            const maxSettingsContainer = document.getElementById('maxSettingsContainer');
            
            // Show loading state
            if (maxSettingsContainer) {
                maxSettingsContainer.style.display = 'none';
            }
            
            // Query Firestore for existing settings
            firebase.firestore().collection(`Studios/${studioId}/StudentFamilyMax`)
                .limit(1)
                .get()
                .then(snapshot => {
                    if (!snapshot.empty) {
                        // Found existing settings
                        const maxData = snapshot.docs[0].data();
                        
                        // Update UI with existing values
                        if (enableToggle) {
                            enableToggle.checked = maxData.IsActive;
                        }
                        
                        if (studentMaxInput) {
                            studentMaxInput.value = maxData.StudentMax || '';
                        }
                        
                        if (familyMaxInput) {
                            familyMaxInput.value = maxData.FamilyMax || '';
                        }
                        
                        // Show settings if enabled
                        if (maxSettingsContainer && maxData.IsActive) {
                            maxSettingsContainer.style.display = 'block';
                        }
                        
                        // Store the document ID for updating later
                        document.getElementById('studentFamilyMaxForm').dataset.docId = snapshot.docs[0].id;
                    } else {
                        // No existing settings
                        if (enableToggle) {
                            enableToggle.checked = false;
                        }
                        
                        if (studentMaxInput) {
                            studentMaxInput.value = '';
                        }
                        
                        if (familyMaxInput) {
                            familyMaxInput.value = '';
                        }
                        
                        // Hide settings container
                        if (maxSettingsContainer) {
                            maxSettingsContainer.style.display = 'none';
                        }
                    }
                })
                .catch(error => {
                    console.error('Error loading student/family max settings:', error);
                    alert('Error loading settings. Please try again.');
                });
        }
        
        // Load options for the association dropdown
        function loadAssociationOptions(associationType, selectedItemId = null) {
            console.log(`Loading ${associationType} options`);
            
            // Try to get either the fee or discount select element
            const associationSelect = document.getElementById('associationItem') || 
                                    document.getElementById('discountAssociationItem');
            
            if (!associationSelect) return;
            
            // Clear the select and show loading
            associationSelect.innerHTML = '<option value="" disabled selected>Loading options...</option>';
            associationSelect.disabled = true;
            
            // Reset search if any
            const searchInput = document.getElementById('associationSearchInput') ||
                               document.getElementById('discountAssociationSearchInput');
            if (searchInput) searchInput.value = '';
            
            // Hide "no results" message
            const noResultsMessage = document.getElementById('noAssociationItemsFound') ||
                                   document.getElementById('noDiscountAssociationItemsFound');
            if (noResultsMessage) noResultsMessage.style.display = 'none';
            
            const studioId = localStorage.getItem('currentStudioId');
            if (!studioId) {
                console.error('No studio ID found');
                associationSelect.innerHTML = '<option value="" disabled selected>Error loading options</option>';
                return;
            }
            
            let collectionPath;
            let nameField;
            let secondaryField = null; // For combined names like LastName + FirstName
            
            switch (associationType) {
                case 'Student':
                    collectionPath = `Studios/${studioId}/Students`;
                    nameField = 'FirstName';
                    secondaryField = 'LastName';
                    console.log('Loading Students from path:', collectionPath); // Debug log
                    break;
                case 'Family':
                    collectionPath = `Studios/${studioId}/Families`;
                    nameField = 'LastName';
                    secondaryField = 'FirstName'; // Include FirstName for families
                    break;
                case 'Season':
                    collectionPath = `Studios/${studioId}/Seasons`;
                    nameField = 'Name';
                    break;
                case 'Class':  // Add support for Class type
                    collectionPath = `Studios/${studioId}/Classes`;
                    nameField = 'ClassName';
                    break;
                default:
                    associationSelect.innerHTML = '<option value="" disabled selected>Unknown association type</option>';
                    associationSelect.disabled = false;
                    return;
            }
            
            firebase.firestore().collection(collectionPath)
                .get()
                .then(snapshot => {
                    if (snapshot.empty) {
                        associationSelect.innerHTML = '<option value="" disabled selected>No items found</option>';
                        associationSelect.disabled = false;
                        return;
                    }
                    
                    // Reset select with default prompt
                    associationSelect.innerHTML = '<option value="" disabled selected>Select an item</option>';
                    
                    // Add all items from the collection
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        const option = document.createElement('option');
                        option.value = doc.id;
                        
                        // Handle name display based on association type
                        if (secondaryField && data[secondaryField]) {
                            if (associationType === 'Family') {
                                // For families, show "LastName, FirstName"
                                option.textContent = `${data[nameField] || 'Unknown'}, ${data[secondaryField] || ''}`;
                            } else {
                                // For students, show "FirstName LastName"
                                option.textContent = `${data[nameField] || ''} ${data[secondaryField] || ''}`;
                            }
                        } else {
                            option.textContent = data[nameField] || 'Unnamed';
                        }
                        
                        // If this is the selected item (for edit mode), mark it as selected
                        if (selectedItemId && doc.id === selectedItemId) {
                            option.selected = true;
                        }
                        
                        associationSelect.appendChild(option);
                    });
                    
                    // Enable the select
                    associationSelect.disabled = false;
                    
                    // Make sure the search functionality is properly initialized
                    initializeAssociationSearch(
                        searchInput?.id || 'associationSearchInput',
                        searchInput?.id === 'discountAssociationSearchInput' ? 'clearDiscountAssociationSearch' : 'clearAssociationSearch'
                    );
                })
                .catch(error => {
                    console.error(`Error loading ${associationType} options:`, error);
                    associationSelect.innerHTML = '<option value="" disabled selected>Error loading options</option>';
                    associationSelect.disabled = false;
                });
        }

// Load options for the discount association dropdown
function loadDiscountAssociationOptions(associationType, selectedItemId = null) {
    console.log(`Loading ${associationType} options for discount`);
    
    const associationSelect = document.getElementById('discountAssociationItem');
    if (!associationSelect) return;
    
    // Clear the select and show loading
    associationSelect.innerHTML = '<option value="" disabled selected>Loading options...</option>';
    associationSelect.disabled = true;
    
    // Reset search if any
    const searchInput = document.getElementById('discountAssociationSearchInput');
    if (searchInput) searchInput.value = '';
    
    // Hide "no results" message
    const noResultsMessage = document.getElementById('noDiscountAssociationItemsFound');
    if (noResultsMessage) noResultsMessage.style.display = 'none';
    
    const studioId = localStorage.getItem('currentStudioId');
    if (!studioId) {
        console.error('No studio ID found');
        associationSelect.innerHTML = '<option value="" disabled selected>Error loading options</option>';
        return;
    }
    
    let collectionPath;
    let nameField;
    let secondaryField = null; // For combined names like LastName + FirstName
    
    switch (associationType) {
        case 'Student':
            collectionPath = `Studios/${studioId}/Students`;
            nameField = 'FirstName';
            secondaryField = 'LastName';
            console.log('Loading Students from path:', collectionPath);
            break;
        case 'Family':
            collectionPath = `Studios/${studioId}/Families`;
            nameField = 'LastName';
            secondaryField = 'FirstName';
            break;
        case 'Season':
            collectionPath = `Studios/${studioId}/Seasons`;
            nameField = 'Name';
            break;
        default:
            associationSelect.innerHTML = '<option value="" disabled selected>Unknown association type</option>';
            associationSelect.disabled = false;
            return;
    }
    
    firebase.firestore().collection(collectionPath)
        .get()
        .then(snapshot => {
            if (snapshot.empty) {
                associationSelect.innerHTML = '<option value="" disabled selected>No items found</option>';
                associationSelect.disabled = false;
                return;
            }
            
            // Reset select with default prompt
            associationSelect.innerHTML = '<option value="" disabled selected>Select an item</option>';
            
            // Add all items from the collection
            snapshot.forEach(doc => {
                const data = doc.data();
                const option = document.createElement('option');
                option.value = doc.id;
                
                // Handle name display based on association type
                if (secondaryField && data[secondaryField]) {
                    if (associationType === 'Family') {
                        // For families, show "LastName, FirstName"
                        option.textContent = `${data[nameField] || 'Unknown'}, ${data[secondaryField] || ''}`;
                    } else {
                        // For students, show "FirstName LastName"
                        option.textContent = `${data[nameField] || ''} ${data[secondaryField] || ''}`;
                    }
                } else {
                    option.textContent = data[nameField] || 'Unnamed';
                }
                
                // If this is the selected item (for edit mode), mark it as selected
                if (selectedItemId && doc.id === selectedItemId) {
                    option.selected = true;
                }
                
                associationSelect.appendChild(option);
            });
            
            // Enable the select
            associationSelect.disabled = false;
            
            // Make sure the search functionality is properly initialized
            initializeDiscountAssociationSearch('discountAssociationSearchInput', 'clearDiscountAssociationSearch');
        })
        .catch(error => {
            console.error(`Error loading ${associationType} options:`, error);
            associationSelect.innerHTML = '<option value="" disabled selected>Error loading options</option>';
            associationSelect.disabled = false;
        });
}


        // Helper function to initialize association search functionality
        function initializeAssociationSearch(searchInputId, clearButtonId) {
            const searchInput = document.getElementById(searchInputId);
            const clearButton = document.getElementById(clearButtonId);
            
            if (searchInput) {
                // Remove any existing event listeners
                searchInput.removeEventListener('input', handleAssociationSearch);
                
                // Add the search event listener
                searchInput.addEventListener('input', handleAssociationSearch);
                
                // Initial filter (if there's already content in the search box)
                if (searchInput.value.trim()) {
                    filterAssociationItems(searchInput.value);
                }
            }
            
            if (clearButton) {
                clearButton.addEventListener('click', function() {
                    if (searchInput) {
                        searchInput.value = '';
                        filterAssociationItems('');
                        searchInput.focus();
                    }
                });
            }
        }

        // Handler for association search
        function handleAssociationSearch() {
            filterAssociationItems(this.value);
        }

        // Function to filter association items in the dropdown
        function filterAssociationItems(query) {
            query = query.toLowerCase().trim();
            
            const associationSelect = document.getElementById('associationItem');
            const noResultsMessage = document.getElementById('noAssociationItemsFound');
            
            if (!associationSelect) return;
            
            let matchCount = 0;
            
            // Get all options (except the first one which is the placeholder)
            const options = Array.from(associationSelect.options).slice(1);
            
            // Show/hide options based on the query
            options.forEach(option => {
                const text = option.textContent.toLowerCase();
                const isMatch = query === '' || text.includes(query);
                
                // Can't hide options directly, so we'll use a custom attribute
                option.style.display = isMatch ? '' : 'none';
                option.setAttribute('data-filtered', isMatch ? 'false' : 'true');
                
                if (isMatch) matchCount++;
            });
            
            // Show/hide the "no results" message
            if (noResultsMessage) {
                noResultsMessage.style.display = (query !== '' && matchCount === 0) ? 'block' : 'none';
            }
            
            console.log(`Association search: ${matchCount} matches for "${query}"`);
        }

       // Load options for the discount association dropdown
function loadAssociationOptionsForDiscount(associationType, selectedItemId = null) {
    loadDiscountAssociationOptions(associationType, selectedItemId);
}




        
        // Save the new fee
        function saveFee() {
            console.log('Save Fee function called');
            
            // Get form values
            const feeName = document.getElementById('feeName').value.trim();
            const feeAmount = parseFloat(document.getElementById('feeAmount').value);
            const feeType = document.getElementById('feeType').value;
            
            // Get the correct association type and ID based on fee type
            let associationType, associationItemId;
            
            // Convert feeType to the correct prefix for IDs
            const typePrefix = feeType.toLowerCase().replace(/\s+/g, '');
            
            // Get the association type and ID using the correct IDs based on fee type
            associationType = document.getElementById(`${typePrefix}AssociationType`).value;
            associationItemId = document.getElementById(`${typePrefix}Association`).value;
            
            console.log('Form values:', { feeName, feeAmount, feeType, associationType, associationItemId });
            
            // Basic validation
            if (!feeName || isNaN(feeAmount) || !feeType || !associationType || !associationItemId) {
                console.log('Validation failed:', { feeName, feeAmount, feeType, associationType, associationItemId });
                alert('Please fill out all required fields');
                return;
            }
            
            // Get the studio ID
            const studioId = currentStudioId;
            
            if (!studioId) {
                console.log('No studio ID found');
                alert('Error: Studio ID not found');
                return;
            }
            
            // Create the base fee object
            const feeData = {
                Name: feeName,
                Amount: feeAmount,
                FeeType: feeType,
                AssociationType: associationType,
                AssociationItemId: associationItemId,
                UpdatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            console.log('Fee data to save:', feeData);
            
            // Reference to the Fees subcollection
            const feesCollectionRef = firebase.firestore().collection('Studios').doc(studioId).collection('Fees');
            
            // Save to Firestore
            feesCollectionRef.add(feeData)
                .then(docRef => {
                    console.log('Fee saved successfully with ID:', docRef.id);
                    
                    // Close the modal and reset form safely
                    const modal = bootstrap.Modal.getInstance(document.getElementById('newFeeModal'));
                    if (modal) {
                        modal.hide();
                        // Wait for modal to finish hiding before resetting form
                        setTimeout(() => {
                            const form = document.getElementById('newFeeForm');
                            if (form) form.reset();
                            
                            // Safely hide containers
                            ['associationItemContainer', 'recurringOptions', 'installmentsOptions'].forEach(id => {
                                const container = document.getElementById(id);
                                if (container) container.style.display = 'none';
                            });
                            
                            // Reload fees data
                            loadFeesData(studioId);
                        }, 300);
                    }
                    
                    // Show success message
                    alert('Fee created successfully!');
                })
                .catch(error => {
                    console.error('Error saving fee:', error);
                    alert('Error creating fee. Please try again.');
                });
        }
        
        // Get the name of the associated item
        function getAssociatedItemName(studioId, associationType, itemId) {
            // Add validation for missing parameters
            if (!studioId || !associationType || !itemId) {
                console.log('Missing required parameters:', { studioId, associationType, itemId });
                return Promise.resolve('Unknown');
            }

            // Determine which collection to query
            let collectionPath;
            let nameField;
            
            switch(associationType) {
                case 'Season':
                    collectionPath = `Studios/${studioId}/Seasons`;
                    nameField = 'Name';
                    break;
                case 'Student':
                    collectionPath = `Studios/${studioId}/Students`;
                    break;
                case 'Family':
                    collectionPath = `Studios/${studioId}/Families`;
                    nameField = 'LastName';
                    break;
                case 'Class':  // Add handling for Class type
                    collectionPath = `Studios/${studioId}/Classes`;
                    nameField = 'ClassName';
                    break;
                default:
                    console.warn('Unknown association type:', associationType);
                    return Promise.resolve('Unknown type');
            }

            console.log('Fetching from path:', collectionPath, 'for ID:', itemId);
            
            // Query Firestore for the item
            return firebase.firestore().collection(collectionPath).doc(itemId).get()
                .then(doc => {
                    if (!doc.exists) {
                        console.warn(`${associationType} document not found:`, itemId);
                        return 'Unknown';
                    }
                    
                    const data = doc.data();
                    
                    if (associationType === 'Student') {
                        return `${data.FirstName} ${data.LastName}`;
                    }
                    
                    return data[nameField] || 'Unnamed';
                })
                .catch(error => {
                    console.error(`Error getting ${associationType} name:`, error);
                    return 'Error';
                });
        }
        
        // Update the editFee function to properly show the modal and load fee data
        function editFee(feeId) {
            console.log('Edit Fee button clicked for fee ID:', feeId);
            
            if (!currentStudioId) {
                alert('Error: Studio ID not found');
                return;
            }
            
            // Get the form and set it to edit mode
            const feeForm = document.getElementById('newFeeForm');
            feeForm.dataset.mode = 'edit';
            feeForm.dataset.feeId = feeId;
            
            // Update modal title and save button
            document.getElementById('newFeeModalLabel').textContent = 'Edit Fee';
            document.getElementById('saveFeeBtn').textContent = 'Update Fee';
            
            // Show loading state in the form
            const formFields = feeForm.querySelectorAll('input, select');
            formFields.forEach(field => {
                field.disabled = true;
            });
            
            try {
                // First show the modal, then load the data
                const modal = new bootstrap.Modal(document.getElementById('newFeeModal'));
                modal.show();
                
                console.log('Modal opened, now fetching fee data...');
                
                // Fetch the fee data
                firebase.firestore().collection('Studios').doc(currentStudioId).collection('Fees').doc(feeId)
                    .get()
                    .then(doc => {
                        if (!doc.exists) {
                            throw new Error('Fee not found');
                        }
                        
                        const fee = doc.data();
                        console.log('Loaded fee data:', fee);
                        
                        // Fill form with fee data
                        document.getElementById('feeName').value = fee.Name || '';
                        document.getElementById('feeAmount').value = fee.Amount || '';
                        document.getElementById('feeType').value = fee.FeeType || '';
                        
                        // Hide all conditional sections first
                        document.getElementById('recurringOptions').style.display = 'none';
                        document.getElementById('installmentsOptions').style.display = 'none';
                        
                        // Show and fill relevant sections based on fee type
                        if (fee.FeeType === 'Recurring') {
                            const recurringOptions = document.getElementById('recurringOptions');
                            recurringOptions.style.display = 'block';
                            
                            document.getElementById('recurringFrequency').value = fee.Frequency || '';
                            document.getElementById('recurringDuration').value = fee.Duration || 1;
                        } else if (fee.FeeType === 'Installments') {
                            const installmentsOptions = document.getElementById('installmentsOptions');
                            installmentsOptions.style.display = 'block';
                            
                            document.getElementById('installmentsCount').value = fee.InstallmentsCount || 2;
                            document.getElementById('installmentsFrequency').value = fee.InstallmentsFrequency || '';
                        }
                        
                        // Enable all form fields
                        const formFields = feeForm.querySelectorAll('input, select');
                        formFields.forEach(field => {
                            field.disabled = false;
                        });
                    })
                    .catch(error => {
                        console.error('Error loading fee:', error);
                        alert('Error loading fee. Please try again.');
                        modal.hide();
                    });
            } catch (error) {
                console.error('Error in editFee:', error);
                alert('Error loading fee. Please try again.');
            }
        }
        
        // Update saveFee function to handle both creation and updates
        function saveFee() {
            console.log('Save Fee function called');
            
            // Get form values
            const feeName = document.getElementById('feeName').value.trim();
            const feeAmount = parseFloat(document.getElementById('feeAmount').value);
            const feeType = document.getElementById('feeType').value;
            
            // Get the correct association type and ID based on fee type
            let associationType, associationItemId;
            
            // Convert feeType to the correct prefix for IDs
            const typePrefix = feeType.toLowerCase().replace(/\s+/g, '');
            
            // Get the association type and ID using the correct IDs based on fee type
            associationType = document.getElementById(`${typePrefix}AssociationType`).value;
            associationItemId = document.getElementById(`${typePrefix}Association`).value;
            
            console.log('Form values:', { feeName, feeAmount, feeType, associationType, associationItemId });
            
            // Basic validation
            if (!feeName || isNaN(feeAmount) || !feeType || !associationType || !associationItemId) {
                console.log('Validation failed:', { feeName, feeAmount, feeType, associationType, associationItemId });
                alert('Please fill out all required fields');
                return;
            }
            
            // Get the studio ID
            const studioId = currentStudioId;
            
            if (!studioId) {
                console.log('No studio ID found');
                alert('Error: Studio ID not found');
                return;
            }
            
            // Create the base fee object
            const feeData = {
                Name: feeName,
                Amount: feeAmount,
                FeeType: feeType,
                AssociationType: associationType,
                AssociationItemId: associationItemId,
                UpdatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            console.log('Fee data to save:', feeData);
            
            // Reference to the Fees subcollection
            const feesCollectionRef = firebase.firestore().collection('Studios').doc(studioId).collection('Fees');
            
            // Check if we're creating a new fee or updating an existing one
            const feeForm = document.getElementById('newFeeForm');
            const isEditMode = feeForm.dataset.mode === 'edit';
            
            let saveOperation;
            
            if (isEditMode) {
                const feeId = feeForm.dataset.feeId;
                console.log('Updating fee:', feeId);
                
                // When updating, we don't want to overwrite IsActive or CreatedAt
                delete feeData.IsActive;
                delete feeData.CreatedAt;
                
                saveOperation = feesCollectionRef.doc(feeId).update(feeData);
            } else {
                console.log('Creating new fee');
                
                // For new fees, set default values
                feeData.IsActive = true;
                feeData.CreatedAt = firebase.firestore.FieldValue.serverTimestamp();
                
                saveOperation = feesCollectionRef.add(feeData);
            }
            
            // Execute the save operation
            saveOperation
                .then(result => {
                    console.log(isEditMode ? 'Fee updated' : `Fee created with ID: ${result.id}`);
                    
                    // Close the modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('newFeeModal'));
                    modal.hide();
                    
                    // Reset the form and its state
                    feeForm.reset();
                    feeForm.dataset.mode = 'create';
                    feeForm.dataset.feeId = '';
                    document.getElementById('newFeeModalLabel').textContent = 'Create New Fee';
                    document.getElementById('saveFeeBtn').textContent = 'Save Fee';
                    
                    // Hide the conditional containers
                    document.getElementById('associationItemContainer').style.display = 'none';
                    document.getElementById('recurringOptions').style.display = 'none';
                    document.getElementById('installmentsOptions').style.display = 'none';
                    
                    // Reload fees data
                    loadFeesData(studioId);
                    
                    // Show success message
                    alert(isEditMode ? 'Fee updated successfully!' : 'Fee created successfully!');
                })
                .catch(error => {
                    console.error(isEditMode ? 'Error updating fee:' : 'Error creating fee:', error);
                    alert(isEditMode ? 'Error updating fee. Please try again.' : 'Error creating fee. Please try again.');
                });
        }
        
        // Add this function to reset the form when the modal is closed
        function resetFeeForm() {
            console.log('Resetting fee form to clean state');
            
            // Get the form element
            const feeForm = document.getElementById('newFeeForm');
            if (!feeForm) {
                console.log('Form not found');
                return;
            }
            
            // Reset the actual form inputs
            feeForm.reset();
            
            // Reset data attributes
            feeForm.dataset.mode = 'create';
            feeForm.dataset.feeId = '';
            
            // Safely update modal elements
            const modalLabel = document.getElementById('newFeeModalLabel');
            const saveBtn = document.getElementById('saveFeeBtn');
            if (modalLabel) modalLabel.textContent = 'Create New Fee';
            if (saveBtn) saveBtn.textContent = 'Save Fee';
            
            // Safely hide all conditional sections
            ['associationItemContainer', 'recurringOptions', 'installmentsOptions', 'endDateSection'].forEach(id => {
                const element = document.getElementById(id);
                if (element) element.style.display = 'none';
            });
            
            // Safely reset end date fields
            const hasEndDateCheckbox = document.getElementById('hasEndDate');
            const feeEndDateInput = document.getElementById('feeEndDate');
            if (hasEndDateCheckbox) hasEndDateCheckbox.checked = false;
            if (feeEndDateInput) feeEndDateInput.value = '';
            
            // Safely reset association search
            const searchInput = document.getElementById('associationSearchInput');
            const noItemsFound = document.getElementById('noAssociationItemsFound');
            if (searchInput) searchInput.value = '';
            if (noItemsFound) noItemsFound.style.display = 'none';
            
            // Enable all form fields
            const formFields = feeForm.querySelectorAll('input, select');
            formFields.forEach(field => {
                field.disabled = false;
            });
        }
        
        function deleteFee(feeId) {
            if (confirm('Are you sure you want to delete this fee?')) {
                console.log('Delete fee:', feeId);
                
                firebase.firestore().collection('Studios').doc(currentStudioId).collection('Fees').doc(feeId).delete()
                    .then(() => {
                        alert('Fee deleted successfully!');
                        loadFeesData(currentStudioId);
                    })
                    .catch(error => {
                        console.error('Error deleting fee:', error);
                        alert('Error deleting fee. Please try again.');
                    });
            }
        }

        // Add function to toggle fee active status
        function toggleFeeActive(feeId, isActive) {
            if (!currentStudioId) {
                alert('Error: Studio ID not found');
                return;
            }
            
            // Show loading state
            const switchElement = document.getElementById(`activeSwitch-${feeId}`);
            if (switchElement) {
                switchElement.disabled = true;
            }
            
            // Update the fee document
            firebase.firestore().collection('Studios').doc(currentStudioId).collection('Fees').doc(feeId)
                .update({
                    IsActive: isActive,
                    UpdatedAt: firebase.firestore.FieldValue.serverTimestamp()
                })
                .then(() => {
                    console.log(`Fee ${feeId} active status updated to ${isActive}`);
                    
                    // Update the visual appearance of the row
                    const row = switchElement.closest('tr');
                    if (row) {
                        row.style.opacity = isActive ? '1' : '0.6';
                    }
                    
                    // Re-enable the switch
                    if (switchElement) {
                        switchElement.disabled = false;
                    }
                })
                .catch(error => {
                    console.error('Error updating fee active status:', error);
                    alert('Error updating fee status. Please try again.');
                    
                    // Revert the switch to original state
                    if (switchElement) {
                        switchElement.checked = !isActive;
                        switchElement.disabled = false;
                    }
                });
        }

        // Updated search function without highlighting
        function searchFees(query) {
            query = query.toLowerCase().trim();
            
            // Get all rows from the fees table (excluding any "no results" message row)
            const rows = Array.from(document.querySelectorAll('#feesTable tbody tr'))
                .filter(row => row.id !== 'noFeesResults');
            
            let matchCount = 0;
            
            // Show/hide rows based on the search query
            rows.forEach(row => {
                // Don't search in hidden elements like buttons
                const searchableText = Array.from(row.querySelectorAll('td'))
                    .map(td => td.textContent.trim())
                    .join(' ')
                    .toLowerCase();
                
                const isMatch = query === '' || searchableText.includes(query);
                
                if (isMatch) {
                    row.style.display = '';
                    matchCount++;
                } else {
                    row.style.display = 'none';
                }
            });
            
            // Handle the no results message
            const tbody = document.querySelector('#feesTable tbody');
            let noResultsRow = document.getElementById('noFeesResults');
            
            if (query !== '' && matchCount === 0) {
                if (!noResultsRow) {
                    noResultsRow = document.createElement('tr');
                    noResultsRow.id = 'noFeesResults';
                    noResultsRow.innerHTML = `<td colspan="6" class="text-center text-muted">No fees found matching "${query}"</td>`;
                    tbody.appendChild(noResultsRow);
                } else {
                    noResultsRow.innerHTML = `<td colspan="6" class="text-center text-muted">No fees found matching "${query}"</td>`;
                    noResultsRow.style.display = '';
                }
            } else if (noResultsRow) {
                noResultsRow.style.display = 'none';
            }
            
            // Update UI to show how many results were found
            const resultCount = document.getElementById('searchResultCount');
            if (resultCount) {
                if (query === '') {
                    resultCount.textContent = '';
                } else {
                    resultCount.textContent = `${matchCount} result${matchCount !== 1 ? 's' : ''} found`;
                }
            }
            
            console.log(`Search for "${query}" found ${matchCount} matches`);
        }

        // Save the discount
        function saveDiscount() {
            // Get form data
            const name = document.getElementById('discountName').value.trim();
            const type = document.getElementById('discountType').value;
            const amount = parseFloat(document.getElementById('discountAmount').value);
            const associationType = document.getElementById('discountAssociation').value;
            
            // Validate data
            if (!name || !type || isNaN(amount) || amount <= 0 || !associationType) {
                alert('Please fill out all required fields with valid values.');
                return;
            }
            // Get association item ID based on type
            let associationItemId = '';
            if (associationType === 'Code') {
                associationItemId = document.getElementById('discountCode').value.trim();
                if (!associationItemId) {
                    alert('Please enter a discount code.');
                    return;
                }
            } else {
                const associationSelect = document.getElementById('discountAssociationItem');
                if (!associationSelect.value) {
                    alert(`Please select a ${associationType.toLowerCase()} to associate with this discount.`);
                    return;
                }
                associationItemId = associationSelect.value;
            }
            
            // Check if we're editing or creating
            const discountForm = document.getElementById('newDiscountForm');
            const isEditMode = discountForm.dataset.mode === 'edit';
            const discountId = isEditMode ? discountForm.dataset.discountId : null;
            
            console.log(isEditMode ? 'Updating discount' : 'Creating new discount');
            
            // Create discount object
            const discount = {
                Name: name,
                DiscountType: type,
                Amount: amount,
                AssociationType: associationType,
                AssociationItemId: associationItemId,
                IsActive: true,
                UpdatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            // If it's a discount code, store the code in a separate field
            if (associationType === 'Code') {
                discount.DiscountCode = associationItemId;
            }
            
            // Only set CreatedAt for new discounts
            if (!isEditMode) {
                discount.CreatedAt = firebase.firestore.FieldValue.serverTimestamp();
            }
            
            // Get the current studio ID
            const studioId = localStorage.getItem('currentStudioId');
            if (!studioId) {
                alert('Error: Studio ID not found');
                return;
            }
            
            // Reference to the discounts collection
            const discountsRef = firebase.firestore().collection('Studios').doc(studioId).collection('Discounts');
            
            // Save to Firestore - either update existing or create new
            let savePromise;
            if (isEditMode && discountId) {
                // Update existing discount
                savePromise = discountsRef.doc(discountId).update(discount);
            } else {
                // Create new discount
                savePromise = discountsRef.add(discount);
            }
            
            // Handle the result
            savePromise
                .then(result => {
                    console.log(isEditMode ? 
                        `Discount updated with ID: ${discountId}` : 
                        `Discount created with ID: ${result.id}`);
                    
                    // Close the modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('newDiscountModal'));
                    if (modal) modal.hide();
                    
                    // Reload discounts table
                    loadDiscountsData(studioId);
                    
                    // Show success alert
                    alert(isEditMode ? 'Discount updated successfully!' : 'Discount created successfully!');
                    
                    // Reset the form
                    resetDiscountForm();
                })
                .catch(error => {
                    console.error(`Error ${isEditMode ? 'updating' : 'creating'} discount:`, error);
                    alert(`Error ${isEditMode ? 'updating' : 'creating'} discount. Please try again.`);
                });
        }

        function resetDiscountForm() {
            // Reset form fields
            const form = document.getElementById('newDiscountForm');
            if (form) form.reset();
            
            // Add these new lines to reset form dataset
            const discountForm = document.getElementById('newDiscountForm');
            if (discountForm) {
                discountForm.dataset.mode = 'create';
                discountForm.dataset.discountId = '';
            }
            
            // Reset association display
            const associationContainer = document.getElementById('discountAssociationItemContainer');
            if (associationContainer) associationContainer.style.display = 'none';
            
            const codeContainer = document.getElementById('discountCodeContainer');
            if (codeContainer) codeContainer.style.display = 'none';
            
            // Reset discount type display
            const percentageSymbol = document.querySelector('.percentage-symbol');
            const fixedSymbol = document.querySelector('.fixed-symbol');
            const discountPrefix = document.getElementById('discountPrefix');
            
            if (percentageSymbol) percentageSymbol.style.display = 'none';
            if (fixedSymbol) fixedSymbol.style.display = 'inline';
            if (discountPrefix) discountPrefix.textContent = '$';
            
            // Reset modal title
            const modalTitle = document.getElementById('newDiscountModalLabel');
            if (modalTitle) modalTitle.textContent = 'Create New Discount';
            
            // Reset save button
            const saveButton = document.getElementById('saveDiscountBtn');
            if (saveButton) {
                saveButton.textContent = 'Save Discount';
                saveButton.dataset.mode = 'create';
                saveButton.dataset.id = '';
            }
        }

        // Update the editDiscount function to correctly handle all association types
        function editDiscount(discountId) {
            console.log('Edit discount:', discountId);
            
            if (!currentStudioId) {
                alert('Error: Studio ID not found');
                return;
            }
            
            // Set a flag on the form to indicate we're editing
            const discountForm = document.getElementById('newDiscountForm');
            discountForm.dataset.mode = 'edit';
            discountForm.dataset.discountId = discountId;
            
            // Change modal title
            const modalTitle = document.getElementById('newDiscountModalLabel');
            if (modalTitle) modalTitle.textContent = 'Edit Discount';
            
            // Change save button text
            const saveButton = document.getElementById('saveDiscountBtn');
            if (saveButton) saveButton.textContent = 'Update Discount';
            
            // Show loading state in the form
            const formFields = discountForm.querySelectorAll('input, select');
            formFields.forEach(field => {
                field.disabled = true;
            });
            
            try {
                // First show the modal, then load the data
                const modal = new bootstrap.Modal(document.getElementById('newDiscountModal'));
                modal.show();
                
                // Get the discount data
                firebase.firestore().collection('Studios').doc(currentStudioId).collection('Discounts').doc(discountId)
                    .get()
                    .then(doc => {
                        if (!doc.exists) {
                            throw new Error('Discount not found');
                        }
                        
                        const discount = doc.data();
                        
                        // Fill form with discount data
                        const nameInput = document.getElementById('discountName');
                        const typeSelect = document.getElementById('discountType');
                        const amountInput = document.getElementById('discountAmount');
                        const associationSelect = document.getElementById('discountAssociation');
                      
                        
                        if (nameInput) nameInput.value = discount.Name || '';
                        if (typeSelect) typeSelect.value = discount.DiscountType || '';
                        if (amountInput) amountInput.value = discount.Amount || '';
                      
                        
                        // Update UI for discount type (percentage or fixed)
                        const percentageSymbol = document.querySelector('.percentage-symbol');
                        const fixedSymbol = document.querySelector('.fixed-symbol');
                        const discountPrefix = document.getElementById('discountPrefix');
                        
                        if (discount.DiscountType === 'Percentage') {
                            if (percentageSymbol) percentageSymbol.style.display = 'inline';
                            if (fixedSymbol) fixedSymbol.style.display = 'none';
                            if (discountPrefix) discountPrefix.textContent = '';
                        } else {
                            if (percentageSymbol) percentageSymbol.style.display = 'none';
                            if (fixedSymbol) fixedSymbol.style.display = 'inline';
                            if (discountPrefix) discountPrefix.textContent = '$';
                        }
                        
                        // Handle association fields
                        if (associationSelect) {
                            associationSelect.value = discount.AssociationType || '';
                            
                            // Show appropriate container
                            const associationContainer = document.getElementById('discountAssociationItemContainer');
                            const codeContainer = document.getElementById('discountCodeContainer');
                            
                            if (discount.AssociationType === 'Code') {
                                // For Code type, show code input
                                if (codeContainer) codeContainer.style.display = 'block';
                                if (associationContainer) associationContainer.style.display = 'none';
                                
                                // Set the code value
                                const codeInput = document.getElementById('discountCode');
                                if (codeInput) codeInput.value = discount.DiscountCode || discount.AssociationItemId || '';
                            } else {
                                // For other types, show association dropdown
                                if (associationContainer) associationContainer.style.display = 'block';
                                if (codeContainer) codeContainer.style.display = 'none';
                                
                                // Load association options and select the right one
                                loadDiscountAssociationOptions(discount.AssociationType, discount.AssociationItemId);
                            }
                        }
                        
                        // Re-enable form fields
                        formFields.forEach(field => {
                            field.disabled = false;
                        });
                    })
                    .catch(error => {
                        console.error('Error loading discount for editing:', error);
                        alert('Error loading discount data. Please try again.');
                        
                        // Re-enable form fields
                        formFields.forEach(field => {
                            field.disabled = false;
                        });
                    });
            } catch (error) {
                console.error('Error showing discount edit modal:', error);
                alert('Error opening edit form. Please try again.');
            }
        }

        // Add this after your existing discount functions
document.addEventListener('DOMContentLoaded', function() {
    // Reset form when modal is hidden
    const discountModal = document.getElementById('newDiscountModal');
    if (discountModal) {
        discountModal.addEventListener('hidden.bs.modal', function() {
            console.log('Discount modal hidden - resetting form for next use');
            resetDiscountForm();
        });
    }
});


        // Add a helper function to load association options for editing
        function loadDiscountAssociationOptions(associationType, selectedItemId) {
            if (!currentStudioId || !associationType) return;
            
            const associationSelect = document.getElementById('discountAssociationItem');
            if (!associationSelect) return;
            
            // Clear and disable the dropdown while loading
            associationSelect.innerHTML = '<option value="" disabled selected>Loading options...</option>';
            associationSelect.disabled = true;
            
            let collectionPath;
            let labelField = 'Name';
            
            switch (associationType) {
                case 'Student':
                    collectionPath = `Studios/${currentStudioId}/Students`;
                    labelField = ['FirstName', 'LastName']; // We'll combine these
                    break;
                case 'Family':
                    collectionPath = `Studios/${currentStudioId}/Families`;
                    labelField = ['FirstName', 'LastName']; // We'll combine these
                    break;
                case 'Season':
                    collectionPath = `Studios/${currentStudioId}/Seasons`;
                    break;
                case 'Code':
                    // Handle discount code case
                    break;
                default:
                    associationSelect.innerHTML = '<option value="" disabled selected>No options available</option>';
                    return;
            }
            
            // Query the collection to get options
            firebase.firestore().collection(collectionPath)
                .get()
                .then(snapshot => {
                    // Reset options with default
                    associationSelect.innerHTML = '<option value="" disabled selected>Select an item</option>';
                    
                    if (snapshot.empty) {
                        associationSelect.innerHTML += '<option value="" disabled>No items found</option>';
                        return;
                    }
                    
                    // Add options for each document
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        const id = doc.id;
                        
                        let optionText;
                        if (Array.isArray(labelField)) {
                            // For combined fields like FirstName + LastName
                            optionText = labelField.map(field => data[field] || '').filter(Boolean).join(' ');
                        } else {
                            optionText = data[labelField] || 'Unnamed';
                        }
                        
                        const option = document.createElement('option');
                        option.value = id;
                        option.textContent = optionText;
                        option.selected = (id === selectedItemId);
                        associationSelect.appendChild(option);
                    });
                    
                    // Enable the dropdown
                    associationSelect.disabled = false;
                    
                    // Make sure the search functionality is properly initialized
                    initializeAssociationSearch('discountAssociationSearchInput', 'clearDiscountAssociationSearch');
                })
                .catch(error => {
                    console.error(`Error loading ${associationType} options:`, error);
                    associationSelect.innerHTML = '<option value="" disabled selected>Error loading options</option>';
                });
        }

        // Delete discount
        function deleteDiscount(discountId) {
            if (confirm('Are you sure you want to delete this discount?')) {
                console.log('Delete discount:', discountId);
                
                firebase.firestore().collection('Studios').doc(currentStudioId).collection('Discounts').doc(discountId).delete()
                    .then(() => {
                        alert('Discount deleted successfully!');
                        loadDiscountsData(currentStudioId);
                    })
                    .catch(error => {
                        console.error('Error deleting discount:', error);
                        alert('Error deleting discount. Please try again.');
                    });
            }
        }

        // Toggle discount active status
        function toggleDiscountActive(discountId, isActive) {
            if (!currentStudioId) {
                alert('Error: Studio ID not found');
                return;
            }
            
            // Show loading state
            const switchElement = document.getElementById(`activeSwitch-discount-${discountId}`);
            if (switchElement) {
                switchElement.disabled = true;
            }
            
            // Update the discount document
            firebase.firestore().collection('Studios').doc(currentStudioId).collection('Discounts').doc(discountId)
                .update({
                    IsActive: isActive,
                    UpdatedAt: firebase.firestore.FieldValue.serverTimestamp()
                })
                .then(() => {
                    console.log(`Discount ${discountId} active status updated to ${isActive}`);
                    
                    // Update the visual appearance of the row
                    const row = switchElement.closest('tr');
                    if (row) {
                        row.style.opacity = isActive ? '1' : '0.6';
                    }
                    
                    // Re-enable the switch
                    if (switchElement) {
                        switchElement.disabled = false;
                    }
                })
                .catch(error => {
                    console.error('Error updating discount active status:', error);
                    alert('Error updating discount status. Please try again.');
                    
                    // Revert the switch to original state
                    if (switchElement) {
                        switchElement.checked = !isActive;
                        switchElement.disabled = false;
                    }
                });
        }

        // Search discounts function
        function searchDiscounts(query) {
            query = query.toLowerCase().trim();
            
            // Get all rows from the discounts table (excluding any "no results" message row)
            const rows = Array.from(document.querySelectorAll('#discountsTable tbody tr'))
                .filter(row => row.querySelector('td:first-child')); // Only include rows with actual data
            
            let visibleCount = 0;
            
            // If query is empty, show all rows
            if (!query) {
                rows.forEach(row => {
                    row.style.display = '';
                    visibleCount++;
                });
            } else {
                // Otherwise, filter based on content
                rows.forEach(row => {
                    const text = row.textContent.toLowerCase();
                    if (text.includes(query)) {
                        row.style.display = '';
                        visibleCount++;
                    } else {
                        row.style.display = 'none';
                    }
                });
            }
            
            // Update the search result count
            const countDisplay = document.getElementById('discountSearchResultCount');
            if (countDisplay) {
                if (query) {
                    countDisplay.textContent = `Showing ${visibleCount} of ${rows.length} discounts`;
                } else {
                    countDisplay.textContent = '';
                }
            }
            
            // Show a message if no results
            const tableBody = document.querySelector('#discountsTable tbody');
            
            // Remove any existing "no results" message
            const existingNoResults = document.getElementById('noDiscountsResults');
            if (existingNoResults) {
                existingNoResults.remove();
            }
            
            // Add "no results" message if needed
            if (visibleCount === 0 && query) {
                const noResultsRow = document.createElement('tr');
                noResultsRow.id = 'noDiscountsResults';
                noResultsRow.innerHTML = `<td colspan="6" class="text-center text-muted">No discounts matching "${query}"</td>`;
                tableBody.appendChild(noResultsRow);
            }
        }

        // Add this to initializeFeesTab function
        // Set up association item search
        const associationSearchInput = document.getElementById('associationSearchInput');
        if (associationSearchInput) {
            associationSearchInput.addEventListener('input', function() {
                filterAssociationItems(this.value, 'associationItem', 'noAssociationItemsFound');
            });
        }

        // Add this to initializeDiscountsTab function
        // Set up association item search
        const discountAssociationSearchInput = document.getElementById('discountAssociationSearchInput');
        if (discountAssociationSearchInput) {
            discountAssociationSearchInput.addEventListener('input', function() {
                filterAssociationItems(this.value, 'discountAssociationItem', 'noDiscountAssociationItemsFound');
            });
        }

        // Add this new function to filter dropdown options
        function filterAssociationItems(query, dropdownId, noResultsId) {
            query = query.toLowerCase().trim();
            const dropdown = document.getElementById(dropdownId);
            const noResultsMessage = document.getElementById(noResultsId);
            let matchCount = 0;
            
            // Skip the first option (which is the placeholder "Select an item")
            const options = Array.from(dropdown.options).slice(1);
            
            options.forEach(option => {
                const text = option.textContent.toLowerCase();
                if (query === '' || text.includes(query)) {
                    option.style.display = '';
                    matchCount++;
                } else {
                    option.style.display = 'none';
                }
            });
            
            // Show/hide no results message
            if (noResultsMessage) {
                noResultsMessage.style.display = query !== '' && matchCount === 0 ? 'block' : 'none';
            }
            
            console.log(`Association search for "${query}" found ${matchCount} matches`);
        }

        // Load families for credit dropdown
        function loadFamiliesForCredit(studioId) {
            const dropdown = document.getElementById('creditFamily');
            
            // Reset the search input
            const searchInput = document.getElementById('creditFamilySearchInput');
            if (searchInput) {
                searchInput.value = '';
            }
            
            // Reset the no results message
            const noResultsMessage = document.getElementById('noCreditFamiliesFound');
            if (noResultsMessage) {
                noResultsMessage.style.display = 'none';
            }
            
            dropdown.innerHTML = '<option value="" selected disabled>Loading families...</option>';
            
            firebase.firestore().collection(`Studios/${studioId}/Families`)
                .orderBy('LastName')
                .get()
                .then(snapshot => {
                    if (snapshot.empty) {
                        dropdown.innerHTML = '<option value="" selected disabled>No families found</option>';
                        return;
                    }
                    
                    // Clear loading message
                    dropdown.innerHTML = '<option value="" selected disabled>Select a family</option>';
                    
                    // Add each family to the dropdown
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        const id = doc.id;
                        const displayName = `${data.FirstName || ''} ${data.LastName || ''}`.trim() || 'Unnamed Family';
                        
                        const option = document.createElement('option');
                        option.value = id;
                        option.textContent = displayName;
                        dropdown.appendChild(option);
                    });
                    
                    // Enable the dropdown
                    dropdown.disabled = false;
                })
                .catch(error => {
                    console.error('Error loading families:', error);
                    dropdown.innerHTML = '<option value="" selected disabled>Error loading families</option>';
                });
        }

        // Filter family options in the dropdown
        function filterFamilyOptions(query) {
            query = query.toLowerCase().trim();
            const dropdown = document.getElementById('creditFamily');
            const noResultsMessage = document.getElementById('noCreditFamiliesFound');
            let matchCount = 0;
            
            // Skip the first option (which is the placeholder "Select a family")
            const options = Array.from(dropdown.options).slice(1);
            
            options.forEach(option => {
                const text = option.textContent.toLowerCase();
                if (query === '' || text.includes(query)) {
                    option.style.display = '';
                    matchCount++;
                } else {
                    option.style.display = 'none';
                }
            });
            
            // Show/hide no results message
            if (noResultsMessage) {
                noResultsMessage.style.display = query !== '' && matchCount === 0 ? 'block' : 'none';
            }
            
            console.log(`Family search for "${query}" found ${matchCount} matches`);
        }

        // Get family name by ID
        function getFamilyName(studioId, familyId) {
            return firebase.firestore().collection(`Studios/${studioId}/Families`).doc(familyId)
                .get()
                .then(doc => {
                    if (!doc.exists) return 'Unknown Family';
                    return `${doc.data().FirstName || ''} ${doc.data().LastName || ''}`.trim() || 'Unnamed Family';
                })
                .catch(error => {
                    console.error('Error getting family name:', error);
                    return 'Error loading family';
                });
        }

        // Update saveCredit function to handle edit mode properly
        function saveCredit() {
            // Get form values
            const creditName = document.getElementById('creditName').value.trim();
            const creditAmount = parseFloat(document.getElementById('creditAmount').value);
            const familyId = document.getElementById('creditFamily').value;
            const notes = document.getElementById('creditNotes').value.trim();
            
            // Basic validation
            if (!creditName || isNaN(creditAmount) || !familyId) {
                alert('Please fill out all required fields');
                return;
            }
            
            // Get the studio ID
            const studioId = currentStudioId;
            
            if (!studioId) {
                alert('Error: Studio ID not found');
                return;
            }
            
            // Get the form mode (create or edit)
            const creditForm = document.getElementById('newCreditForm');
            const isEditMode = creditForm.dataset.mode === 'edit';
            const creditId = creditForm.dataset.creditId;
            
            // Create the credit object
            const creditData = {
                Name: creditName,
                Amount: creditAmount,
                FamilyId: familyId,
                Notes: notes,
                UpdatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            // References
            const creditsCollectionRef = firebase.firestore().collection('Studios').doc(studioId).collection('Credits');
            const familyRef = firebase.firestore().collection('Studios').doc(studioId).collection('Families').doc(familyId);
            
            // Start a transaction to ensure data consistency
            firebase.firestore().runTransaction(async (transaction) => {
                // If editing, we need to get the original credit to compare amounts
                let originalCredit = null;
                let originalCreditAmount = 0;
                
                if (isEditMode) {
                    const creditDoc = await transaction.get(creditsCollectionRef.doc(creditId));
                    if (!creditDoc.exists) {
                        throw new Error('Original credit not found');
                    }
                    originalCredit = creditDoc.data();
                    originalCreditAmount = originalCredit.Amount || 0;
                }
                
                // Get the family document
                const familyDoc = await transaction.get(familyRef);
                if (!familyDoc.exists) {
                    throw new Error('Family not found');
                }
                
                const familyData = familyDoc.data();
                let currentCharges = familyData.Charges || [];
                let currentBalance = familyData.Balance || 0;
                
                if (isEditMode) {
                    // For edit mode, we need to find and update the existing charge
                    // Look for a charge with matching description and type
                    const chargeIndex = currentCharges.findIndex(charge => 
                        charge.Type === "Credit" && 
                        charge.Description === originalCredit.Name &&
                        Math.abs(charge.Amount) === Math.abs(originalCreditAmount));
                    
                    if (chargeIndex >= 0) {
                        // Found the original charge - update it
                        const amountDifference = originalCreditAmount - creditAmount;
                        
                        // Update the charge
                        currentCharges[chargeIndex] = {
                            Amount: -creditAmount, // Negative amount for credits
                            ChargeDate: new Date().toISOString(),
                            Description: creditName,
                            Status: "Completed",
                            Type: "Credit"
                        };
                        
                        // Adjust balance for the difference only
                        currentBalance += amountDifference;
                    } else {
                        // If we couldn't find the original charge, adjust the balance as if adding new
                        currentBalance += originalCreditAmount; // Remove effect of original credit
                        currentBalance -= creditAmount;  // Apply new credit
                        
                        // Add a note about this in the family document
                        console.warn(`Could not find original credit charge for ${originalCredit.Name}. Applied full adjustment.`);
                    }
                    
                    // Update the credit document
                    transaction.update(creditsCollectionRef.doc(creditId), creditData);
                } else {
                    // For new credits, create a new charge
                    const chargeData = {
                        Amount: -creditAmount, // Negative amount to reduce balance
                        ChargeDate: new Date().toISOString(),
                        Description: creditName,
                        Status: "Completed",
                        Type: "Credit"
                    };
                    
                    // Add the new charge and update balance
                    currentCharges.push(chargeData);
                    currentBalance -= creditAmount;
                    
                    // Add the credit document
                    const newCreditRef = creditsCollectionRef.doc();
                    creditData.CreatedAt = firebase.firestore.FieldValue.serverTimestamp();
                    transaction.set(newCreditRef, creditData);
                }
                
                // Update the family document
                transaction.update(familyRef, {
                    Charges: currentCharges,
                    Balance: currentBalance,
                    UpdatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            })
            .then(() => {
                console.log(isEditMode ? 'Credit updated' : 'Credit created successfully');
                
                // Close the modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('newCreditModal'));
                modal.hide();
                
                // Reset the form
                resetCreditForm();
                
                // Reload credits data
                loadCreditsData(studioId);
                
                // Show success message
                alert(isEditMode ? 'Credit updated and family balance adjusted!' : 'Credit created and family balance adjusted!');
            })
            .catch(error => {
                console.error(isEditMode ? 'Error updating credit:' : 'Error creating credit:', error);
                alert(isEditMode ? 'Error updating credit. Please try again.' : 'Error creating credit. Please try again.');
            });
        }

        // Edit credit
        function editCredit(creditId) {
            console.log('Edit credit:', creditId);
            
            if (!currentStudioId) {
                alert('Error: Studio ID not found');
                return;
            }
            
            // Set a flag on the form to indicate we're editing
            const creditForm = document.getElementById('newCreditForm');
            creditForm.dataset.mode = 'edit';
            creditForm.dataset.creditId = creditId;
            
            // Change modal title
            document.getElementById('newCreditModalLabel').textContent = 'Edit Credit';
            
            // Change save button text
            document.getElementById('saveCreditBtn').textContent = 'Update Credit';
            
            try {
                // First show the modal, then load the data
                const modal = new bootstrap.Modal(document.getElementById('newCreditModal'));
                modal.show();
                
                console.log('Modal opened, now fetching credit data...');
                
                // Fetch the credit data
                firebase.firestore().collection('Studios').doc(currentStudioId).collection('Credits').doc(creditId)
                    .get()
                    .then(doc => {
                        if (!doc.exists) {
                            alert('Credit not found');
                            return;
                        }
                        
                        const credit = doc.data();
                        console.log('Credit data retrieved:', credit);
                        
                        // Populate the form fields
                        document.getElementById('creditName').value = credit.Name || '';
                        document.getElementById('creditAmount').value = credit.Amount || 0;
                        document.getElementById('creditNotes').value = credit.Notes || '';
                        
                        // Make sure families are loaded in the dropdown
                        loadFamiliesForCredit(currentStudioId);
                        
                        // We need to wait for the families to load before we can select the correct one
                        const checkFamilies = setInterval(() => {
                            const familySelect = document.getElementById('creditFamily');
                            
                            // If the dropdown doesn't exist or the modal is no longer visible, clear the interval
                            if (!familySelect || document.querySelector('#newCreditModal:not(.show)')) {
                                clearInterval(checkFamilies);
                                return;
                            }
                            
                            // If the options are still loading, wait
                            if (familySelect.querySelector('option[value=""]')?.textContent === 'Loading families...') {
                                return;
                            }
                            
                            // Clear the interval since options are loaded
                            clearInterval(checkFamilies);
                            console.log('Families loaded for credit');
                            
                            // Enable the select and select the correct family
                            familySelect.disabled = false;
                            
                            // Select the correct family
                            if (familySelect.querySelector(`option[value="${credit.FamilyId}"]`)) {
                                familySelect.value = credit.FamilyId;
                            } else {
                                console.warn('Could not find family with ID:', credit.FamilyId);
                            }
                        }, 100); // Check every 100ms
                    })
                    .catch(error => {
                        console.error('Error loading credit for editing:', error);
                        alert('Error loading credit data. Please try again.');
                    });
            } catch (error) {
                console.error('Error showing modal:', error);
                alert('Error opening edit form. Please try again.');
            }
            
            // Reset family search
            document.getElementById('creditFamilySearchInput').value = '';
            document.getElementById('noCreditFamiliesFound').style.display = 'none';
        }

        // Delete credit
        function deleteCredit(creditId) {
            if (confirm('Are you sure you want to delete this credit?')) {
                console.log('Delete credit:', creditId);
                
                firebase.firestore().collection('Studios').doc(currentStudioId).collection('Credits').doc(creditId).delete()
                    .then(() => {
                        alert('Credit deleted successfully!');
                        loadCreditsData(currentStudioId);
                    })
                    .catch(error => {
                        console.error('Error deleting credit:', error);
                        alert('Error deleting credit. Please try again.');
                    });
            }
        }

        // Reset credit form
        function resetCreditForm() {
            const creditForm = document.getElementById('newCreditForm');
            creditForm.reset();
            creditForm.dataset.mode = 'create';
            creditForm.dataset.creditId = '';
            
            document.getElementById('newCreditModalLabel').textContent = 'Create New Credit';
            document.getElementById('saveCreditBtn').textContent = 'Save Credit';
            
            // Reset search
            document.getElementById('creditFamilySearchInput').value = '';
            document.getElementById('noCreditFamiliesFound').style.display = 'none';
        }

        // Search credits function
        function searchCredits(query) {
            query = query.toLowerCase().trim();
            
            // Get all rows from the credits table (excluding any "no results" message row)
            const rows = Array.from(document.querySelectorAll('#creditsTable tbody tr'))
                .filter(row => row.id !== 'noCreditsResults');
            
            let matchCount = 0;
            
            // Show/hide rows based on the search query
            rows.forEach(row => {
                // Don't search in hidden elements like buttons
                const searchableText = Array.from(row.querySelectorAll('td'))
                    .map(td => td.textContent.trim())
                    .join(' ')
                    .toLowerCase();
                
                const isMatch = query === '' || searchableText.includes(query);
                
                if (isMatch) {
                    row.style.display = '';
                    matchCount++;
                } else {
                    row.style.display = 'none';
                }
            });
            
            // Handle the no results message
            const tbody = document.querySelector('#creditsTable tbody');
            let noResultsRow = document.getElementById('noCreditsResults');
            
            if (query !== '' && matchCount === 0) {
                if (!noResultsRow) {
                    noResultsRow = document.createElement('tr');
                    noResultsRow.id = 'noCreditsResults';
                    noResultsRow.innerHTML = `<td colspan="5" class="text-center text-muted">No credits found matching "${query}"</td>`;
                    tbody.appendChild(noResultsRow);
                } else {
                    noResultsRow.innerHTML = `<td colspan="5" class="text-center text-muted">No credits found matching "${query}"</td>`;
                    noResultsRow.style.display = '';
                }
            } else if (noResultsRow) {
                noResultsRow.style.display = 'none';
            }
            
            // Update UI to show how many results were found
            const resultCount = document.getElementById('creditSearchResultCount');
            if (resultCount) {
                if (query === '') {
                    resultCount.textContent = '';
                } else {
                    resultCount.textContent = `${matchCount} result${matchCount !== 1 ? 's' : ''} found`;
                }
            }
            
            console.log(`Search for "${query}" found ${matchCount} credit matches`);
        }

        // ... existing code ...
        function displayTransactions(transactions) {
            const chargesTableBody = document.querySelector('#chargesTable tbody');
            chargesTableBody.innerHTML = '';
            
            if (transactions.length === 0) {
                chargesTableBody.innerHTML = '<tr class="text-center text-muted"><td colspan="6">No charges or payments found.</td></tr>';
                return;
            }
            
            transactions.forEach(transaction => {
                const row = document.createElement('tr');
                
                // Format date based on transaction type
                let formattedDate = 'Invalid Date';
                if (transaction.Type === 'Payment') {
                    let dateObj;
                    if (transaction.PaymentDate) {
                        if (transaction.PaymentDate.toDate && typeof transaction.PaymentDate.toDate === 'function') {
                            dateObj = transaction.PaymentDate.toDate();
                        } else if (transaction.PaymentDate.seconds) {
                            dateObj = new Date(transaction.PaymentDate.seconds * 1000);
                        } else if (typeof transaction.PaymentDate === 'string') {
                            dateObj = new Date(transaction.PaymentDate);
                        } else {
                            dateObj = new Date(transaction.PaymentDate);
                        }
                        
                        if (!isNaN(dateObj)) {
                            formattedDate = dateObj.toLocaleString('en-US', { 
                                year: 'numeric',
                                month: 'long',
                                day: 'numeric',
                                hour: 'numeric',
                                minute: '2-digit',
                                second: '2-digit',
                                hour12: true,
                                timeZoneName: 'short'
                            });
                        }
                    }
                } else if (transaction.Type === 'Charge') {
                    let dateObj;
                    if (transaction.ChargeDate) {
                        if (transaction.ChargeDate.toDate && typeof transaction.ChargeDate.toDate === 'function') {
                            dateObj = transaction.ChargeDate.toDate();
                        } else if (transaction.ChargeDate.seconds) {
                            dateObj = new Date(transaction.ChargeDate.seconds * 1000);
                        } else if (typeof transaction.ChargeDate === 'string') {
                            dateObj = new Date(transaction.ChargeDate);
                        } else {
                            dateObj = new Date(transaction.ChargeDate);
                        }
                        
                        if (!isNaN(dateObj)) {
                            formattedDate = dateObj.toLocaleString('en-US', { 
                                year: 'numeric',
                                month: 'long',
                                day: 'numeric',
                                hour: 'numeric',
                                minute: '2-digit',
                                second: '2-digit',
                                hour12: true,
                                timeZoneName: 'short'
                            });
                        }
                    }
                }
                
                // Format amount with color based on transaction type
                const isPayment = transaction.Type === 'Payment';
                const isCredit = transaction.Type === 'Credit' || transaction.Amount < 0;
                const formattedAmount = isPayment ? 
                    `<span class="text-success">$${Math.abs(transaction.Amount).toFixed(2)}</span>` :
                    isCredit ? 
                        `<span class="text-success">-$${Math.abs(transaction.Amount).toFixed(2)}</span>` : 
                        `<span class="text-danger">$${transaction.Amount.toFixed(2)}</span>`;
                
                // Determine status badge color
                let statusBadgeClass = 'bg-secondary';
                switch (transaction.Status) {
                    case 'Paid':
                    case 'Completed':
                        statusBadgeClass = 'bg-success';
                        break;
                    case 'Pending':
                        statusBadgeClass = 'bg-warning text-dark';
                        break;
                    case 'Overdue':
                    case 'Unpaid':
                        statusBadgeClass = 'bg-danger';
                        break;
                }
                
                row.innerHTML = `
                    <td>${transaction.FamilyName}</td>
                    <td>${transaction.Description || 'N/A'}</td>
                    <td>${formattedAmount}</td>
                    <td>${formattedDate}</td>
                    <td><span class="badge ${statusBadgeClass}">${transaction.Status || 'Unknown'}</span></td>
                    <td>${transaction.Type || 'N/A'}</td>
                `;
                
                chargesTableBody.appendChild(row);
            });
        }
        // ... existing code ...

        // Search charges function
        function searchCharges(query) {
            query = query.toLowerCase().trim();
            
            // If we don't have charges loaded yet, exit
            if (!window.allStudioCharges) return;
            
            // If query is empty, show all charges
            if (query === '') {
                displayTransactions(window.allStudioCharges);
                
                // Update search result count
                const resultCount = document.getElementById('chargeSearchResultCount');
                if (resultCount) {
                    resultCount.textContent = '';
                }
                return;
            }
            
            // Filter charges based on search query
            const filteredCharges = window.allStudioCharges.filter(charge => {
                // Search in family name
                if (charge.FamilyName.toLowerCase().includes(query)) return true;
                
                // Search in description
                if (charge.Description && charge.Description.toLowerCase().includes(query)) return true;
                
                // Search in status
                if (charge.Status && charge.Status.toLowerCase().includes(query)) return true;
                
                // Search in type
                if (charge.Type && charge.Type.toLowerCase().includes(query)) return true;
                
                // Search in amount (as string)
                const amountStr = charge.Amount.toString();
                if (amountStr.includes(query)) return true;
                
                return false;
            });
            
            // Display filtered charges
            displayTransactions(filteredCharges);
            
            // Update search result count
            const resultCount = document.getElementById('chargeSearchResultCount');
            if (resultCount) {
                resultCount.textContent = `${filteredCharges.length} result${filteredCharges.length !== 1 ? 's' : ''} found`;
            }
            
            console.log(`Search for "${query}" found ${filteredCharges.length} charge matches`);
        }

        function saveStudentFamilyMax() {
            // Get current studio ID
            const studioId = currentStudioId;
            if (!studioId) {
                alert('Error: Studio ID not found');
                return;
            }
            
            // Get values from the form
            const enableToggle = document.getElementById('enableStudentFamilyMax');
            const studentMaxInput = document.getElementById('studentMaxAmount');
            const familyMaxInput = document.getElementById('familyMaxAmount');
            
            const isActive = enableToggle ? enableToggle.checked : false;
            const studentMax = parseFloat(studentMaxInput ? studentMaxInput.value : '0');
            const familyMax = parseFloat(familyMaxInput ? familyMaxInput.value : '0');
            
            // Validate inputs if feature is enabled
            if (isActive) {
                if (isNaN(studentMax) || studentMax <= 0) {
                    alert('Please enter a valid Student Max amount');
                    return;
                }
                
                if (isNaN(familyMax) || familyMax <= 0) {
                    alert('Please enter a valid Family Max amount');
                    return;
                }
            }
            
            // Create data object
            const maxData = {
                IsActive: isActive,
                StudentMax: studentMax,
                FamilyMax: familyMax,
                UpdatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            // Check if we're updating or creating
            const form = document.getElementById('studentFamilyMaxForm');
            const existingDocId = form.dataset.docId;
            
            // Reference to the StudentFamilyMax collection
            const maxCollectionRef = firebase.firestore().collection(`Studios/${studioId}/StudentFamilyMax`);
            
            // Save button loading state
            const saveButton = document.getElementById('saveStudentFamilyMaxBtn');
            if (saveButton) {
                saveButton.disabled = true;
                saveButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving...';
            }
            
            // Create or update document
            let savePromise;
            
            if (existingDocId) {
                // Update existing document
                savePromise = maxCollectionRef.doc(existingDocId).update(maxData);
            } else {
                // Create new document with CreatedAt timestamp
                maxData.CreatedAt = firebase.firestore.FieldValue.serverTimestamp();
                savePromise = maxCollectionRef.add(maxData);
            }
            
            savePromise
                .then(result => {
                    console.log('Student/Family Max settings saved successfully');
                    
                    // Store doc ID if this was a creation
                    if (!existingDocId && result.id) {
                        form.dataset.docId = result.id;
                    }
                    
                    // Show success message
                    alert('Settings saved successfully!');
                })
                .catch(error => {
                    console.error('Error saving Student/Family Max settings:', error);
                    alert('Error saving settings. Please try again.');
                })
                .finally(() => {
                    // Reset save button
                    if (saveButton) {
                        saveButton.disabled = false;
                        saveButton.innerHTML = 'Save';
                    }
                });
        }

        // Function to edit a tuition rate plan
        function editTuitionRate(rateId) {
            console.log('Edit tuition rate:', rateId);
            
            // Set the form to edit mode and store the rate ID
            const saveButton = document.getElementById('saveTuitionRatePlan');
            saveButton.dataset.mode = 'edit';
            saveButton.dataset.rateId = rateId;
            saveButton.textContent = 'Update Rate Plan';
            
            // Change modal title
            document.getElementById('createTuitionRateModalLabel').textContent = 'Edit Tuition Rate Plan';
            
            // Get the rate plan data from Firestore
            const studioId = localStorage.getItem('currentStudioId');
            
            firebase.firestore().collection('Studios').doc(studioId).collection('RatePlans').doc(rateId)
                .get()
                .then(doc => {
                    if (!doc.exists) {
                        console.error('Rate plan not found');
                        alert('Error: Rate plan not found');
                        return;
                    }
                    
                    const ratePlan = doc.data();
                    console.log('Rate plan data:', ratePlan);
                    
                    // Set the rate plan name
                    document.getElementById('ratePlanName').value = ratePlan.Name || '';
                    
                    // Clear existing hour/rate pairs except the first one
                    const hourRatePairsContainer = document.getElementById('hourRatePairs');
                    while (hourRatePairsContainer.children.length > 1) {
                        hourRatePairsContainer.removeChild(hourRatePairsContainer.lastChild);
                    }
                    
                    // Reset the first pair
                    const firstPair = hourRatePairsContainer.querySelector('.hour-rate-pair');
                    if (firstPair) {
                        firstPair.querySelector('.hours-input').value = '';
                        firstPair.querySelector('.rate-input').value = '';
                    }
                    
                    // Add hour/rate pairs based on the data
                    if (ratePlan.HourRates && ratePlan.HourRates.length > 0) {
                        ratePlan.HourRates.forEach((pair, index) => {
                            if (index === 0 && firstPair) {
                                // Use the first pair
                                firstPair.querySelector('.hours-input').value = pair.Hours || '';
                                firstPair.querySelector('.rate-input').value = pair.Rate || '';
                            } else {
                                // Add new pairs
                                addHourRatePair(pair.Hours, pair.Rate);
                            }
                        });
                    }
                    
                    // Handle family discount data
                    const familyDiscountToggle = document.getElementById('familyDiscountToggle');
                    const familyDiscountSection = document.getElementById('familyDiscountSection');
                    
                    if (ratePlan.FamilyDiscount) {
                        // Enable family discount
                        familyDiscountToggle.checked = true;
                        familyDiscountSection.style.display = 'block';
                        
                        // Set discount type
                        const discountType = document.getElementById('tuitionDiscountType');
                        discountType.value = ratePlan.FamilyDiscount.Type || 'percentage';
                        
                        // Set discount amount
                        const discountAmount = document.getElementById('tuitionDiscountAmount');
                        discountAmount.value = ratePlan.FamilyDiscount.Amount || '';
                        
                        // Set student threshold
                        const studentThreshold = document.getElementById('studentThreshold');
                        studentThreshold.value = ratePlan.FamilyDiscount.StudentThreshold || 1;
                        
                        console.log('Updating discount UI for type:', ratePlan.FamilyDiscount.Type);
                        console.log('Current discount amount:', ratePlan.FamilyDiscount.Amount);
                    } else {
                        // Disable family discount
                        familyDiscountToggle.checked = false;
                        familyDiscountSection.style.display = 'none';
                        
                        // Reset fields to defaults
                        document.getElementById('tuitionDiscountType').value = 'percentage';
                        document.getElementById('tuitionDiscountAmount').value = '';
                        document.getElementById('studentThreshold').value = 1;
                    }
                    
                    // Show the modal
                    const modal = new bootstrap.Modal(document.getElementById('createTuitionRateModal'));
                    modal.show();
                })
                .catch(error => {
                    console.error('Error loading rate plan:', error);
                    alert('Error loading rate plan. Please try again.');
                });
        }

        // Helper function to add a new hour/rate pair to the form
        function addHourRatePair(hours = '', rate = '') {
            const hourRatePairsContainer = document.getElementById('hourRatePairs');
            
            // Clone the first pair
            const firstPair = hourRatePairsContainer.querySelector('.hour-rate-pair');
            const newPair = firstPair.cloneNode(true);
            
            // Set values if provided
            newPair.querySelector('.hours-input').value = hours;
            newPair.querySelector('.rate-input').value = rate;
            
            // Show the remove button
            const removeButton = newPair.querySelector('.remove-pair');
            removeButton.style.display = 'block';
            
            // Add event listener to remove button
            removeButton.addEventListener('click', function() {
                hourRatePairsContainer.removeChild(newPair);
            });
            
            // Add the new pair to the container
            hourRatePairsContainer.appendChild(newPair);
            
            return newPair;
        }

        // Function to delete a tuition rate plan
        function deleteTuitionRate(rateId, rateName) {
            if (confirm(`Are you sure you want to delete the rate plan "${rateName}"? This action cannot be undone.`)) {
                console.log('Delete tuition rate:', rateId);
                
                const studioId = localStorage.getItem('currentStudioId');
                if (!studioId) return;
                
                firebase.firestore().collection('Studios').doc(studioId).collection('RatePlans').doc(rateId)
                    .delete()
                    .then(() => {
                        alert(`Rate plan "${rateName}" deleted successfully!`);
                        loadTuitionRatesData(studioId);
                    })
                    .catch(error => {
                        console.error('Error deleting rate plan:', error);
                        alert('Error deleting rate plan. Please try again.');
                    });
            }
        }

        // Function to update discount input UI based on selected type
        function updateDiscountInputUI() {
            const discountType = document.getElementById('discountType').value;
            const percentageSymbol = document.querySelector('.percentage-symbol');
            const fixedSymbol = document.querySelector('.fixed-symbol');
            const discountPrefix = document.getElementById('discountPrefix');
            
            console.log('Updating discount UI for type:', discountType);
            
            if (discountType === 'percentage') {
                percentageSymbol.style.display = 'inline';
                fixedSymbol.style.display = 'none';
                discountPrefix.textContent = '';
            } else {
                percentageSymbol.style.display = 'none';
                fixedSymbol.style.display = 'inline';
                discountPrefix.textContent = '$';
            }
            
            // Log current discount amount for debugging
            const discountAmount = document.getElementById('discountAmount').value;
            console.log('Current discount amount:', discountAmount);
        }

        // Add this function to reset the form when the modal is closed
        function resetFeeForm() {
            console.log('Resetting fee form to clean state');
            
            // Get the form element
            const feeForm = document.getElementById('newFeeForm');
            if (!feeForm) {
                console.log('Form not found');
                return;
            }
            
            // Reset the actual form inputs
            feeForm.reset();
            
            // Reset data attributes
            feeForm.dataset.mode = 'create';
            feeForm.dataset.feeId = '';
            
            // Safely update modal elements
            const modalLabel = document.getElementById('newFeeModalLabel');
            const saveBtn = document.getElementById('saveFeeBtn');
            if (modalLabel) modalLabel.textContent = 'Create New Fee';
            if (saveBtn) saveBtn.textContent = 'Save Fee';
            
            // Safely hide all conditional sections
            ['associationItemContainer', 'recurringOptions', 'installmentsOptions', 'endDateSection'].forEach(id => {
                const element = document.getElementById(id);
                if (element) element.style.display = 'none';
            });
            
            // Safely reset end date fields
            const hasEndDateCheckbox = document.getElementById('hasEndDate');
            const feeEndDateInput = document.getElementById('feeEndDate');
            if (hasEndDateCheckbox) hasEndDateCheckbox.checked = false;
            if (feeEndDateInput) feeEndDateInput.value = '';
            
            // Safely reset association search
            const searchInput = document.getElementById('associationSearchInput');
            const noItemsFound = document.getElementById('noAssociationItemsFound');
            if (searchInput) searchInput.value = '';
            if (noItemsFound) noItemsFound.style.display = 'none';
            
            // Enable all form fields
            const formFields = feeForm.querySelectorAll('input, select');
            formFields.forEach(field => {
                field.disabled = false;
            });
        }

        // Add the toggle function to enable/disable rate plans
        function toggleRateActive(rateId, isActive) {
            if (!currentStudioId) {
                alert('Error: Studio ID not found');
                return;
            }
            
            // Show loading state
            const switchElement = document.getElementById(`activeSwitch-rate-${rateId}`);
            if (switchElement) {
                switchElement.disabled = true;
            }
            
            // Update the rate plan document
            firebase.firestore().collection('Studios').doc(currentStudioId).collection('RatePlans').doc(rateId)
                .update({
                    IsActive: isActive,
                    UpdatedAt: firebase.firestore.FieldValue.serverTimestamp()
                })
                .then(() => {
                    console.log(`Rate plan ${rateId} active status updated to ${isActive}`);
                    
                    // Update the visual appearance of the row
                    const row = switchElement.closest('tr');
                    if (row) {
                        row.style.opacity = isActive ? '1' : '0.6';
                    }
                    
                    // Re-enable the switch
                    if (switchElement) {
                        switchElement.disabled = false;
                    }
                })
                .catch(error => {
                    console.error('Error updating rate plan active status:', error);
                    alert('Error updating rate plan status. Please try again.');
                    
                    // Revert the switch to original state
                    if (switchElement) {
                        switchElement.checked = !isActive;
                        switchElement.disabled = false;
                    }
                });
        }

        // Enhanced saveTuitionRatePlan function to better validate and log family discount
        document.getElementById('saveTuitionRatePlan').addEventListener('click', async function() {
            // ... existing code ...
        });

        // Make sure to add an event listener for the discount type dropdown
        document.getElementById('discountType').addEventListener('change', function() {
            console.log('Discount type changed to:', this.value);
            updateDiscountInputUI();
        });

        // Add an event listener for the discount amount to track changes
        document.getElementById('discountAmount').addEventListener('input', function() {
            console.log('Discount amount changed to:', this.value);
        });

        // Function to update a family's balance in the FamilyBalances document
        function updateFamilyBalance(studioId, familyId, familyName, newBalance) {
            const db = firebase.firestore();
            const familyBalancesRef = db.collection(`Studios/${studioId}/Charges-Payments`).doc('FamilyBalances');
            
            console.log(`Updating balance for family ${familyName} (${familyId}): $${newBalance}`);
            
            return familyBalancesRef.get()
                .then(doc => {
                    if (!doc.exists) {
                        // Initialize the document if it doesn't exist
                        // Use client-side timestamp in array
                        const now = new Date().toISOString();
                        return familyBalancesRef.set({
                            Families: [{
                                FamilyId: familyId,
                                FamilyName: familyName,
                                Balance: newBalance,
                                LastUpdated: now // Client-side timestamp
                            }],
                            LastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }
                    
                    const data = doc.data();
                    const families = data.Families || [];
                    const now = new Date().toISOString(); // Client-side timestamp
                    
                    // Check if the family already exists in the array
                    const familyIndex = families.findIndex(f => f.FamilyId === familyId);
                    
                    if (familyIndex >= 0) {
                        // Update existing family
                        families[familyIndex].Balance = newBalance;
                        families[familyIndex].FamilyName = familyName; // Update name in case it changed
                        families[familyIndex].LastUpdated = now; // Client-side timestamp
                    } else {
                        // Add new family
                        families.push({
                            FamilyId: familyId,
                            FamilyName: familyName,
                            Balance: newBalance,
                            LastUpdated: now // Client-side timestamp
                        });
                    }
                    
                    // Update the document
                    return familyBalancesRef.update({
                        Families: families,
                        LastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                    });
                })
                .then(() => {
                    console.log(`Successfully updated balance for family ${familyName}`);
                    
                    // After updating family balance, also update the revenue metrics
                    return updateRevenueDocuments(studioId);
                })
                .catch(error => {
                    console.error(`Error updating family balance: ${error}`);
                    return false;
                });
        }

        // Modify the createCharge function to update family balance in both places
        function createCharge(studioId, familyId, chargeData) {
            const db = firebase.firestore();
            
            // First add charge to the family
            return db.collection(`Studios/${studioId}/Families`).doc(familyId).get()
                .then(doc => {
                    if (!doc.exists) {
                        throw new Error("Family not found");
                    }
                    
                    const familyData = doc.data();
                    const charges = familyData.Charges || [];
                    const currentBalance = familyData.Balance || 0;
                    
                    // Add the new charge
                    const newCharge = {
                        ...chargeData,
                        ChargeId: generateUniqueId(),
                        ChargeDate: new Date().toISOString(),
                        CreatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    
                    charges.push(newCharge);
                    
                    // Calculate the new balance
                    const chargeAmount = parseFloat(chargeData.Amount || 0);
                    const newBalance = currentBalance + chargeAmount;
                    
                    // Update the family document
                    return db.collection(`Studios/${studioId}/Families`).doc(familyId).update({
                        Charges: charges,
                        Balance: newBalance
                    }).then(() => {
                        // Also update the balance in the FamilyBalances document
                        return updateFamilyBalance(studioId, familyId, familyData.Name, newBalance);
                    });
                })
                .then(() => {
                    // After updating the family, sync with the centralized collection
                    return syncChargesAndRevenue(studioId);
                })
                .then(() => {
                    console.log("Charge created and revenue metrics updated");
                    return true;
                })
                .catch(error => {
                    console.error("Error creating charge:", error);
                    throw error;
                });
        }

        // Function to sync all family balances from Families collection to FamilyBalances document
        function syncFamilyBalances(studioId) {
            const db = firebase.firestore();
            console.log(`Starting comprehensive family balances sync for studio ${studioId}`);
            
            // First ensure the document exists
            return ensureFamilyBalancesDocumentExists(studioId)
                .then(() => {
                    // Get all families with detailed error handling
                    return db.collection(`Studios/${studioId}/Families`).get()
                        .catch(error => {
                            console.error(`Error fetching families: ${error}`);
                            throw new Error(`Failed to fetch families: ${error.message}`);
                        });
                })
                .then(familySnapshot => {
                    if (!familySnapshot || familySnapshot.empty) {
                        console.log('No families found in studio - creating empty FamilyBalances');
                        const familyBalancesRef = db.collection(`Studios/${studioId}/Charges-Payments`).doc('FamilyBalances');
                        return familyBalancesRef.set({
                            Families: [],
                            LastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }
                    
                    console.log(`Found ${familySnapshot.size} families to process for balances`);
                    const familyBalancesRef = db.collection(`Studios/${studioId}/Charges-Payments`).doc('FamilyBalances');
                    const families = [];
                    
                    // Current timestamp for all family records (client-side)
                    const now = new Date().toISOString();
                    
                    // Process each family document to extract balance information
                    familySnapshot.forEach(doc => {
                        const familyData = doc.data();
                        const familyId = doc.id;
                        
                        // Use LastName if available, otherwise look for Name, fall back to Family ID
                        const familyName = familyData.LastName || familyData.Name || `Family ${familyId}`;
                        
                        // Ensure balance is a valid number
                        let balance = 0;
                        if (familyData.hasOwnProperty('Balance')) {
                            balance = parseFloat(familyData.Balance || 0);
                            if (isNaN(balance)) balance = 0;
                        }
                        
                        // Add to our local array with detailed logging - use client timestamp instead
                        families.push({
                            FamilyId: familyId,
                            FamilyName: familyName,
                            Balance: balance,
                            LastUpdated: now // ISO string timestamp (client-side)
                        });
                        
                        console.log(`Processed family: ${familyName} (${familyId}), balance: $${balance.toFixed(2)}`);
                    });
                    
                    console.log(`Updating FamilyBalances with ${families.length} family records`);
                    
                    // Update the FamilyBalances document with all families
                    return familyBalancesRef.set({
                        Families: families,
                        LastUpdated: firebase.firestore.FieldValue.serverTimestamp() // Only use serverTimestamp at document level
                    }).catch(error => {
                        console.error(`Error updating FamilyBalances document: ${error}`);
                        throw new Error(`Failed to update FamilyBalances: ${error.message}`);
                    });
                })
                .then(() => {
                    console.log("Family balances synchronized successfully");
                    
                    // Now update the revenue metrics from the newly synchronized data
                    return updateRevenueDocuments(studioId);
                })
                .then(() => {
                    return true;
                })
                .catch(error => {
                    console.error("Error in syncFamilyBalances:", error);
                    return false;
                });
        }

        // New function to force a complete data sync
        function forceSyncAllData(studioId) {
            console.log('FORCING COMPLETE DATA SYNC');
            
            // Show loading state in UI
            showLoadingSpinners();
            const syncButton = document.getElementById('syncRevenueBtn');
            if (syncButton) {
                syncButton.disabled = true;
                syncButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Syncing...';
            }
            
            // Force create all required documents
            return checkAndInitializeChargesPayments(studioId)
                .then(() => {
                    console.log('Step 1: Getting all families...');
                    // Get all families with detailed logging
                    return firebase.firestore().collection(`Studios/${studioId}/Families`).get()
                        .then(snapshot => {
                            console.log(`Found ${snapshot.size} families in studio`);
                            if (snapshot.empty) {
                                console.log('No families found - creating empty FamilyBalances');
                            }
                            return snapshot;
                        })
                        .catch(error => {
                            console.error('Error fetching families:', error);
                            throw new Error('Failed to fetch families: ' + error.message);
                        });
                })
                .then(familySnapshot => {
                    console.log('Step 2: Processing family balances...');
                    // Process and update FamilyBalances document
                    const familyBalancesRef = firebase.firestore()
                        .collection(`Studios/${studioId}/Charges-Payments`)
                        .doc('FamilyBalances');
                    
                    const families = [];
                    
                    // Update: Use client-side timestamp
                    const now = new Date().toISOString();
                    
                    // Process each family document to extract balance information
                    if (familySnapshot && !familySnapshot.empty) {
                        familySnapshot.forEach(doc => {
                            const familyData = doc.data();
                            const familyId = doc.id;
                            
                            // Use available family name fields
                            const familyName = familyData.LastName || familyData.Name || `Family ${familyId}`;
                            
                            // Ensure balance is a valid number
                            let balance = 0;
                            if (familyData.hasOwnProperty('Balance')) {
                                balance = parseFloat(familyData.Balance || 0);
                                if (isNaN(balance)) balance = 0;
                            }
                            
                            // Add to our local array with client-side timestamp
                            families.push({
                                FamilyId: familyId,
                                FamilyName: familyName,
                                Balance: balance,
                                LastUpdated: now // Use string timestamp instead of serverTimestamp
                            });
                            
                            console.log(`Processed family: ${familyName} (${familyId}), balance: $${balance.toFixed(2)}`);
                        });
                    }
                    
                    console.log(`Updating FamilyBalances with ${families.length} family records`);
                    
                    // Set (not update) the FamilyBalances document with all families
                    return familyBalancesRef.set({
                        Families: families,
                        LastUpdated: firebase.firestore.FieldValue.serverTimestamp() // Only use serverTimestamp at document level
                    });
                })
                .then(() => {
                    // Rest of the function remains the same
                    // ...rest of the code...
                });
        }

        // Enhance auto-sync to explicitly check family balances
        function setupAutoSync(studioId) {
            if (!studioId) {
                console.error('Cannot setup auto-sync: No studio ID provided');
                return;
            }
            
            let syncIntervalId = null;
            let isSyncing = false;
            
            const performSync = function() {
                if (isSyncing) return;
                
                if (!document.getElementById('chargesTab')) {
                    console.log('No longer on charges-payments page, stopping auto-sync');
                    clearInterval(syncIntervalId);
                    return;
                }
                
                console.log('Auto-syncing all financial data...');
                isSyncing = true;
                
                // First check if FamilyBalances document exists and has data
                firebase.firestore().collection(`Studios/${studioId}/Charges-Payments`).doc('FamilyBalances').get()
                    .then(doc => {
                        if (!doc.exists || !doc.data().Families || doc.data().Families.length === 0) {
                            console.log('FamilyBalances document is empty or missing - running full sync');
                            return syncFamilyBalances(studioId);
                        }
                        return syncChargesAndRevenue(studioId);
                    })
                    .then(success => {
                        if (success) {
                            const activeTab = document.querySelector('.tab-pane.active');
                            if (activeTab) {
                                const tabId = activeTab.id;
                                
                                if (tabId === 'revenue') {
                                    loadRevenueData(studioId);
                                } else if (tabId === 'charges') {
                                    loadChargesPaymentsFromSubcollection(studioId);
                                }
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Auto-sync error:', error);
                    })
                    .finally(() => {
                        isSyncing = false;
                    });
            };
            
            // Start with an immediate sync
            performSync();
            
            // Then set up regular interval
            syncIntervalId = setInterval(performSync, 900000);
            console.log('Comprehensive automatic sync enabled - updating every 15 minutes');
            
            return syncIntervalId;
        }
    </script>

    <!-- Add the fee modal at the end of the body, before the closing </body> tag -->
<!-- New Fee Modal -->
<div class="modal fade" id="newFeeModal" tabindex="-1" aria-labelledby="newFeeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="newFeeModalLabel">Create New Fee</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <!-- Left side: Fee Creation Form -->
                    <div class="col-md-6 border-end">
                        <form id="newFeeForm">
                            <div class="mb-3">
                                <label for="feeName" class="form-label">Fee Name</label>
                                <input type="text" class="form-control" id="feeName" required>
                            </div>
                            <div class="mb-3">
                                <label for="feeType" class="form-label">Fee Type</label>
                                <select class="form-select" id="feeType" required>
                                    <option value="" selected disabled>Select fee type</option>
                                    <option value="OneTime">One Time</option>
                                    <option value="Recurring">Recurring</option>
                                    <option value="Installments">Installments</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="feeAmount" class="form-label">Amount ($)</label>
                                <input type="number" class="form-control" id="feeAmount" min="0" step="0.01" required>
                            </div>
                            
                            <!-- Recurring Fee Options -->
                            <div id="recurringOptions" style="display: none;">
                                <div class="mb-3">
                                    <label for="recurringFrequency" class="form-label">Frequency</label>
                                    <select class="form-select" id="recurringFrequency">
                                        <option value="weekly">Weekly</option>
                                        <option value="monthly">Monthly</option>
                                        <option value="quarterly">Quarterly</option>
                                        <option value="yearly">Yearly</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="recurringStartDate" class="form-label">Start Date</label>
                                    <input type="date" class="form-control" id="recurringStartDate">
                                </div>
                                <div class="mb-3">
                                    <label for="recurringDuration" class="form-label">Duration</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" id="recurringDuration" min="1" value="1">
                                        <span class="input-group-text">periods</span>
                                    </div>
                                    <small class="form-text text-muted">Number of times this fee will recur</small>
                                </div>
                                <div class="mb-3">
                                    <label for="recurringAssociationType" class="form-label">Associate With</label>
                                    <select class="form-select" id="recurringAssociationType" onchange="handleAssociationTypeChange('recurring')">
                                        <option value="">Select Association Type</option>
                                        <option value="Season">Season</option>
                                        <option value="Class">Class</option>
                                        <option value="Family">Family</option>
                                        <option value="Student">Student</option>
                                        <option value="Tags">Tags</option>
                                    </select>
                                </div>
                                <div class="mb-3" id="recurringAssociationContainer" style="display: none;">
                                    <div class="input-group mb-2">
                                        <input type="text" class="form-control" id="recurringAssociationSearch" placeholder="Search...">
                                    </div>
                                    <select class="form-select" id="recurringAssociation" size="5">
                                        <!-- Options will be populated dynamically -->
                                    </select>
                                </div>
                            </div>

                            <!-- Installments Options -->
                            <div id="installmentsOptions" style="display: none;">
                                <div class="mb-3">
                                    <label for="numberOfInstallments" class="form-label">Number of Installments</label>
                                    <input type="number" class="form-control" id="numberOfInstallments" min="2" value="2">
                                </div>
                                <div class="mb-3">
                                    <label for="installmentStartDate" class="form-label">Start Date</label>
                                    <input type="date" class="form-control" id="installmentStartDate">
                                </div>
                                <div class="mb-3">
                                    <label for="installmentFrequency" class="form-label">Installment Frequency</label>
                                    <select class="form-select" id="installmentFrequency">
                                        <option value="weekly">Weekly</option>
                                        <option value="monthly">Monthly</option>
                                        <option value="quarterly">Quarterly</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="installmentAssociationType" class="form-label">Associate With</label>
                                    <select class="form-select" id="installmentAssociationType" onchange="handleAssociationTypeChange('installment')">
                                        <option value="">Select Association Type</option>
                                        <option value="Season">Season</option>
                                        <option value="Class">Class</option>
                                        <option value="Family">Family</option>
                                        <option value="Student">Student</option>
                                        <option value="Tags">Tags</option>
                                    </select>
                                </div>
                                <div class="mb-3" id="installmentAssociationContainer" style="display: none;">
                                    <div class="input-group mb-2">
                                        <input type="text" class="form-control" id="installmentAssociationSearch" placeholder="Search...">
                                    </div>
                                    <select class="form-select" id="installmentAssociation" size="5">
                                        <!-- Options will be populated dynamically -->
                                    </select>
                                </div>
                            </div>

                            <!-- One Time Fee Options -->
                            <div id="oneTimeOptions" style="display: none;">
                                <div class="mb-3">
                                    <label for="oneTimeAmount" class="form-label">Amount</label>
                                    <div class="input-group">
                                        <span class="input-group-text">$</span>
                                        <input type="number" class="form-control" id="oneTimeAmount" min="0" step="0.01">
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="oneTimeAssociationType" class="form-label">Associate With</label>
                                    <select class="form-select" id="oneTimeAssociationType" onchange="handleAssociationTypeChange('oneTime')">
                                        <option value="">Select Association Type</option>
                                        <option value="Season">Season</option>
                                        <option value="Class">Class</option>
                                        <option value="Family">Family</option>
                                        <option value="Student">Student</option>
                                        <option value="Tags">Tags</option>
                                    </select>
                                </div>
                                <div class="mb-3" id="oneTimeAssociationContainer" style="display: none;">
                                    <div class="input-group mb-2">
                                        <input type="text" class="form-control" id="oneTimeAssociationSearch" placeholder="Search...">
                                    </div>
                                    <select class="form-select" id="oneTimeAssociation" size="5">
                                        <!-- Options will be populated dynamically -->
                                    </select>
                                </div>
                            </div>
                        </form>
                    </div>

                    <!-- Right side: Fee Preview -->
                    <div class="col-md-6">
                        <div class="fee-preview p-4 bg-light rounded">
                            <h5 class="mb-4">Fee Preview</h5>
                            <div class="preview-card bg-white p-4 rounded shadow-sm">
                                <div class="d-flex justify-content-between align-items-center mb-4">
                                    <h6 class="preview-fee-name mb-0">--</h6>
                                    <span class="badge bg-primary preview-fee-type">--</span>
                                </div>
                                <div class="preview-amount mb-4">
                                    <h2 class="mb-0">$<span class="preview-fee-amount">0.00</span></h2>
                                    <div class="text-muted small total-amount-text" style="display: none;">
                                        Total over duration: $<span class="preview-total-amount">0.00</span>
                                    </div>
                                </div>
                                <div class="preview-schedule">
                                    <h6 class="mb-3">Payment Schedule</h6>
                                    <div class="timeline" id="previewTimeline">
                                        <p class="text-muted">Select fee type and details to see payment schedule</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveFeeBtn">Save Fee</button>
            </div>
        </div>
    </div>
</div>

    <!-- New Discount Modal -->
    <div class="modal fade" id="newDiscountModal" tabindex="-1" aria-labelledby="newDiscountModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="newDiscountModalLabel">Create New Discount</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="newDiscountForm">
                        <div class="mb-3">
                            <label for="discountName" class="form-label">Discount Name</label>
                            <input type="text" class="form-control" id="discountName" required>
                        </div>
                        <div class="mb-3">
                            <label for="discountType" class="form-label">Discount Type</label>
                            <select class="form-select" id="discountType" required>
                                <option value="" selected disabled>Select discount type</option>
                                <option value="FixedAmount">Fixed Amount ($)</option>
                                <option value="Percentage">Percentage (%)</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="discountAmount" class="form-label">Discount Amount</label>
                            <div class="input-group">
                                <span class="input-group-text" id="discountPrefix"></span>
                                <input type="number" class="form-control" id="discountAmount" step="0.01" min="0">
                                <span class="input-group-text">
                                    <span class="percentage-symbol">%</span>
                                    <span class="fixed-symbol" style="display: none;">USD</span>
                                </span>
                            </div>
                            <small class="form-text text-muted" id="discountAmountHelp">
                                For percentage, enter a value between 1-100. For fixed amount, enter the dollar value.
                            </small>
                        </div>
                        <div class="mb-3">
                            <label for="discountAssociation" class="form-label">Apply Discount To</label>
                            <select class="form-select" id="discountAssociation" required>
                                <option value="" selected disabled>Select where to apply</option>
                                <option value="Season">Season</option>
                                <option value="Student">Student</option>
                                <option value="Family">Family</option>
                                <option value="Code">Discount Code</option>
                            </select>
                        </div>
                        <div class="mb-3" id="discountAssociationItemContainer" style="display: none;">
                            <label for="discountAssociationItem" class="form-label">Associated With</label>
                            <div class="input-group mb-2">
                                <span class="input-group-text"><i class="fas fa-search"></i></span>
                                <input type="text" class="form-control association-search-input" 
                                       id="discountAssociationSearchInput" 
                                       data-target-dropdown="discountAssociationItem" 
                                       placeholder="Search...">
                                <button class="btn btn-outline-secondary clear-search-btn" id="clearDiscountAssociationSearch" type="button">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div id="noDiscountAssociationItemsFound" class="no-results-message text-danger" style="display: none;">
                                No items match your search.
                            </div>
                            <select class="form-select" id="discountAssociationItem" required disabled>
                                <option value="" selected disabled>Select an item</option>
                                <!-- Options will be populated dynamically -->
                            </select>
                            <small id="noDiscountAssociationItemsFound" class="form-text text-muted" style="display: none;">No matching items found</small>
                        </div>
                        <div class="mb-3" id="discountCodeContainer" style="display: none;">
                            <label for="discountCode" class="form-label">Discount Code</label>
                            <input type="text" class="form-control" id="discountCode" placeholder="Enter discount code" required>
                            <small class="form-text text-muted">This code will be entered by users to apply the discount.</small>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveDiscountBtn">Save Discount</button>
                </div>
            </div>
        </div>
    </div>

    <!-- New Credit Modal -->
    <div class="modal fade" id="newCreditModal" tabindex="-1" aria-labelledby="newCreditModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="newCreditModalLabel">Create New Credit</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="newCreditForm">
                        <div class="mb-3">
                            <label for="creditName" class="form-label">Credit Name</label>
                            <input type="text" class="form-control" id="creditName" required>
                        </div>
                        <div class="mb-3">
                            <label for="creditAmount" class="form-label">Amount ($)</label>
                            <input type="number" class="form-control" id="creditAmount" min="0" step="0.01" required>
                        </div>
                        <div class="mb-3">
                            <label for="creditFamily" class="form-label">Family</label>
                            <div class="input-group mb-2">
                                <span class="input-group-text"><i class="fas fa-search"></i></span>
                                <input type="text" class="form-control" id="creditFamilySearchInput" placeholder="Search families..." aria-label="Search families">
                            </div>
                            <select class="form-select" id="creditFamily" required>
                                <option value="" selected disabled>Select a family</option>
                                <!-- Options will be populated dynamically -->
                            </select>
                            <small id="noCreditFamiliesFound" class="form-text text-muted" style="display: none;">No matching families found</small>
                        </div>
                        <div class="mb-3">
                            <label for="creditNotes" class="form-label">Notes</label>
                            <textarea class="form-control" id="creditNotes" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveCreditBtn">Save Credit</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Tuition Rate Modal -->
    <div class="modal fade" id="createTuitionRateModal" tabindex="-1" aria-labelledby="createTuitionRateModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="createTuitionRateModalLabel">Create Tuition Rate Plan</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="tuitionRateForm">
                        <div class="mb-3">
                            <label for="ratePlanName" class="form-label">Rate Plan Name</label>
                            <input type="text" class="form-control" id="ratePlanName" required>
                        </div>

                        <!-- Mode Toggle -->
                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="advancedModeToggle">
                                <label class="form-check-label" for="advancedModeToggle" id="modeToggleLabel">Basic Mode</label>
                            </div>
                        </div>

                        <!-- Basic Mode Form -->
                        <div id="basicModeForm">
                            <div class="mb-3">
                                <label for="startHour" class="form-label">Starting Hour</label>
                                <input type="number" class="form-control" id="startHour" min="0" step="0.25" value="0">
                            </div>
                            <div class="mb-3">
                                <label for="startAmount" class="form-label">Starting Amount ($)</label>
                                <input type="number" class="form-control" id="startAmount" min="0" step="0.01" value="0">
                            </div>
                            <div class="mb-3">
                                <label for="incrementInterval" class="form-label">Increment Interval</label>
                                <select class="form-select" id="incrementInterval">
                                    <option value="0.25">Every 15 minutes (0.25 hours)</option>
                                    <option value="0.5">Every 30 minutes (0.5 hours)</option>
                                    <option value="0.75">Every 45 minutes (0.75 hours)</option>
                                    <option value="1">Every hour (1.0 hours)</option>
                                    <option value="1.5">Every 1.5 hours</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="incrementAmount" class="form-label">Amount to Increase Each Interval ($)</label>
                                <input type="number" class="form-control" id="incrementAmount" min="0" step="0.01" value="0">
                            </div>
                            <div class="mb-3">
                                <label for="maxHours" class="form-label">Generate Up To (Hours)</label>
                                <input type="number" class="form-control" id="maxHours" min="0" step="0.25" value="10">
                            </div>
                            <button type="button" class="btn btn-secondary mb-3" id="generateRates">Generate Rate Pairs</button>
                        </div>

                        <!-- Advanced Mode Form -->
                        <div id="advancedModeForm" style="display: none;">
                            <div id="hourRatePairs">
                                <div class="hour-rate-pair mb-3">
                                    <div class="row">
                                        <div class="col">
                                            <label class="form-label">Hours</label>
                                            <input type="number" class="form-control hours-input" min="0" step="0.25">
                                        </div>
                                        <div class="col">
                                            <label class="form-label">Rate ($)</label>
                                            <input type="number" class="form-control rate-input" min="0" step="0.01">
                                        </div>
                                        <div class="col-auto d-flex align-items-end">
                                            <button type="button" class="btn btn-danger remove-pair" style="display: none;">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <button type="button" class="btn btn-secondary mb-3" id="addHourRatePair">
                                <i class="fas fa-plus me-2"></i>Add Hour/Rate Pair
                            </button>
                        </div>

                        <!-- Family Discount Section -->
                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="familyDiscountToggle">
                                <label class="form-check-label" for="familyDiscountToggle">Enable Family Discount</label>
                            </div>
                        </div>

                        <div id="familyDiscountSection" style="display: none;">
                            <div class="mb-3">
                                <label for="tuitionDiscountType" class="form-label">Discount Type</label>
                                <select class="form-select" id="tuitionDiscountType">
                                    <option value="percentage">Percentage</option>
                                    <option value="fixed">Fixed Amount</option>
                                </select>
                            </div>

                            <div class="mb-3">
                                <label for="tuitionDiscountAmount" class="form-label">Amount</label>
                                <input type="number" class="form-control" id="tuitionDiscountAmount" step="0.01" min="0">
                                <small class="form-text text-muted">
                                    For percentage, enter a value between 1-100. For fixed amount, enter the dollar value.
                                </small>
                            </div>

                            <div class="mb-3">
                                <label for="studentThreshold" class="form-label">Apply Discount After How Many Students?</label>
                                <input type="number" class="form-control" id="studentThreshold" min="1" step="1" value="1" placeholder="e.g., 2">
                                <small class="text-muted">Discount will apply to additional students after this number</small>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveTuitionRatePlan">Save Rate Plan</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize Bootstrap components
            const tooltips = document.querySelectorAll('[data-bs-toggle="tooltip"]');
            tooltips.forEach(tooltip => {
                new bootstrap.Tooltip(tooltip);
            });
            
            // Add logging for tuition rate plan save
            document.getElementById('saveTuitionRatePlan').removeEventListener('click', saveTuitionRatePlan); // Remove any existing handlers
            
            function saveTuitionRatePlan() {
                // Get form values
                const ratePlanName = document.getElementById('ratePlanName').value.trim();
                
                // Basic validation
                if (!ratePlanName) {
                    alert('Please enter a rate plan name');
                    return;
                }
                
                // Get hour/rate pairs
                const hourRatePairs = document.querySelectorAll('.hour-rate-pair');
                const hourRates = [];
                
                hourRatePairs.forEach(pair => {
                    const hours = parseFloat(pair.querySelector('.hours-input').value);
                    const rate = parseFloat(pair.querySelector('.rate-input').value);
                    
                    if (!isNaN(hours) && !isNaN(rate)) {
                        hourRates.push({ Hours: hours, Rate: rate });
                    }
                });
                
                if (hourRates.length === 0) {
                    alert('Please add at least one valid hours/rate pair');
                    return;
                }
                
                // Get family discount data if enabled
                const familyDiscountToggle = document.getElementById('familyDiscountToggle');
                let familyDiscount = null;
                
                if (familyDiscountToggle.checked) {
                    const discountType = document.getElementById('tuitionDiscountType').value;
                    const discountAmount = parseFloat(document.getElementById('tuitionDiscountAmount').value);
                    const studentThreshold = parseInt(document.getElementById('studentThreshold').value);
                    
                    // Simple validation - just check that we have a value
                    if (isNaN(discountAmount)) {
                        alert('Please enter a valid discount amount');
                        return;
                    }
                    
                    familyDiscount = {
                        Type: discountType,
                        Amount: discountAmount,
                        StudentThreshold: studentThreshold || 1
                    };
                }
                
                // Create the rate plan object
                const ratePlanData = {
                    Name: ratePlanName,
                    HourRates: hourRates,
                    FamilyDiscount: familyDiscount,
                    IsActive: true,
                    UpdatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                // Log what will be saved
                console.log('Tuition Rate Plan Data to be saved:', ratePlanData);
                
                // Save to Firebase
                const saveButton = document.getElementById('saveTuitionRatePlan');
                const isEditMode = saveButton.dataset.mode === 'edit';
                const rateId = saveButton.dataset.rateId;
                const studioId = localStorage.getItem('currentStudioId');
                
                if (!studioId) {
                    alert('Error: Studio ID not found');
                    return;
                }
                
                // Reference to the rate plans collection
                const ratePlansRef = firebase.firestore().collection('Studios').doc(studioId).collection('RatePlans');
                
                // Disable the save button to prevent double clicks
                saveButton.disabled = true;
                
                let savePromise;
                
                if (isEditMode && rateId) {
                    // Update existing rate plan
                    savePromise = ratePlansRef.doc(rateId).update(ratePlanData);
                } else {
                    // Create new rate plan
                    ratePlanData.CreatedAt = firebase.firestore.FieldValue.serverTimestamp();
                    savePromise = ratePlansRef.add(ratePlanData);
                }
                
                savePromise
                    .then(() => {
                        console.log(isEditMode ? 'Rate plan updated' : 'Rate plan created');
                        
                        // Close the modal
                        const modal = bootstrap.Modal.getInstance(document.getElementById('createTuitionRateModal'));
                        if (modal) modal.hide();
                        
                        // Reset form state
                        saveButton.dataset.mode = 'create';
                        saveButton.dataset.rateId = '';
                        saveButton.textContent = 'Save Rate Plan';
                        
                        // Reload tuition rates data
                        loadTuitionRatesData(studioId);
                        
                        // Show success message
                        alert(isEditMode ? 'Rate plan updated successfully!' : 'Rate plan created successfully!');
                    })
                    .catch(error => {
                        console.error('Error saving rate plan:', error);
                        alert('Error saving rate plan. Please try again.');
                    })
                    .finally(() => {
                        // Re-enable the save button
                        saveButton.disabled = false;
                    });
            }
            
            document.getElementById('saveTuitionRatePlan').addEventListener('click', saveTuitionRatePlan);

            // Initialize mode toggle
            const advancedModeToggle = document.getElementById('advancedModeToggle');
            const basicModeForm = document.getElementById('basicModeForm');
            const advancedModeForm = document.getElementById('advancedModeForm');
            const modeToggleLabel = document.getElementById('modeToggleLabel');

            advancedModeToggle.addEventListener('change', function() {
                if (this.checked) {
                    basicModeForm.style.display = 'none';
                    advancedModeForm.style.display = 'block';
                    modeToggleLabel.textContent = 'Advanced Mode';
                } else {
                    basicModeForm.style.display = 'block';
                    advancedModeForm.style.display = 'none';
                    modeToggleLabel.textContent = 'Basic Mode';
                }
            });

            // Handle rate generation in basic mode
            document.getElementById('generateRates').addEventListener('click', function() {
                const startHour = parseFloat(document.getElementById('startHour').value) || 0;
                const startAmount = parseFloat(document.getElementById('startAmount').value) || 0;
                const incrementInterval = parseFloat(document.getElementById('incrementInterval').value) || 0.25;
                const incrementAmount = parseFloat(document.getElementById('incrementAmount').value) || 0;
                const maxHours = parseFloat(document.getElementById('maxHours').value) || 10;

                // Clear existing rate pairs
                const hourRatePairs = document.getElementById('hourRatePairs');
                hourRatePairs.innerHTML = '';

                // Generate rate pairs
                let currentHour = startHour;
                let currentAmount = startAmount;

                while (currentHour <= maxHours) {
                    // Create new rate pair
                    const pairDiv = document.createElement('div');
                    pairDiv.className = 'hour-rate-pair mb-3';
                    pairDiv.innerHTML = `
                        <div class="row">
                            <div class="col">
                                <label class="form-label">Hours</label>
                                <input type="number" class="form-control hours-input" min="0" step="0.25" value="${currentHour.toFixed(2)}">
                            </div>
                            <div class="col">
                                <label class="form-label">Rate ($)</label>
                                <input type="number" class="form-control rate-input" min="0" step="0.01" value="${currentAmount.toFixed(2)}">
                            </div>
                            <div class="col-auto d-flex align-items-end">
                                <button type="button" class="btn btn-danger remove-pair">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    `;

                    // Add remove button functionality
                    const removeBtn = pairDiv.querySelector('.remove-pair');
                    removeBtn.addEventListener('click', function() {
                        this.closest('.hour-rate-pair').remove();
                    });

                    hourRatePairs.appendChild(pairDiv);

                    // Increment for next iteration
                    currentHour += incrementInterval;
                    currentAmount += incrementAmount;
                }

                // Show the generated rates in advanced mode
                advancedModeToggle.checked = true;
                basicModeForm.style.display = 'none';
                advancedModeForm.style.display = 'block';
                modeToggleLabel.textContent = 'Advanced Mode';
            });

            // Initialize tab events
            const tabEl = document.querySelector('a[data-bs-toggle="tab"]');
            if (tabEl) {
                tabEl.addEventListener('shown.bs.tab', function (event) {
                    const tabId = event.target.getAttribute('href') || event.target.getAttribute('data-bs-target');
                    const tabName = tabId?.substring(1); // Remove the '#'
                    
                    if (!tabName) return;
                    
                    // Store the active tab in session storage
                    sessionStorage.setItem('activeChargesTab', tabName);
                    
                    // Load tab-specific data
                    const studioId = localStorage.getItem('currentStudioId');
                    if (!studioId) return;
                    
                    switch (tabName) {
                        case 'charges':
                            loadChargesPaymentsFromSubcollection(studioId);
                            break;
                        case 'tuition-rates':
                            loadTuitionRatesData(studioId);
                            break;
                        case 'fees':
                            loadFeesData(studioId);
                            break;
                        case 'discounts':
                            loadDiscountsData(studioId);
                            break;
                        case 'credits':
                            loadCreditsData(studioId);
                            break;
                    }
                });
            }

            // Make sure all modals are properly initialized
            document.addEventListener('click', function(event) {
                // Check if the clicked element has a data-bs-toggle="modal" attribute
                if (event.target.getAttribute('data-bs-toggle') === 'modal') {
                    const targetModalId = event.target.getAttribute('data-bs-target');
                    if (targetModalId) {
                        const modalElement = document.querySelector(targetModalId);
                        if (modalElement) {
                            // Try to get existing modal instance
                            let modalInstance = bootstrap.Modal.getInstance(modalElement);
                            if (!modalInstance) {
                                // If no instance exists, create a new one
                                try {
                                    modalInstance = new bootstrap.Modal(modalElement);
                                } catch (error) {
                                    console.error('Error creating modal:', error);
                                }
                            }
                            // Show the modal
                            if (modalInstance) {
                                modalInstance.show();
                            }
                        }
                    }
                }
            }, true);

            // Other initialization code...
        });
    </script>

    <!-- Function to filter dropdown options based on search input -->
    <script>
        function filterAssociationItems(query, dropdownId) {
            query = query.toLowerCase().trim();
            
            // Get the dropdown element
            const dropdown = document.getElementById(dropdownId);
            if (!dropdown) {
                console.error(`Dropdown with ID '${dropdownId}' not found`);
                return;
            }
            
            // Find the no results message element (it should be right after the dropdown)
            const dropdownParent = dropdown.parentElement;
            const noResultsMessage = dropdownParent.querySelector('.no-results-message');
            
            let matchCount = 0;
            let totalCount = 0;
            
            // Filter the options
            Array.from(dropdown.options).forEach(option => {
                // Skip the first placeholder option
                if (option.disabled && option.selected) return;
                
                totalCount++;
                const text = option.textContent.toLowerCase();
                const isMatch = query === '' || text.includes(query);
                
                // Use a data attribute to mark filtered options
                option.setAttribute('data-filtered', isMatch ? 'false' : 'true');
                
                if (isMatch) matchCount++;
            });
            
            // Show/hide no results message
            if (noResultsMessage) {
                noResultsMessage.style.display = (query !== '' && matchCount === 0) ? 'block' : 'none';
            }
            
            // Update any result count display that might exist
            const countDisplay = dropdownParent.querySelector('.search-result-count');
            if (countDisplay) {
                if (query && totalCount > 0) {
                    countDisplay.textContent = `Showing ${matchCount} of ${totalCount} items`;
                } else {
                    countDisplay.textContent = '';
                }
            }
            
            console.log(`Search for "${query}" in ${dropdownId}: ${matchCount} of ${totalCount} items match`);
        }

        // Add this to handle search inputs globally
        document.addEventListener('DOMContentLoaded', function() {
            // Set up handlers for all association search inputs
            document.querySelectorAll('.association-search-input').forEach(input => {
                // Get the target dropdown ID from the data attribute
                const targetDropdownId = input.dataset.targetDropdown;
                if (!targetDropdownId) {
                    console.error('Search input missing data-target-dropdown attribute:', input);
                    return;
                }
                
                // Add search handler
                input.addEventListener('input', function() {
                    filterAssociationItems(this.value, targetDropdownId);
                });
                
                // Find and setup the associated clear button
                const clearButton = input.parentElement.querySelector('.clear-search-btn');
                if (clearButton) {
                    clearButton.addEventListener('click', function() {
                        input.value = '';
                        filterAssociationItems('', targetDropdownId);
                        input.focus();
                    });
                }
            });
        });
    </script>

    <!-- Add this function to properly reset the fee form -->
    <script>
        function resetFeeForm() {
            console.log('Resetting fee form to clean state');
            
            // Get the form element
            const feeForm = document.getElementById('newFeeForm');
            if (!feeForm) {
                console.log('Form not found');
                return;
            }
            
            // Reset the actual form inputs
            feeForm.reset();
            
            // Reset data attributes
            feeForm.dataset.mode = 'create';
            feeForm.dataset.feeId = '';
            
            // Safely update modal elements
            const modalLabel = document.getElementById('newFeeModalLabel');
            const saveBtn = document.getElementById('saveFeeBtn');
            if (modalLabel) modalLabel.textContent = 'Create New Fee';
            if (saveBtn) saveBtn.textContent = 'Save Fee';
            
            // Safely hide all conditional sections
            ['associationItemContainer', 'recurringOptions', 'installmentsOptions', 'endDateSection'].forEach(id => {
                const element = document.getElementById(id);
                if (element) element.style.display = 'none';
            });
            
            // Safely reset end date fields
            const hasEndDateCheckbox = document.getElementById('hasEndDate');
            const feeEndDateInput = document.getElementById('feeEndDate');
            if (hasEndDateCheckbox) hasEndDateCheckbox.checked = false;
            if (feeEndDateInput) feeEndDateInput.value = '';
            
            // Safely reset association search
            const searchInput = document.getElementById('associationSearchInput');
            const noItemsFound = document.getElementById('noAssociationItemsFound');
            if (searchInput) searchInput.value = '';
            if (noItemsFound) noItemsFound.style.display = 'none';
            
            // Enable all form fields
            const formFields = feeForm.querySelectorAll('input, select');
            formFields.forEach(field => {
                field.disabled = false;
            });
        }

        // Add event listener to the "Create New Fee" button to reset the form
        document.addEventListener('DOMContentLoaded', function() {
            // Find all buttons that open the fee modal for creation
            const createFeeButtons = document.querySelectorAll('[data-bs-target="#newFeeModal"]:not(.edit-fee-btn)');
            
            createFeeButtons.forEach(button => {
                button.addEventListener('click', function(e) {
                    console.log('Create New Fee button clicked - resetting form');
                    resetFeeForm();
                });
            });
            
            // Also reset the form when the modal is hidden
            const feeModal = document.getElementById('newFeeModal');
            if (feeModal) {
                feeModal.addEventListener('hidden.bs.modal', function() {
                    console.log('Fee modal hidden - resetting form for next use');
                    resetFeeForm();
                });
            }

            // Handle end date checkbox
            const hasEndDateCheckbox = document.getElementById('hasEndDate');
            if (hasEndDateCheckbox) {
                hasEndDateCheckbox.addEventListener('change', function() {
                    const endDateSection = document.getElementById('endDateSection');
                    if (this.checked) {
                        endDateSection.style.display = 'block';
                    } else {
                        endDateSection.style.display = 'none';
                        document.getElementById('feeEndDate').value = ''; // Clear the date when unchecked
                    }
                });
            }

            // Add event listener for the save fee button
            const saveFeeButton = document.getElementById('saveFeeBtn');
            if (saveFeeButton) {
                saveFeeButton.addEventListener('click', function() {
                    console.log('Save Fee button clicked');
                    saveFee();
                });
            }
        });

        // Update the editFee function to properly show the modal and load fee data
        function editFee(feeId) {
            console.log('Edit Fee button clicked for fee ID:', feeId);
            
            if (!currentStudioId) {
                alert('Error: Studio ID not found');
                return;
            }
            
            // Get the form and set it to edit mode
            const feeForm = document.getElementById('newFeeForm');
            feeForm.dataset.mode = 'edit';
            feeForm.dataset.feeId = feeId;
            
            // Update modal title and save button
            document.getElementById('newFeeModalLabel').textContent = 'Edit Fee';
            document.getElementById('saveFeeBtn').textContent = 'Update Fee';
            
            // Show loading state in the form
            const formFields = feeForm.querySelectorAll('input, select');
            formFields.forEach(field => {
                field.disabled = true;
            });
            
            try {
                // First show the modal, then load the data
                const modal = new bootstrap.Modal(document.getElementById('newFeeModal'));
                modal.show();
                
                console.log('Modal opened, now fetching fee data...');
                
                // Fetch the fee data
                firebase.firestore().collection('Studios').doc(currentStudioId).collection('Fees').doc(feeId)
                    .get()
                    .then(doc => {
                        if (!doc.exists) {
                            throw new Error('Fee not found');
                        }
                        
                        const fee = doc.data();
                        console.log('Loaded fee data:', fee);
                        
                        // Fill form with fee data
                        document.getElementById('feeName').value = fee.Name || '';
                        document.getElementById('feeAmount').value = fee.Amount || '';
                        document.getElementById('feeType').value = fee.FeeType || '';
                        
                        // Hide all conditional sections first
                        document.getElementById('recurringOptions').style.display = 'none';
                        document.getElementById('installmentsOptions').style.display = 'none';
                        document.getElementById('endDateSection').style.display = 'none';
                        
                        // Show and fill relevant sections based on fee type
                        if (fee.FeeType === 'Recurring') {
                            const recurringOptions = document.getElementById('recurringOptions');
                            recurringOptions.style.display = 'block';
                            
                            document.getElementById('recurringFrequency').value = fee.Frequency || '';
                            document.getElementById('recurringDuration').value = fee.Duration || 1;
                            
                            // Handle end date fields
                            const hasEndDateCheckbox = document.getElementById('hasEndDate');
                            const endDateSection = document.getElementById('endDateSection');
                            const feeEndDateInput = document.getElementById('feeEndDate');
                            
                            // Set HasEndDate checkbox and show/hide end date section
                            hasEndDateCheckbox.checked = fee.HasEndDate || false;
                            if (fee.HasEndDate && fee.FeeEndDate) {
                                endDateSection.style.display = 'block';
                                feeEndDateInput.value = fee.FeeEndDate;
                            } else {
                                endDateSection.style.display = 'none';
                                feeEndDateInput.value = '';
                            }
                        } else if (fee.FeeType === 'Installments') {
                            const installmentsOptions = document.getElementById('installmentsOptions');
                            installmentsOptions.style.display = 'block';
                            
                            document.getElementById('installmentsCount').value = fee.InstallmentsCount || 2;
                            document.getElementById('installmentsFrequency').value = fee.InstallmentsFrequency || '';
                        }
                        
                        // Enable all form fields
                        const formFields = feeForm.querySelectorAll('input, select');
                        formFields.forEach(field => {
                            field.disabled = false;
                        });
                    })
                    .catch(error => {
                        console.error('Error loading fee:', error);
                        alert('Error loading fee. Please try again.');
                        modal.hide();
                    });
            } catch (error) {
                console.error('Error in editFee:', error);
                alert('Error loading fee. Please try again.');
            }
        }
    </script>

    <!-- Function to create a new charge and update metrics -->
    <script>
        function createCharge(studioId, familyId, chargeData) {
            const db = firebase.firestore();
            
            // First add charge to the family
            return db.collection(`Studios/${studioId}/Families`).doc(familyId).get()
                .then(doc => {
                    if (!doc.exists) {
                        throw new Error("Family not found");
                    }
                    
                    const familyData = doc.data();
                    const charges = familyData.Charges || [];
                    
                    // Add the new charge
                    const newCharge = {
                        ...chargeData,
                        ChargeId: generateUniqueId(), // Generate a unique ID for the charge
                        ChargeDate: new Date().toISOString(),
                        CreatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    
                    charges.push(newCharge);
                    
                    // Update the family document
                    return db.collection(`Studios/${studioId}/Families`).doc(familyId).update({
                        Charges: charges,
                        Balance: (familyData.Balance || 0) + parseFloat(chargeData.Amount || 0)
                    });
                })
                .then(() => {
                    // After updating the family, sync with the centralized collection
                    return syncChargesAndRevenue(studioId);
                })
                .then(() => {
                    console.log("Charge created and revenue metrics updated");
                    return true;
                })
                .catch(error => {
                    console.error("Error creating charge:", error);
                    throw error;
                });
        }

        // Function to generate a unique ID
        function generateUniqueId() {
            return 'charge_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // Function to update a charge's status
        function updateChargeStatus(studioId, familyId, chargeId, newStatus) {
            const db = firebase.firestore();
            
            return db.collection(`Studios/${studioId}/Families`).doc(familyId).get()
                .then(doc => {
                    if (!doc.exists) {
                        throw new Error("Family not found");
                    }
                    
                    const familyData = doc.data();
                    const charges = familyData.Charges || [];
                    
                    // Find the charge
                    const chargeIndex = charges.findIndex(c => c.ChargeId === chargeId);
                    if (chargeIndex === -1) {
                        throw new Error("Charge not found");
                    }
                    
                    // Update the charge status
                    charges[chargeIndex].Status = newStatus;
                    charges[chargeIndex].UpdatedAt = firebase.firestore.FieldValue.serverTimestamp();
                    
                    // Update the family document
                    return db.collection(`Studios/${studioId}/Families`).doc(familyId).update({
                        Charges: charges
                    });
                })
                .then(() => {
                    // After updating the family, sync with the centralized collection
                    return syncChargesAndRevenue(studioId);
                })
                .then(() => {
                    console.log("Charge status updated and revenue metrics updated");
                    return true;
                })
                .catch(error => {
                    console.error("Error updating charge status:", error);
                    throw error;
                });
        }

        // Add this function to enable automatic syncing every 30 seconds
        function setupAutoSync(studioId) {
            if (!studioId) {
                console.error('Cannot setup auto-sync: No studio ID provided');
                return;
            }
            
            // Store the interval ID so we can clear it later if needed
            let syncIntervalId = null;
            
            // Flag to prevent overlapping syncs
            let isSyncing = false;
            
            // Function to perform the actual sync
            const performSync = function() {
                // Prevent multiple syncs from running at the same time
                if (isSyncing) return;
                
                // Check if we're still on the charges-payments page
                if (!document.getElementById('chargesTab')) {
                    console.log('No longer on charges-payments page, stopping auto-sync');
                    clearInterval(syncIntervalId);
                    return;
                }
                
                console.log('Auto-syncing charges and revenue data...');
                isSyncing = true;
                
                // Run the sync operation
                syncChargesAndRevenue(studioId)
                    .then(success => {
                        if (success) {
                            // Update the UI with the latest data
                            const activeTab = document.querySelector('.tab-pane.active');
                            if (activeTab) {
                                const tabId = activeTab.id;
                                
                                if (tabId === 'revenue') {
                                    loadRevenueData(studioId);
                                } else if (tabId === 'charges') {
                                    loadChargesPaymentsFromSubcollection(studioId);
                                }
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Auto-sync error:', error);
                    })
                    .finally(() => {
                        isSyncing = false;
                    });
            };
            
            // Start the sync interval (every 30 seconds)
            syncIntervalId = setInterval(performSync, 30000);
            
            // Also perform an initial sync
            performSync();
            
            console.log('Automatic sync enabled - updating every 30 seconds');
            
            // Return the interval ID in case we need to stop it elsewhere
            return syncIntervalId;
        }

        // Add this event listener to initialize everything when the page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize the sync button click handler
            const syncRevenueBtn = document.getElementById('syncRevenueBtn');
            if (syncRevenueBtn) {
                syncRevenueBtn.addEventListener('click', function() {
                    console.log('Sync button clicked');
                    const studioId = localStorage.getItem('currentStudioId');
                    if (!studioId) {
                        alert('Studio ID not found');
                        return;
                    }
                    
                    this.disabled = true;
                    this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Syncing...';
                    
                    // Show loading spinners in the data display areas
                    showLoadingSpinners();
                    
                    syncChargesAndRevenue(studioId)
                        .then(() => {
                            return loadRevenueData(studioId);
                        })
                        .then(() => {
                            this.disabled = false;
                            this.innerHTML = '<i class="fas fa-sync-alt"></i> Sync Now';
                            console.log('Revenue data synchronized successfully');
                        })
                        .catch(error => {
                            console.error('Error syncing revenue data:', error);
                            this.disabled = false;
                            this.innerHTML = '<i class="fas fa-sync-alt"></i> Sync Now';
                            alert('Error syncing data: ' + error.message);
                            
                            // Hide loading spinners if there was an error
                            hideLoadingSpinners();
                        });
                });
            }
            
            // Start automatic syncing when the page loads
            const studioId = localStorage.getItem('currentStudioId');
            if (studioId) {
                setupAutoSync(studioId);
            }
        });
    </script>

    <!-- Add helper functions for loading spinners and number formatting -->
    <script>
        // Replace the existing spinner functions with shimmer skeleton loaders
        function showLoadingSpinners() {
            // Add shimmer effects to main data display elements
            const mainElements = [
                'revenueThisMonth',
                'revenueLast30Days',
                'outstandingBalances',
                'accountsWithBalance'
            ];
            
            mainElements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    // Save current content
                    element.dataset.originalContent = element.textContent;
                    // Create shimmer effect for a large number (display-4 size)
                    element.innerHTML = '<div class="shimmer-container"><div class="shimmer-text shimmer-large">$0,000.00</div></div>';
                }
            });
            
            // Add shimmer effects to secondary text elements
            const secondaryElements = [
                'revenueMonthChange',
                'revenue30DayChange',
                'outstandingBalanceCount',
                'accountsWithBalancePercent'
            ];
            
            secondaryElements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.dataset.originalContent = element.innerHTML;
                    // Create shimmer effect for smaller text
                    element.innerHTML = '<div class="shimmer-container"><div class="shimmer-text shimmer-small">Loading data...</div></div>';
                }
            });
        }

        function hideLoadingSpinners() {
            // Remove shimmer effects from all elements
            const allElements = [
                'revenueThisMonth',
                'revenueMonthChange',
                'revenueLast30Days',
                'revenue30DayChange',
                'outstandingBalances',
                'outstandingBalanceCount',
                'accountsWithBalance',
                'accountsWithBalancePercent'
            ];
            
            allElements.forEach(id => {
                const element = document.getElementById(id);
                if (element && element.querySelector('.shimmer-container')) {
                    // Restore original content
                    if (element.dataset.originalContent) {
                        element.innerHTML = element.dataset.originalContent;
                        delete element.dataset.originalContent;
                    }
                }
            });
        }

        // Format currency with proper thousand separators
        function formatCurrency(amount) {
            return '$' + formatNumber(amount.toFixed(2));
        }

        // Format numbers with thousand separators
        function formatNumber(number) {
            return parseFloat(number).toLocaleString('en-US');
        }
    </script>

    <!-- Add a function to trigger manual sync of family balances -->
    <script>
        function triggerFullFamilyBalancesSync() {
            const studioId = localStorage.getItem('currentStudioId');
            if (!studioId) {
                console.error('Cannot sync: No studio ID found');
                return Promise.reject(new Error('No studio ID found'));
            }
            
            console.log('Manually triggering full family balances sync...');
            
            // Show loading indicator if needed
            const syncButton = document.getElementById('syncRevenueBtn');
            if (syncButton) {
                syncButton.disabled = true;
                syncButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Syncing...';
            }
            
            return syncFamilyBalances(studioId)
                .then(() => {
                    console.log('Manual family balances sync completed successfully');
                    // Refresh the UI
                    return loadRevenueData(studioId);
                })
                .catch(error => {
                    console.error('Manual family balances sync failed:', error);
                    alert('Error syncing family balances: ' + error.message);
                    return false;
                })
                .finally(() => {
                    // Reset button state
                    if (syncButton) {
                        syncButton.disabled = false;
                        syncButton.innerHTML = '<i class="fas fa-sync-alt"></i> Sync Now';
                    }
                });
        }

        // Add button click handler to the page load event
        document.addEventListener('DOMContentLoaded', function() {
            // Get the sync button
            const syncButton = document.getElementById('syncRevenueBtn');
            if (syncButton) {
                // Replace existing click handlers
                syncButton.replaceWith(syncButton.cloneNode(true));
                
                // Add our new handler
                document.getElementById('syncRevenueBtn').addEventListener('click', function() {
                    triggerFullFamilyBalancesSync();
                });
            }
            
            // Also add a forced family balances sync on page load
            const studioId = localStorage.getItem('currentStudioId');
            if (studioId) {
                // Check if FamilyBalances document exists and has data
                firebase.firestore().collection(`Studios/${studioId}/Charges-Payments`).doc('FamilyBalances').get()
                    .then(doc => {
                        if (!doc.exists || !doc.data().Families || doc.data().Families.length === 0) {
                            console.log('FamilyBalances document is empty on page load - running full sync');
                            return syncFamilyBalances(studioId);
                        }
                    })
                    .catch(error => {
                        console.error('Error checking FamilyBalances on page load:', error);
                    });
            }
        });
    </script>

    <!-- Add direct function to initialize charges and family balances on page load -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Initializing charges and payments page');
            const studioId = localStorage.getItem('currentStudioId');
            
            if (!studioId) {
                console.error('No studio ID found - cannot initialize data');
                return;
            }
            
            // Force a complete sync of family balances when the page loads
            console.log('Forcing complete data initialization and family balance sync');
            
            // First check if FamilyBalances exists and has data
            firebase.firestore()
                .collection(`Studios/${studioId}/Charges-Payments`)
                .doc('FamilyBalances')
                .get()
                .then(doc => {
                    console.log('Checking FamilyBalances document state...');
                    
                    // Always run full sync if document doesn't exist or has no families
                    if (!doc.exists || !doc.data() || !doc.data().Families || doc.data().Families.length === 0) {
                        console.log('FamilyBalances document is empty or missing - running full sync');
                        return forceSyncAllData(studioId);
                    } else {
                        console.log(`FamilyBalances exists with ${doc.data().Families.length} families`);
                        // Check if the data is stale (more than 1 hour old)
                        const lastUpdated = doc.data().LastUpdated?.toDate();
                        const now = new Date();
                        if (!lastUpdated || (now - lastUpdated) > 3600000) {
                            console.log('FamilyBalances data is stale, forcing refresh');
                            return forceSyncAllData(studioId);
                        }
                        return loadRevenueData(studioId);
                    }
                })
                .catch(error => {
                    console.error('Error checking FamilyBalances on page load:', error);
                    // Try to sync anyway in case of error
                    return forceSyncAllData(studioId);
                });
            
            // Setup auto-sync for future changes
            setupAutoSync(studioId);
        });

        // New function to force a complete data sync
        function forceSyncAllData(studioId) {
            console.log('FORCING COMPLETE DATA SYNC');
            
            // Show loading state in UI
            showLoadingSpinners();
            const syncButton = document.getElementById('syncRevenueBtn');
            if (syncButton) {
                syncButton.disabled = true;
                syncButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Syncing...';
            }
            
            // Force create all required documents
            return checkAndInitializeChargesPayments(studioId)
                .then(() => {
                    console.log('Step 1: Getting all families...');
                    // Get all families with detailed logging
                    return firebase.firestore().collection(`Studios/${studioId}/Families`).get()
                        .then(snapshot => {
                            console.log(`Found ${snapshot.size} families in studio`);
                            if (snapshot.empty) {
                                console.log('No families found - creating empty FamilyBalances');
                            }
                            return snapshot;
                        })
                        .catch(error => {
                            console.error('Error fetching families:', error);
                            throw new Error('Failed to fetch families: ' + error.message);
                        });
                })
                .then(familySnapshot => {
                    console.log('Step 2: Processing family balances...');
                    // Process and update FamilyBalances document
                    const familyBalancesRef = firebase.firestore()
                        .collection(`Studios/${studioId}/Charges-Payments`)
                        .doc('FamilyBalances');
                    
                    const families = [];
                    
                    // Update: Use client-side timestamp
                    const now = new Date().toISOString();
                    
                    // Process each family document to extract balance information
                    if (familySnapshot && !familySnapshot.empty) {
                        familySnapshot.forEach(doc => {
                            const familyData = doc.data();
                            const familyId = doc.id;
                            
                            // Use available family name fields
                            const familyName = `${familyData.FirstName || ''} ${familyData.LastName || ''}`.trim() || 'Unnamed Family';
                            
                            // Ensure balance is a valid number
                            let balance = 0;
                            if (familyData.hasOwnProperty('Balance')) {
                                balance = parseFloat(familyData.Balance || 0);
                                if (isNaN(balance)) balance = 0;
                            }
                            
                            // Add to our local array with client-side timestamp
                            families.push({
                                FamilyId: familyId,
                                FamilyName: familyName,
                                Balance: balance,
                                LastUpdated: now // Use string timestamp instead of serverTimestamp
                            });
                            
                            console.log(`Processed family: ${familyName} (${familyId}), balance: $${balance.toFixed(2)}`);
                        });
                    }
                    
                    console.log(`Updating FamilyBalances with ${families.length} family records`);
                    
                    // Set (not update) the FamilyBalances document with all families
                    return familyBalancesRef.set({
                        Families: families,
                        LastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                    });
                })
                .then(() => {
                    console.log('Step 3: Updating revenue metrics...');
                    return updateRevenueDocuments(studioId);
                })
                .then(() => {
                    console.log('Step 4: Refreshing UI...');
                    // Update the UI
                    return loadRevenueData(studioId);
                })
                .then(() => {
                    console.log('Complete data sync finished successfully');
                    // Reset UI
                    if (syncButton) {
                        syncButton.disabled = false;
                        syncButton.innerHTML = '<i class="fas fa-sync-alt"></i> Sync Now';
                    }
                    return true;
                })
                .catch(error => {
                    console.error('Error in complete data sync:', error);
                    // Reset UI
                    if (syncButton) {
                        syncButton.disabled = false;
                        syncButton.innerHTML = '<i class="fas fa-sync-alt"></i> Sync Now';
                    }
                    hideLoadingSpinners();
                    return false;
                });
        }
    </script>

    <!-- Add this script for the Post Charges and Process Payments buttons -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Get button elements
        const postChargesButton = document.getElementById('postChargesButton');
        const processPaymentsButton = document.getElementById('processPaymentsButton');
        
        if (postChargesButton) {
            postChargesButton.addEventListener('click', function() {
                handlePostCharges();
            });
        }
        
        if (processPaymentsButton) {
            processPaymentsButton.addEventListener('click', function() {
                handleProcessPayments();
            });
        }
    });
    
    // Function to handle Post Charges button click
    function handlePostCharges() {
        // Show confirmation dialog
        if (!confirm('This will calculate and post charges for all families for the current month. Continue?')) {
            return;
        }
        
        const studioId = currentStudioId;
        if (!studioId) {
            showToast('Error', 'Studio ID not found', 'error');
            return;
        }
        
        // Show loading state
        const postChargesButton = document.getElementById('postChargesButton');
        const originalButtonText = postChargesButton.innerHTML;
        postChargesButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processing...';
        postChargesButton.disabled = true;
        
        // Call the HTTP endpoint with CORS support
        const functionUrl = 'https://us-central1-studiosync-af73d.cloudfunctions.net/postChargesHttp';
        
        fetch(functionUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ studioId: studioId })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            console.log('Post charges response:', data);
            showToast('Success', 'Charges have been posted successfully', 'success');
            
            // Refresh the charges table
            loadChargesPaymentsFromSubcollection(studioId);
            
            // Also refresh revenue data
            loadRevenueData(studioId);
        })
        .catch(error => {
            console.error('Error posting charges:', error);
            showToast('Error', 'Failed to post charges: ' + error.message, 'error');
        })
        .finally(() => {
            // Reset button state
            postChargesButton.innerHTML = originalButtonText;
            postChargesButton.disabled = false;
        });
    }
    
    // Function to process auto payments
    async function handleProcessPayments() {
        try {
            // Show confirmation dialog
            if (!confirm('This will process payments for all families with auto-pay enabled. Continue?')) {
                return;
            }
            
            // Get the studio ID from the currentStudioId variable
            const studioId = currentStudioId;
            
            if (!studioId) {
                showToast('Error', 'No studio selected', 'error');
                return;
            }
            
            // Update button state
            const processPaymentsButton = document.getElementById('processPaymentsButton');
            const originalButtonText = processPaymentsButton.innerHTML;
            processPaymentsButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
            processPaymentsButton.disabled = true;
            
            try {
                showToast('Info', 'Processing auto payments...', 'info');
                
                const response = await fetch('https://us-central1-studiosync-af73d.cloudfunctions.net/processAutoPayHttp', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        studioId: studioId,
                        processAll: false
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                
                const result = await response.json();
                
                if (result.success) {
                    showToast('Success', `Auto payments processed successfully. Families: ${result.familiesProcessed}, Payments: ${result.paymentsProcessed}, Total Amount: $${result.amountProcessed.toFixed(2)}`, 'success');
                    // Refresh the charges table
                    loadChargesPaymentsFromSubcollection(studioId);
                    // Also refresh revenue data
                    loadRevenueData(studioId);
                } else {
                    showToast('Error', `Error processing auto payments: ${result.error}`, 'error');
                }
            } catch (error) {
                console.error('Error processing payments:', error);
                showToast('Error', `Failed to process payments: ${error.message}`, 'error');
            } finally {
                // Reset button state
                processPaymentsButton.innerHTML = originalButtonText;
                processPaymentsButton.disabled = false;
            }
        } catch (outerError) {
            console.error('Outer error in process payments:', outerError);
            showToast('Error', `An unexpected error occurred: ${outerError.message}`, 'error');
        }
    }
    // Helper function to show toast notifications
    function showToast(title, message, type = 'info') {
        // Check if we have a toast container, if not create one
        let toastContainer = document.querySelector('.toast-container');
        if (!toastContainer) {
            toastContainer = document.createElement('div');
            toastContainer.className = 'toast-container position-fixed bottom-0 end-0 p-3';
            document.body.appendChild(toastContainer);
        }
        
        // Create a unique ID for this toast
        const toastId = 'toast-' + Date.now();
        
        // Set the appropriate color based on type
        let bgColor = 'bg-info';
        if (type === 'success') bgColor = 'bg-success';
        if (type === 'error') bgColor = 'bg-danger';
        if (type === 'warning') bgColor = 'bg-warning';
        
        // Create the toast HTML
        const toastHtml = `
            <div id="${toastId}" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="toast-header ${bgColor} text-white">
                    <strong class="me-auto">${title}</strong>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
                <div class="toast-body">
                    ${message}
                </div>
            </div>
        `;
        
        // Add the toast to the container
        toastContainer.insertAdjacentHTML('beforeend', toastHtml);
        
        // Initialize and show the toast
        const toastElement = document.getElementById(toastId);
        const toast = new bootstrap.Toast(toastElement, { autohide: true, delay: 5000 });
        toast.show();
        
        // Remove the toast element after it's hidden
        toastElement.addEventListener('hidden.bs.toast', function() {
            toastElement.remove();
        });
    }

    // Fee Preview Functions
function initializeFeePreview() {
    // Set default start dates to today
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('recurringStartDate').value = today;
    document.getElementById('installmentStartDate').value = today;
    
    // Remove any existing event listeners first
    const formInputs = document.querySelectorAll('#newFeeForm input, #newFeeForm select');
    formInputs.forEach(input => {
        input.removeEventListener('input', updateFeePreview);
        input.removeEventListener('change', updateFeePreview);
        // Add new listeners
        input.addEventListener('input', updateFeePreview);
        input.addEventListener('change', updateFeePreview);
    });
    
    // Initial preview update
    updateFeePreview();
}

// Add this to your DOMContentLoaded event listener
document.addEventListener('DOMContentLoaded', function() {
    const newFeeModal = document.getElementById('newFeeModal');
    if (newFeeModal) {
        newFeeModal.addEventListener('shown.bs.modal', initializeFeePreview);
    }
});

function updateFeePreview() {
    const feeName = document.getElementById('feeName').value || 'New Fee';
    const feeType = document.getElementById('feeType').value || '--';
    const feeAmount = parseFloat(document.getElementById('feeAmount').value) || 0;
    
    // Update preview elements with animation
    const previewElements = {
        name: document.querySelector('.preview-fee-name'),
        type: document.querySelector('.preview-fee-type'),
        amount: document.querySelector('.preview-fee-amount')
    };
    
    // Calculate total amount for recurring fees
    const totalAmountText = document.querySelector('.total-amount-text');
    const totalAmountSpan = document.querySelector('.preview-total-amount');
    
    if (feeType === 'Recurring' && totalAmountText && totalAmountSpan) {
        const duration = parseInt(document.getElementById('recurringDuration')?.value) || 1;
        const totalAmount = feeAmount * duration;
        totalAmountText.style.display = 'block';
        totalAmountSpan.textContent = totalAmount.toFixed(2);
    } else if (totalAmountText) {
        totalAmountText.style.display = 'none';
    }
    
    // Apply fade effect
    Object.values(previewElements).forEach(el => {
        if (el) {
            el.style.opacity = '0';
            setTimeout(() => {
                if (el === previewElements.name) el.textContent = feeName;
                if (el === previewElements.type) el.textContent = feeType;
                if (el === previewElements.amount) el.textContent = feeAmount.toFixed(2);
                el.style.opacity = '1';
            }, 150);
        }
    });
    
    // Update payment schedule
    const timeline = document.getElementById('previewTimeline');
    if (timeline) {
        timeline.style.opacity = '0';
        setTimeout(() => {
            updatePaymentSchedule(feeType, feeAmount);
            timeline.style.opacity = '1';
        }, 150);
    }
}

function updatePaymentSchedule(feeType, totalAmount) {
    const timeline = document.getElementById('previewTimeline');
    if (!timeline) return;
    
    // Clear existing content
    timeline.innerHTML = '';
    
    if (!feeType || feeType === '--' || totalAmount <= 0) {
        timeline.innerHTML = '<p class="text-muted">Enter fee details to see payment schedule</p>';
        return;
    }
    
    let schedules = [];
    
    switch(feeType) {
        case 'OneTime':
            schedules = [{
                date: new Date(),
                amount: totalAmount,
                label: 'One-time payment'
            }];
            break;
            
        case 'Recurring':
            const recurringFrequency = document.getElementById('recurringFrequency')?.value || 'monthly';
            const recurringDuration = parseInt(document.getElementById('recurringDuration')?.value) || 1;
            const recurringStartDate = document.getElementById('recurringStartDate')?.value || new Date().toISOString().split('T')[0];
            schedules = generateSchedule(recurringFrequency, totalAmount, recurringDuration, recurringStartDate, 'Payment');
            break;
            
        case 'Installments':
            const numInstallments = parseInt(document.getElementById('numberOfInstallments')?.value) || 2;
            const installmentFreq = document.getElementById('installmentFrequency')?.value || 'monthly';
            const installmentStartDate = document.getElementById('installmentStartDate')?.value || new Date().toISOString().split('T')[0];
            const installmentAmount = totalAmount / numInstallments;
            schedules = generateSchedule(installmentFreq, installmentAmount, numInstallments, installmentStartDate, 'Installment');
            break;
    }
    
    // Create timeline items
    schedules.forEach((schedule, index) => {
        const item = document.createElement('div');
        item.className = 'timeline-item mb-3';
        
        const date = new Date(schedule.date);
        const formattedDate = date.toLocaleDateString('en-US', { 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
        });
        
        const formattedAmount = new Intl.NumberFormat('en-US', {
            style: 'currency',
            currency: 'USD'
        }).format(schedule.amount);
        
        item.innerHTML = `
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <strong>${formattedDate}</strong><br>
                    <span class="text-muted">${schedule.label}</span>
                </div>
                <div class="h5 mb-0">${formattedAmount}</div>
            </div>
        `;
        
        timeline.appendChild(item);
    });
}

function generateSchedule(frequency, amount, duration, startDateStr, labelPrefix) {
    const schedules = [];
    const startDate = new Date(startDateStr + 'T00:00:00'); // Add time to prevent timezone issues
    
    for(let i = 0; i < duration; i++) {
        const date = new Date(startDate);
        date.setHours(0, 0, 0, 0); // Ensure consistent time
        
        switch(frequency) {
            case 'weekly':
                date.setDate(date.getDate() + (7 * i));
                break;
            case 'monthly':
                date.setMonth(date.getMonth() + i);
                break;
            case 'quarterly':
                date.setMonth(date.getMonth() + (3 * i));
                break;
            case 'yearly':
                date.setFullYear(date.getFullYear() + i);
                break;
        }
        
        schedules.push({
            date: date,
            amount: amount,
            label: `${labelPrefix} ${i + 1} of ${duration}`
        });
    }
    
    return schedules;
}

// Association handling functions
async function handleAssociationTypeChange(feeType) {
    const associationType = document.getElementById(`${feeType}AssociationType`).value;
    const container = document.getElementById(`${feeType}AssociationContainer`);
    const select = document.getElementById(`${feeType}Association`);
    const searchInput = document.getElementById(`${feeType}AssociationSearch`);
    
    if (!associationType) {
        container.style.display = 'none';
        return;
    }
    
    container.style.display = 'block';
    select.innerHTML = '<option value="">Loading...</option>';
    
    try {
        const options = await fetchAssociationOptions(associationType);
        populateAssociationSelect(select, options);
        
        // Add search functionality
        searchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const filteredOptions = options.filter(option => 
                option.name.toLowerCase().includes(searchTerm)
            );
            populateAssociationSelect(select, filteredOptions);
        });
    } catch (error) {
        console.error('Error fetching association options:', error);
        select.innerHTML = '<option value="">Error loading options</option>';
    }
}

async function fetchAssociationOptions(type) {
    const db = firebase.firestore();
    const studioId = getCurrentStudioId();
    let query;
    
    switch(type) {
        case 'Season':
            query = await db.collection('Studios').doc(studioId).collection('Seasons').get();
            break;
        case 'Class':
            query = await db.collection('Studios').doc(studioId).collection('Classes').get();
            break;
        case 'Family':
            query = await db.collection('Studios').doc(studioId).collection('Families').get();
            break;
        case 'Student':
            query = await db.collection('Studios').doc(studioId).collection('Students').get();
            break;
        case 'Tags':
            query = await db.collection('Studios').doc(studioId).collection('Tags').get();
            break;
        default:
            return [];
    }
    
    return query.docs.map(doc => {
        const data = doc.data();
        let name;
        
        // Handle different name fields based on type
        switch(type) {
            case 'Student':
                name = `${data.FirstName || ''} ${data.LastName || ''}`.trim();
                break;
            case 'Family':
                name = `${data.FirstName || ''} ${data.LastName || ''}`.trim() || 'Unnamed Family';
                break;
            case 'Class':
                name = data.ClassName || 'Unnamed Class';
                break;
            case 'Tags':
                name = data.Name || 'Unnamed Tag';
                break;
            default:
                name = data.Name || 'Unnamed';
        }
        
        return {
            id: doc.id,
            name: name
        };
    });
}

function populateAssociationSelect(select, options) {
    select.innerHTML = options.map(option => 
        `<option value="${option.id}">${option.name}</option>`
    ).join('');
}

function getCurrentStudioId() {
    return localStorage.getItem('currentStudioId');
}

// Save the new fee
function saveFee() {
    console.log('Save Fee function called');
    
    // Get form values
    const feeName = document.getElementById('feeName').value.trim();
    const feeAmount = parseFloat(document.getElementById('feeAmount').value);
    const feeType = document.getElementById('feeType').value;
    
    // Get the correct association type and ID based on fee type
    let associationType, associationItemId;
    
    // Convert feeType to the correct prefix for IDs
    const typePrefix = feeType.toLowerCase().replace(/\s+/g, '');
    
    // Get the association type and ID using the correct IDs based on fee type
    associationType = document.getElementById(`${typePrefix}AssociationType`).value;
    associationItemId = document.getElementById(`${typePrefix}Association`).value;
    
    console.log('Form values:', { feeName, feeAmount, feeType, associationType, associationItemId });
    
    // Basic validation
    if (!feeName || isNaN(feeAmount) || !feeType || !associationType || !associationItemId) {
        console.log('Validation failed:', { feeName, feeAmount, feeType, associationType, associationItemId });
        alert('Please fill out all required fields');
        return;
    }
    
    // Get the studio ID
    const studioId = currentStudioId;
    
    if (!studioId) {
        console.log('No studio ID found');
        alert('Error: Studio ID not found');
        return;
    }
    
    // Create the base fee object
    const feeData = {
        Name: feeName,
        Amount: feeAmount,
        FeeType: feeType,
        AssociationType: associationType,
        AssociationItemId: associationItemId,
        UpdatedAt: firebase.firestore.FieldValue.serverTimestamp()
    };
    
    console.log('Fee data to save:', feeData);
    
    // Reference to the Fees subcollection
    const feesCollectionRef = firebase.firestore().collection('Studios').doc(studioId).collection('Fees');
    
    // Save to Firestore
    feesCollectionRef.add(feeData)
        .then(docRef => {
            console.log('Fee saved successfully with ID:', docRef.id);
            
            // Close the modal and reset form safely
            const modal = bootstrap.Modal.getInstance(document.getElementById('newFeeModal'));
            if (modal) {
                modal.hide();
                // Wait for modal to finish hiding before resetting form
                setTimeout(() => {
                    const form = document.getElementById('newFeeForm');
                    if (form) form.reset();
                    
                    // Safely hide containers
                    ['associationItemContainer', 'recurringOptions', 'installmentsOptions'].forEach(id => {
                        const container = document.getElementById(id);
                        if (container) container.style.display = 'none';
                    });
                    
                    // Reload fees data
                    loadFeesData(studioId);
                }, 300);
            }
            
            // Show success message
            alert('Fee created successfully!');
        })
        .catch(error => {
            console.error('Error saving fee:', error);
            alert('Error creating fee. Please try again.');
        });
}
</script>

    
</script>


</body>
</html>